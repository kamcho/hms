{% extends 'users/dashboard_base.html' %}
{% load static custom_filters %}
{% block title %}Invoice Details - {{ invoice.id }}{% endblock %}
{% block extra_css %}
    <style>
    :root {
        --dash-bg: #f4f6f9;
        --card-bg: #ffffff;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --accent-primary: #7e3af2;
        --accent-success: #10b981;
        --accent-danger: #ef4444;
        --border-color: #e5e7eb;
    }

    /* Modal Styles */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: white;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .modal-header {
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .custom-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
    }

    .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .invoice-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .badge {
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-pending {
        background: #fffbeb;
        color: #f59e0b;
    }

    .badge-paid {
        background: #ecfdf5;
        color: #10b981;
    }

    .badge-partial {
        background: #f5f3ff;
        color: #7e3af2;
    }

    .invoice-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 2rem;
    }

    .invoice-table th {
        text-align: left;
        padding: 1rem;
        background: #f9fafb;
        color: var(--text-secondary);
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
    }

    .invoice-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .total-section {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        width: 300px;
        font-size: 1rem;
    }

    .total-row.grand-total {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--accent-primary);
        border-top: 2px solid var(--border-color);
        padding-top: 0.5rem;
        margin-top: 0.5rem;
    }

    .payment-form {
        max-width: 500px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
    }

    .custom-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-primary {
        background: var(--accent-primary);
        color: white;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }
    </style>
{% endblock %}
{% block content %}
    <div class="container-fluid py-4">
        <div class="custom-card">
            <div class="invoice-header">
                <div>
                    <h1 class="invoice-title">INVOICE #{{ invoice.id }}</h1>
                    <p class="text-secondary">Date: {{ invoice.created_at|date:"M d, Y" }}</p>
                    <div style="margin-top: 1rem;">
                        <strong>Patient:</strong> {{ invoice.patient.full_name }}
                        <br>
                        <strong>ID:</strong> {{ invoice.patient.id }}
                    </div>
                </div>
                <div class="text-end" style="display: flex; flex-direction: column; align-items: flex-end; gap: 1rem;">
                    <span class="badge badge-{{ invoice.status|lower }}">{{ invoice.get_status_display }}</span>
                    {% if user.role == 'Receptionist' and invoice.status != 'Paid' %}
                        <button class="custom-btn btn-primary" onclick="showModal('recordPaymentModal')" style="background: var(--accent-success);">
                            <i class="fas fa-money-bill-wave" style="margin-right: 0.5rem;"></i>
                            Record Payment
                        </button>
                    {% endif %}
                    <!-- {% if can_authorize %}
                <form action="{% url 'accounts:authorize_discharge' invoice.id %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="custom-btn btn-primary" style="background: var(--accent-success);">
                        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                        Authorize {{ admission_type }} Release
                    </button>
                </form>
{% endif %} -->
                    {% if invoice.created_by == request.user and not invoice.payments.exists %}
                        <button class="custom-btn btn-outline text-danger" onclick="showModal('deleteInvoiceModal')">
                            <i class="fas fa-trash-alt" style="margin-right: 0.5rem;"></i>Delete Invoice
                        </button>
                    {% endif %}
                </div>
            </div>
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.items.all %}
                        <tr>
                            <td>
                                {{ item.name }}
                                {% if item.is_dispensed %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800 ml-2">
                                        Dispensed
                                    </span>
                                {% endif %}

                                {% if item.paid_amount == 0 %}
                                    {% if request.user.is_superuser or request.user.role == 'Admin' %}
                                        {# Admins can delete anything unpaid #}
                                        <button onclick="deleteInvoiceItem({{ item.id }})" class="ml-2 text-rose-500 hover:text-rose-700 transition-colors" title="Delete Item">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    {% elif not item.is_dispensed %}
                                        {# Non-admins can only delete non-dispensed unpaid items #}
                                        {% if invoice.created_by == request.user or item.created_by == request.user %}
                                            <button onclick="deleteInvoiceItem({{ item.id }})" class="ml-2 text-rose-500 hover:text-rose-700 transition-colors" title="Delete Item">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>{{ item.quantity }}</td>
                            <td>Ksh {{ item.unit_price|format_number:2 }}</td>
                            <td class="text-end">Ksh {{ item.amount|format_number:2 }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="total-section">
                <div class="total-row">
                    <span>Subtotal (Total Billed)</span>
                    <span>Ksh {{ invoice.total_amount|format_number:2 }}</span>
                </div>
                {% if invoice.insurance_adjustment != 0 %}
                    {% if invoice.insurance_adjustment > 0 %}
                        <div class="total-row text-rose-600 font-bold">
                            <span>Facility Adjustment (Loss)</span>
                            <span>- Ksh {{ invoice.insurance_adjustment|format_number:2 }}</span>
                        </div>
                    {% else %}
                        <div class="total-row text-emerald-600 font-bold">
                            <span>Insurance Gain</span>
                            <span>+ Ksh {{ invoice.insurance_adjustment|abs|format_number:2 }}</span>
                        </div>
                    {% endif %}
                    <div class="total-row font-black border-t border-slate-100 pt-1 mt-1">
                        <span>Effective Amount</span>
                        <span>Ksh {{ invoice.effective_amount|format_number:2 }}</span>
                    </div>
                {% endif %}
                <div class="total-row">
                    <span>Paid</span>
                    <span class="text-success">Ksh {{ invoice.paid_amount|format_number:2 }}</span>
                </div>
                <div class="total-row grand-total">
                    <span>Balance Due</span>
                    <span>Ksh {{ invoice.balance|format_number:2 }}</span>
                </div>
            </div>
        </div>
        <!-- Payments Section -->
        <div class="custom-card">
            <h3 class="invoice-title" style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                <i class="fas fa-history" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                Payment History
            </h3>
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reference</th>
                        <th>Method</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in invoice.payments.all %}
                        <tr>
                            <td>{{ payment.payment_date|date:"M d, Y H:i" }}</td>
                            <td>
                                <code>{{ payment.transaction_reference|default:"N/A" }}</code>
                            </td>
                            <td>{{ payment.payment_method }}</td>
                            <td class="text-end font-bold text-success">Ksh {{ payment.amount|format_number:2 }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-secondary py-8">No payments recorded yet</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- Message Modal -->
    <div id="messageModal" class="custom-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="messageModalTitle">Message</h3>
                <button class="custom-btn btn-sm btn-secondary" onclick="closeModal('messageModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="messageModalContent" style="margin: 0; font-size: 1rem;"></p>
            </div>
            <div class="modal-footer">
                <button class="custom-btn btn-primary" id="messageModalBtn" onclick="closeModal('messageModal')">OK</button>
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div id="deleteInvoiceModal" class="custom-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Confirm Deletion</h3>
                <button class="custom-btn btn-sm btn-secondary" onclick="closeModal('deleteInvoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin: 0; color: var(--text-primary);">
                    Are you sure you want to delete this invoice? This action
                    cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button class="custom-btn btn-secondary" onclick="closeModal('deleteInvoiceModal')">Cancel</button>
                <button class="custom-btn btn-primary" style="background-color: var(--accent-danger);" onclick="deleteInvoice()">Yes, Delete</button>
            </div>
        </div>
    </div>
    <!-- Record Payment Modal -->
    <div id="recordPaymentModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-cash-register mr-2"></i> Record New Payment
                </h3>
                <button class="btn-close" onclick="closeModal('recordPaymentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="paymentForm">
                {% csrf_token %}
                <div class="modal-body space-y-4">
                    <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold text-indigo-600 uppercase">Balance Outstanding</span>
                            <span class="text-xl font-black text-indigo-900">Ksh {{
                            invoice.balance|format_number:2 }}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Amount (KSH)</label>
                        <input type="number" name="amount" class="form-control" step="0.01" value="{{ invoice.balance }}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-control" required>
                            <option value="Cash">Cash</option>
                            <option value="M-Pesa">M-Pesa</option>
                            <option value="Bank">Bank Transfer</option>
                            <option value="Insurance">Insurance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transaction Reference #</label>
                        <input type="text" name="reference" class="form-control" placeholder="M-Pesa Code / Bank Ref" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="custom-btn btn-secondary" onclick="closeModal('recordPaymentModal')">Cancel</button>
                    <button type="button" class="custom-btn btn-primary" onclick="submitPayment()">
                        Complete Payment <i class="fas fa-check ml-1"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
    function showModal(modalId) {
        document.getElementById(modalId).style.display = "flex";
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }

    function showMessageModal(title, message, callback) {
        document.getElementById('messageModalTitle').textContent = title;
        document.getElementById('messageModalContent').textContent = message;

        const btn = document.getElementById('messageModalBtn');
        const closeBtn = document.querySelector('#messageModal .btn-sm');

        const handleClose = function () {
            closeModal('messageModal');
            if (typeof callback === 'function') callback();
        };

        btn.onclick = handleClose;
        if (closeBtn) closeBtn.onclick = handleClose;

        showModal('messageModal');
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        if (event.target.classList.contains('custom-modal')) {
            event.target.style.display = "none";
        }
    }

    function submitPayment() {
        const form = document.getElementById('paymentForm');
        if (!form) return;

        const formData = new FormData(form);
        const submitBtn = document.querySelector('#recordPaymentModal .btn-primary');

        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        }

        fetch('{% url "accounts:record_payment" invoice.id %}', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('recordPaymentModal');
                    window.location.reload();
                } else {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Complete Payment <i class="fas fa-check ml-1"></i>';
                    }
                    showMessageModal('Error', data.error || 'Failed to record payment');
                }
            })
            .catch(err => {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Complete Payment <i class="fas fa-check ml-1"></i>';
                }
                console.error('Payment Error:', err);
                showMessageModal('Error', 'Connection error: ' + err);
            });
    }

    function deleteInvoice() {
        closeModal('deleteInvoiceModal');
        fetch('{% url "accounts:delete_invoice" invoice.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessageModal('Success', 'Invoice deleted successfully', () => {
                        window.location.href = `/home/patients/${data.patient_id}/`;
                    });
                } else {
                    showMessageModal('Error', data.error || 'Failed to delete invoice');
                }
            })
            .catch(err => showMessageModal('Error', 'Connection error: ' + err));
    }

    function deleteInvoiceItem(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) return;

        const deleteUrl = `{% url 'accounts:delete_invoice_item' 0 %}`.replace('0', itemId);

        fetch(deleteUrl, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // simple reload to update totals
                    window.location.reload();
                } else {
                    showMessageModal('Error', data.error || 'Failed to delete item');
                }
            })
            .catch(err => showMessageModal('Error', 'Connection error: ' + err));
    }
    </script>
{% endblock %}
