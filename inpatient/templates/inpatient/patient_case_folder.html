{% extends 'users/dashboard_base.html' %}
{% load static %}
{% block title %}{{ admission.patient.full_name }} - Clinical Case Folder{% endblock %}
{% block content %}
    <div class="px-8 py-6 max-w-[1600px] mx-auto">
        <!-- Breadcrumbs/Back Navigation -->
        <div class="mb-8">
            <a href="{% url 'inpatient:dashboard' %}" class="inline-flex items-center text-[11px] font-black uppercase tracking-widest text-slate-400 hover:text-indigo-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> Back to Inpatient Dashboard
            </a>
        </div>
        <!-- Patient Header Card -->
        <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 p-8 mb-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50/50 rounded-full -mr-32 -mt-32 blur-3xl"></div>
            <div class="relative z-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8">
                <div class="flex items-center gap-6">
                    <div class="relative">
                        <img src="https://ui-avatars.com/api/?name={{ admission.patient.full_name|urlencode }}&background=6366f1&color=fff&size=120" class="w-24 h-24 rounded-3xl shadow-xl ring-4 ring-white object-cover">
                        <div class="absolute -bottom-2 -right-2 w-8 h-8 rounded-xl bg-emerald-500 border-4 border-white flex items-center justify-center text-white text-xs shadow-lg" title="Active Admission">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h1 class="text-3xl font-black text-slate-900 tracking-tight">{{ admission.patient.full_name }}</h1>
                            <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-[10px] font-black rounded-full uppercase tracking-widest border border-indigo-100">ADM-{{
                            admission.id }}</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-y-2 gap-x-6">
                            <div class="flex items-center gap-2 text-slate-500 font-bold text-sm">
                                <i class="fas fa-map-marker-alt text-indigo-500"></i> {{ admission.bed.ward.name }} • Bed {{
                                admission.bed.bed_number }}
                            </div>
                            <div class="flex items-center gap-2 text-slate-500 font-bold text-sm">
                                <i class="fas fa-calendar-alt text-indigo-500"></i> Admitted {{
                                admission.admitted_at|date:"d M Y" }} ({{ admission.admitted_at|timesince }} ago)
                            </div>
                        </div>
                        {% if admission.provisional_diagnosis %}
                            <div class="mt-3 inline-flex items-center gap-2 px-3 py-1.5 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-wider">
                                <i class="fas fa-stethoscope text-indigo-400"></i> DX: {{ admission.provisional_diagnosis }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 w-full lg:w-auto">
                    <!-- <button onclick="window.print()" class="flex-1 lg:flex-none px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest hover:border-indigo-600 hover:text-indigo-600 transition-all shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-print"></i> Case Summary
                </button> -->
                    {% if user.role in 'Doctor,Nurse' %}
                        {% if admission.status != 'Discharged' %}
                            <button data-bs-toggle="modal" data-bs-target="#transferModal" class="flex-1 lg:flex-none px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest hover:border-purple-600 hover:text-purple-600 transition-all shadow-sm flex items-center justify-center gap-2">
                                <i class="fas fa-exchange-alt"></i> Transfer
                            </button>
                        {% endif %}
                        {% if admission.status != 'Discharged' %}
                            <a href="{% url 'home:refer_patient' admission.visit.id %}" class="flex-1 lg:flex-none px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest hover:border-purple-600 hover:text-purple-600 transition-all shadow-sm flex items-center justify-center gap-2">
                                <i class="fas fa-exchange-alt"></i> Refer
                            </a>
                        {% endif %}
                        {% if invoice_is_paid %}
                            {% if admission.status != 'Discharged' %}
                                <button data-bs-toggle="modal" data-bs-target="#dischargeModal" class="flex-1 lg:flex-none px-6 py-3 bg-rose-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-rose-700 shadow-lg shadow-rose-100 transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-sign-out-alt"></i> Discharge
                                </button>
                            {% endif %}
                        {% else %}
                            <button disabled title="Invoice must be paid before discharge" class="flex-1 lg:flex-none px-6 py-3 bg-slate-200 text-slate-400 rounded-xl text-[10px] font-black uppercase tracking-widest cursor-not-allowed flex items-center justify-center gap-2">
                                <i class="fas fa-lock grayscale opacity-50"></i> Discharge Locked
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left Column: Vital Signs & Patient Specs -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Patient Specs -->
                <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 p-8">
                    <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest mb-6 pb-4 border-b border-slate-50">Demographics</h3>
                    <div class="grid grid-cols-2 gap-y-6 gap-x-4">
                        <div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Gender</div>
                            <div class="text-sm font-black text-slate-900 mt-1">{{ admission.patient.get_gender_display }}</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Age</div>
                            <div class="text-sm font-black text-slate-900 mt-1">{{ admission.patient.age }} Years</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Blood Type</div>
                            <div class="text-sm font-black text-slate-900 mt-1">O Positive</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Phone</div>
                            <div class="text-sm font-black text-slate-900 mt-1">{{ admission.patient.phone }}</div>
                        </div>
                    </div>
                </div>
                <!-- Vital Sign Card -->
                <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-8 pb-4 flex justify-between items-center">
                        <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest">Current Vitals</h3>
                        {% if admission.status != 'Discharged' %}
                            <button data-bs-toggle="modal" data-bs-target="#vitalsModal" class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all">
                                <i class="fas fa-plus text-[10px]"></i>
                            </button>
                        {% endif %}
                    </div>
                    <div class="px-8 pb-8 grid grid-cols-2 gap-3">
                        <!-- Heart Rate -->
                        <div class="p-4 bg-rose-50/50 rounded-2xl flex items-center justify-between border border-rose-50">
                            <div class="flex items-center gap-3">
                                <div class="text-rose-500">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <span class="text-[11px] font-black text-slate-600 uppercase tracking-wider">Pulse</span>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-black text-slate-900">{{ latest_vitals.pulse_rate|default:"--"
                                }}</span>
                                <span class="text-[10px] font-bold text-slate-400">bpm</span>
                            </div>
                        </div>
                        <!-- Blood Pressure -->
                        <div class="p-4 bg-blue-50/50 rounded-2xl flex items-center justify-between border border-blue-50">
                            <div class="flex items-center gap-3">
                                <div class="text-blue-500">
                                    <i class="fas fa-tachometer-alt"></i>
                                </div>
                                <span class="text-[11px] font-black text-slate-600 uppercase tracking-wider">BP</span>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-black text-slate-900">{{ latest_vitals.systolic_bp|default:"--"
                                }}/{{ latest_vitals.diastolic_bp|default:"--" }}</span>
                                <span class="text-[10px] font-bold text-slate-400">mmHg</span>
                            </div>
                        </div>
                        <!-- SpO2 -->
                        <div class="p-4 bg-emerald-50/50 rounded-2xl flex items-center justify-between border border-emerald-50">
                            <div class="flex items-center gap-3">
                                <div class="text-emerald-500">
                                    <i class="fas fa-lungs"></i>
                                </div>
                                <span class="text-[11px] font-black text-slate-600 uppercase tracking-wider">SpO2</span>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-black text-slate-900">{{ latest_vitals.spo2|default:"--" }}</span>
                                <span class="text-[10px] font-bold text-slate-400">%</span>
                            </div>
                        </div>
                        <!-- Temperature -->
                        <div class="p-4 bg-amber-50/50 rounded-2xl flex items-center justify-between border border-amber-50">
                            <div class="flex items-center gap-3">
                                <div class="text-amber-500">
                                    <i class="fas fa-thermometer-half"></i>
                                </div>
                                <span class="text-[11px] font-black text-slate-600 uppercase tracking-wider">Temp</span>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-black text-slate-900">{{ latest_vitals.temperature|default:"--"
                                }}</span>
                                <span class="text-[10px] font-bold text-slate-400">°C</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-6 border-t border-slate-100 h-64 relative">
                        <canvas id="vitalsChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Right Column: Clinical Tabs & Workspace -->
            <div class="lg:col-span-3 space-y-8">
                <!-- Navigation Tabs -->
                <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 overflow-hidden min-h-[800px]">
                    <div class="px-8 py-4 bg-slate-50/50 border-b border-slate-100">
                        <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                            <button onclick="showClinicalTab('notes')" id="tab-btn-notes" class="clinical-tab active px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all">
                                <i class="fas fa-notes-medical mr-2"></i> Clinical Notes
                            </button>
                            <button onclick="showClinicalTab('medications')" id="tab-btn-medications" class="clinical-tab px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all">
                                <i class="fas fa-pills mr-2"></i> Medications
                            </button>
                            <button onclick="showClinicalTab('consumables')" id="tab-btn-consumables" class="clinical-tab px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all">
                                <i class="fas fa-box-open mr-2"></i> Consumables
                            </button>
                            <button onclick="showClinicalTab('instructions')" id="tab-btn-instructions" class="clinical-tab px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all">
                                <i class="fas fa-user-md mr-2"></i> Instructions
                            </button>
                            <button onclick="showClinicalTab('investigations')" id="tab-btn-investigations" class="px-5 py-3 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-900 border-b-2 border-transparent transition-all clinical-tab whitespace-nowrap">
                                <i class="fas fa-microscope mr-2"></i> Investigations
                            </button>
                            <button onclick="showClinicalTab('nutrition')" id="tab-btn-nutrition" class="clinical-tab px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all">
                                <i class="fas fa-utensils mr-2"></i> Nutrition
                            </button>
                            <button onclick="showClinicalTab('timeline')" id="tab-btn-timeline" class="clinical-tab px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all">
                                <i class="fas fa-history mr-2"></i> Activity Log
                            </button>
                        </div>
                    </div>
                    <div class="p-8">
                        <!-- Clinical Notes Tab Content -->
                        <div id="clinical-notes" class="clinical-pane active space-y-6">
                            <div class="flex justify-between items-center mb-8">
                                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">Progress Notes</h4>
                                {% if user.role in 'Doctor,Nurse' and admission.status != 'Discharged' %}
                                    <button data-bs-toggle="modal" data-bs-target="#noteModal" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">
                                        <i class="fas fa-plus mr-2"></i> Add Entry
                                    </button>
                                {% endif %}
                            </div>
                            <div class="space-y-6 relative pl-6">
                                <div class="absolute left-0 top-2 bottom-2 w-0.5 bg-slate-100"></div>
                                {% for note in notes %}
                                    <div class="relative bg-slate-50/50 rounded-2xl p-6 border border-slate-100">
                                        <div class="absolute -left-[30px] top-6 w-4 h-4 rounded-full bg-white border-4 border-indigo-500 shadow-sm z-10"></div>
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex items-center gap-3">
                                                <span class="px-3 py-1 bg-indigo-100 text-indigo-700 text-[9px] font-black rounded-full shadow-sm">{{
                                                note.get_note_type_display }}</span>
                                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{
                                                note.created_at|date:"d M Y @ H:i" }}</span>
                                            </div>
                                            <div class="text-[10px] font-black text-slate-900 bg-white px-2 py-1 rounded-lg border border-slate-100">DR. {{ note.created_by.last_name|upper|default:"SYSTEM" }}</div>
                                        </div>
                                        <p class="text-sm text-slate-600 leading-relaxed font-medium whitespace-pre-line">
                                            {{
                                            note.content }}
                                        </p>
                                    </div>
                                {% empty %}
                                    <div class="py-20 flex flex-col items-center justify-center text-center opacity-40">
                                        <i class="fas fa-clipboard-list text-6xl text-slate-200 mb-6"></i>
                                        <p class="font-black text-slate-400 uppercase tracking-widest">
                                            No clinical notes
                                            recorded
                                        </p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- Medications Tab Content -->
                        <div id="clinical-medications" class="clinical-pane space-y-6" style="display: none;">
                            <div class="flex justify-between items-center mb-8">
                                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest border-l-4 border-purple-500 pl-4">Treatment Card (Active meds)</h4>
                                {% if user.role == 'Doctor' and admission.status != 'Discharged' %}
                                    <button data-bs-toggle="modal" data-bs-target="#medicationModal" class="px-4 py-2 bg-purple-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-purple-100 hover:bg-purple-700 transition-all inline-flex items-center">
                                        <i class="fas fa-pills mr-2"></i> Prescribe
                                    </button>
                                {% endif %}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% for med in medications %}
                                    <div class="bg-white border-2 border-slate-100 rounded-3xl p-6 relative overflow-hidden group hover:border-purple-200 transition-all">
                                        <div class="flex justify-between items-start mb-6">
                                            <div class="w-12 h-12 rounded-2xl bg-purple-50 flex items-center justify-center text-purple-600 text-xl group-hover:bg-purple-600 group-hover:text-white transition-all shadow-inner">
                                                <i class="fas fa-pills"></i>
                                            </div>
                                            <span class="px-3 py-1 {% if med.is_administered %}bg-emerald-100 text-emerald-700{% else %}bg-amber-100 text-amber-700{% endif %} text-[9px] font-black rounded-full uppercase tracking-widest">
                                                {% if med.is_administered %}
                                                    Administered
                                                {% else %}
                                                    Pending
                                                {% endif %}
                                            </span>
                                        </div>
                                        <h5 class="text-lg font-black text-slate-900 mb-1 caps">{{ med.item.name }}</h5>
                                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">
                                            {{
                                            med.dosage }} • {{ med.frequency }}
                                        </div>
                                        <div class="pt-4 border-t border-slate-50 flex justify-between items-center text-[10px] font-bold text-slate-400">
                                            <span>Prescribed by Dr. {{ med.prescribed_by.last_name }}</span>
                                            <span>{{ med.prescribed_at|date:"d M" }}</span>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="col-span-2 py-20 flex flex-col items-center justify-center text-center opacity-40">
                                        <i class="fas fa-pills text-6xl text-slate-200 mb-6"></i>
                                        <p class="font-black text-slate-400 uppercase tracking-widest">
                                            Not currently on
                                            medication
                                        </p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- Consumables Tab Content -->
                        <div id="clinical-consumables" class="clinical-pane space-y-6" style="display: none;">
                            {% if admission.status != 'Discharged' %}
                                {% include 'inventory/partials/dispense_widget.html' %}
                            {% else %}
                                <div class="py-20 flex flex-col items-center justify-center text-center opacity-40">
                                    <i class="fas fa-lock text-6xl text-slate-200 mb-6"></i>
                                    <p class="font-black text-slate-400 uppercase tracking-widest">
                                        Case Folder closed for
                                        dispensing
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                        <!-- Fluid Balance Tab Content -->
                        <div id="clinical-fluids" class="clinical-pane space-y-8" style="display: none;">
                            <div class="flex justify-between items-center">
                                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">
                                    Intake & Output
                                    Summary
                                </h4>
                                {% if admission.status != 'Discharged' %}
                                    <button data-bs-toggle="modal" data-bs-target="#fluidModal" class="px-4 py-2 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">
                                        <i class="fas fa-plus mr-2"></i> Record Fluid
                                    </button>
                                {% endif %}
                            </div>
                            <div class="grid grid-cols-2 gap-8">
                                <div class="bg-blue-50/50 rounded-3xl p-8 border border-blue-100 text-center">
                                    <div class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2">
                                        Total
                                        Intake
                                    </div>
                                    <div class="text-4xl font-black text-blue-900">
                                        {{ fluid_intake|default:"0" }} <span class="text-lg text-blue-400">mL</span>
                                    </div>
                                </div>
                                <div class="bg-rose-50/50 rounded-3xl p-8 border border-rose-100 text-center">
                                    <div class="text-[10px] font-black text-rose-500 uppercase tracking-widest mb-2">
                                        Total
                                        Output
                                    </div>
                                    <div class="text-4xl font-black text-rose-900">
                                        {{ fluid_output|default:"0" }} <span class="text-lg text-rose-400">mL</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-[24px] border border-slate-100 overflow-hidden shadow-sm">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-slate-50">
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Type</th>
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Description</th>
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Volume</th>
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        {% for fluid in admission.fluid_balances.all|slice:":10" %}
                                            <tr class="hover:bg-slate-50 transition-colors">
                                                <td class="px-8 py-4">
                                                    <span class="px-2 py-0.5 {% if fluid.fluid_type == 'Intake' %}bg-blue-100 text-blue-700{% else %}bg-rose-100 text-rose-700{% endif %} text-[9px] font-black rounded-lg uppercase">{{ fluid.fluid_type }}</span>
                                                </td>
                                                <td class="px-8 py-4 text-sm font-bold text-slate-700">{{ fluid.item }}</td>
                                                <td class="px-8 py-4 text-sm font-black text-slate-900">{{ fluid.amount_ml }} mL</td>
                                                <td class="px-8 py-4 text-right text-[10px] font-bold text-slate-400 uppercase">{{ fluid.recorded_at|date:"H:i" }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="4" class="px-8 py-10 text-center text-[10px] font-black uppercase text-slate-300 tracking-widest">No hydrological records</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Instructions Tab Content -->
                        <div id="clinical-instructions" class="clinical-pane" style="display: none;">
                            <div class="flex justify-between items-center mb-8">
                                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest border-l-4 border-amber-500 pl-4">Physician Orders</h4>
                                {% if user.role in 'Doctor,Nurse' and admission.status != 'Discharged' %}
                                    <button data-bs-toggle="modal" data-bs-target="#instructionModal" class="px-4 py-2 bg-amber-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-amber-700 shadow-md">
                                        <i class="fas fa-plus mr-2"></i> New Instruction
                                    </button>
                                {% endif %}
                            </div>
                            <div class="space-y-4">
                                {% for ins in instructions %}
                                    <div class="bg-amber-50/30 border border-amber-100 rounded-[20px] p-6">
                                        <div class="flex justify-between mb-4">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs font-black text-amber-900 uppercase tracking-widest">{{
                                                ins.instruction_type }}</span>
                                                {% if ins.is_completed %}<span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-[8px] font-black rounded-lg uppercase">Completed</span>{% endif %}
                                            </div>
                                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{
                                            ins.created_at|date:"d M @ H:i" }}</span>
                                        </div>
                                        <p class="text-sm font-medium text-slate-700">{{ ins.instruction }}</p>
                                        <div class="mt-4 pt-4 border-t border-amber-100 flex justify-between items-center text-[10px] font-black text-amber-800 uppercase tracking-wide">
                                            {% if not ins.is_completed and user.role == 'Nurse' and admission.status != 'Discharged' %}
                                                <a href="{% url 'inpatient:complete_instruction' ins.id %}" class="text-indigo-600 hover:text-indigo-800">
                                                    MARK AS COMPLETED <i class="fas fa-check-circle ml-1"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="py-20 flex flex-col items-center justify-center opacity-40">
                                        <i class="fas fa-user-md text-6xl text-slate-200 mb-6"></i>
                                        <p class="font-black text-slate-400 uppercase tracking-widest">
                                            Monitoring without
                                            specific orders
                                        </p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- Nutrition Tab Content -->
                        <div id="clinical-nutrition" class="clinical-pane" style="display: none;">
                            <div class="flex justify-between items-center mb-8">
                                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest border-l-4 border-orange-500 pl-4">Diet & Nutrition Order</h4>
                                {% if user.role in 'Doctor,Nurse' and admission.status != 'Discharged' %}
                                    <button data-bs-toggle="modal" data-bs-target="#nutritionModal" class="px-4 py-2 bg-orange-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-700 shadow-md">
                                        <i class="fas fa-utensils mr-2"></i> Update Diet
                                    </button>
                                {% endif %}
                            </div>
                            {% if current_nutrition %}
                                <div class="bg-orange-50 border border-orange-100 rounded-[32px] p-8 mb-8 text-center relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-32 h-32 bg-orange-100/50 rounded-full -mr-16 -mt-16 blur-xl"></div>
                                    <div class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-4">
                                        Current
                                        Prescribed Diet
                                    </div>
                                    <div class="text-4xl font-black text-orange-900 mb-4">
                                        {{
                                        current_nutrition.get_diet_type_display }}
                                    </div>
                                    <p class="text-sm font-bold text-orange-800 max-w-md mx-auto">
                                        {{
                                        current_nutrition.specific_instructions }}
                                    </p>
                                    <div class="mt-6 text-[10px] font-black text-orange-400 uppercase tracking-widest">
                                        Ordered
                                        by Dr. {{ current_nutrition.prescribed_by.last_name }} on {{
                                        current_nutrition.prescribed_at|date:"d M, H:i" }}
                                    </div>
                                </div>
                            {% else %}
                                <div class="bg-slate-50 rounded-[32px] p-12 text-center border-2 border-dashed border-slate-200">
                                    <p class="font-black text-slate-400 uppercase tracking-widest">
                                        No specific diet prescribed
                                        yet
                                    </p>
                                    <p class="text-xs text-slate-400 mt-2">Default: General Ward Diet</p>
                                </div>
                            {% endif %}
                            <div class="mt-10">
                                <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">
                                    Nutrition
                                    History
                                </h5>
                                <div class="space-y-4">
                                    {% for order in nutrition_orders|slice:"1:" %}
                                        <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl">
                                            <div class="flex items-center gap-4">
                                                <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400">
                                                    <i class="fas fa-utensils"></i>
                                                </div>
                                                <div>
                                                    <div class="text-sm font-black text-slate-900">
                                                        {{
                                                        order.get_diet_type_display }}
                                                    </div>
                                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">{{ order.prescribed_at|date:"d M Y" }}</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-[10px] font-black text-slate-900 uppercase tracking-wider">
                                                    DR.
                                                    {{ order.prescribed_by.last_name|upper }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <!-- Procedures Tab Content -->
                        <div id="clinical-procedures" class="clinical-pane" style="display: none;">
                            <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest mb-6">
                                Procedures
                                Management
                            </h4>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Left: Procedure Widget -->
                                <div>
                                    {% if admission.status != 'Discharged' %}
                                        {% include 'accounts/partials/procedure_widget.html' %}
                                    {% else %}
                                        <div class="py-20 flex flex-col items-center justify-center text-center opacity-40">
                                            <i class="fas fa-lock text-6xl text-slate-200 mb-6"></i>
                                            <p class="font-black text-slate-400 uppercase tracking-widest">
                                                Case Folder closed
                                                for procedures
                                            </p>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- Right: Instructions/Info -->
                                <div class="space-y-6">
                                    <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-6">
                                        <h5 class="text-xs font-black text-indigo-900 uppercase tracking-widest mb-4">
                                            <i class="fas fa-info-circle mr-2"></i> Charges
                                        </h5>
                                        <p class="text-[11px] font-bold text-slate-500 leading-relaxed">
                                            Charges are automatically added to the patient's invoice upon selection.
                                            Ensure accurate selection as reversing charges requires admin approval.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Investigations Tab Content -->
                        <div id="clinical-investigations" class="clinical-pane" style="display: none;">
                            <div class="flex justify-between items-center mb-8">
                                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest border-l-4 border-indigo-500 pl-4">Diagnostic Requests & Results</h4>
                                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                    Lab & Imaging
                                    dispatcher
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Request Form -->
                                {% if user.role in 'Doctor,Nurse' and admission.status != 'Discharged' %}
                                    <div class="p-6">
                                        {% include 'home/partials/next_action_widget.html' with patient_id=admission.patient.pk
                                        %}
                                    </div>
                                {% elif admission.status == 'Discharged' %}
                                    <div class="bg-white/50 border border-slate-100 rounded-3xl p-12 text-center">
                                        <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest mb-2">
                                            <i class="fas fa-lock mr-2"></i> Case Closed
                                        </h4>
                                        <p class="text-xs text-slate-400">
                                            Investigations cannot be requested for a discharged
                                            patient.
                                        </p>
                                    </div>
                                {% else %}
                                    <div class="bg-white/50 border border-slate-100 rounded-3xl p-12 text-center">
                                        <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest mb-2">
                                            <i class="fas fa-lock mr-2"></i> Physician Restricted
                                        </h4>
                                        <p class="text-xs text-slate-400">
                                            Diagnostic requests are restricted to Authorized
                                            Clinical Staff.
                                        </p>
                                    </div>
                                {% endif %}
                            </div>
                            <!-- Recent Results -->
                            <div class="space-y-6">
                                <h5 class="text-xs font-black text-slate-900 uppercase tracking-widest mb-6">
                                    Recent
                                    Investigation Results
                                </h5>
                                {% include 'lab/partials/lab_result_widget.html' with lab_results=lab_results %}
                            </div>
                        </div>
                    </div>
                    <!-- Activity Log Tab Content -->
                    <div id="clinical-timeline" class="clinical-pane" style="display: none;">
                        <div class="flex justify-between items-center mb-10">
                            <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest border-l-4 border-slate-900 pl-4">Full Clinical Activity Log</h4>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                Sorted by Most
                                Recent
                            </div>
                        </div>
                        <div class="space-y-8 relative pl-8">
                            <div class="absolute left-0 top-0 bottom-0 w-px bg-slate-100 ml-3.5"></div>
                            {% for log in activity_log %}
                                <div class="relative">
                                    <div class="absolute -left-[45px] top-0 w-9 h-9 rounded-xl bg-{{ log.color }}-50 text-{{ log.color }}-600 border border-{{ log.color }}-100 flex items-center justify-center shadow-sm z-10 transition-transform hover:scale-110">
                                        <i class="fas {{ log.icon }} text-xs"></i>
                                    </div>
                                    <div class="bg-white border border-slate-100 p-5 rounded-2xl hover:border-slate-300 transition-all group">
                                        <div class="flex justify-between items-start mb-2">
                                            <h5 class="text-xs font-black text-slate-900 uppercase tracking-widest">
                                                {{ log.title
                                                }}
                                            </h5>
                                            <span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded-lg">{{
                                            log.time|date:"H:i" }}</span>
                                        </div>
                                        <p class="text-sm font-medium text-slate-600 mb-4 group-hover:text-slate-900">
                                            {{
                                            log.detail }}
                                        </p>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest italic">{{
                                                log.time|date:"d M Y" }}</span>
                                            </div>
                                            <div class="text-[8px] font-black text-slate-400 uppercase tracking-widest border border-slate-100 px-2 py-1 rounded-md">BY: {{ log.user.username|upper|default:"SYSTEM" }}</div>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="py-20 flex flex-col items-center justify-center opacity-40">
                                    <i class="fas fa-history text-6xl text-slate-200 mb-6"></i>
                                    <p class="font-black text-slate-400 uppercase tracking-widest">
                                        Admission history
                                        starting...
                                    </p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modals Migration: Standard HMS Modal Styling -->
<style>
    .modal-content {
        border-radius: 32px !important;
        border: none !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
    }

    .modal-header {
        border-bottom: 1px solid #f1f5f9 !important;
        padding: 24px 32px !important;
    }

    .modal-footer {
        border-top: 1px solid #f1f5f9 !important;
        padding: 24px 32px !important;
    }

    .modal-body {
        padding: 32px !important;
    }

    .form-control {
        border-radius: 12px !important;
        border-color: #e2e8f0 !important;
        font-size: 14px !important;
        padding: 10px 16px !important;
        transition: all 0.2s;
    }

    .form-control:focus {
        border-color: #6366f1 !important;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
        outline: none !important;
    }

    .form-label {
        font-size: 11px !important;
        font-weight: 900 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
        color: #64748b !important;
        margin-bottom: 8px !important;
        display: block !important;
    }

    .clinical-tab {
        color: #94a3b8;
        border: 2px solid transparent;
    }

    .clinical-tab.active {
        color: #6366f1;
        background: #eef2ff;
        border-color: #e0e7ff;
    }

    .clinical-tab:hover:not(.active) {
        color: #64748b;
        background: #f8fafc;
    }

    @media print {
        .dashboard-container {
            display: block !important;
        }

        .sidebar,
        .top-bar,
        .flex,
        .btn,
        .clinical-tab,
        .no-print {
            display: none !important;
        }

        .patient-card {
            box-shadow: none !important;
            border: 1px solid #eee !important;
        }
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Tailwind safe-list for dynamic colors */
</style>
<!-- Placeholder for all Modals (Vitals, Notes, Discharge etc) with HMS styles applied -->
{% block modals %}
    <!-- Redesign of Vitals Modal -->
    <div class="modal fade" id="vitalsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-slate-50/50">
                    <h5 class="text-sm font-black text-slate-900 uppercase tracking-widest flex items-center gap-3">
                        <i class="fas fa-heartbeat text-rose-500"></i> New Clinical Observations
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="{% url 'inpatient:add_vitals' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% for field in vitals_form %}
                                <div>
                                    <label class="form-label">{{ field.label }}</label>
                                    {{ field }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer bg-slate-50/50">
                        <button type="button" class="px-6 py-3 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="px-8 py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">
                            Save
                            Records
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Add Note Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-slate-50/50 flex justify-between items-center">
                    <h5 class="text-sm font-black text-slate-900 uppercase tracking-widest">New Progress Note</h5>
                    <button type="button" class="btn-close text-slate-400 hover:text-slate-600 transition-colors" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_clinical_note' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body space-y-6">
                        <div>
                            <label class="form-label">Note Category</label>
                            {{ note_form.note_type }}
                        </div>
                        <div>
                            <label class="form-label">Clinical Narrative</label>
                            {{ note_form.content }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                            Commit
                            to Record
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Discharge Modal -->
    <div class="modal fade" id="dischargeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-rose-50 border-b border-rose-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-rose-900 uppercase tracking-widest flex items-center gap-3">
                        <i class="fas fa-sign-out-alt"></i> Clinical Discharge Process
                    </h5>
                    <button type="button" class="btn-close text-rose-400 hover:text-rose-600 transition-colors" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:discharge_patient' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body space-y-6 bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">Effective Date/Time</label>
                                <input type="datetime-local" name="discharged_at" class="form-control" required>
                            </div>
                            <div>
                                <label class="form-label">Final Diagnosis</label>
                                <input type="text" name="final_diagnosis" class="form-control" placeholder="Primary reason for discharge" required>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Clinical Summary</label>
                            <textarea name="discharge_summary" class="form-control" rows="4" placeholder="Brief clinical course and condition at discharge..." required></textarea>
                        </div>
                        <div>
                            <label class="form-label">Post-Discharge Instructions</label>
                            <textarea name="discharge_instructions" class="form-control" rows="3" placeholder="Medications, follow-up clinic, etc."></textarea>
                        </div>
                        <div class="p-6 bg-rose-50 rounded-2xl border border-rose-100 flex gap-4">
                            <i class="fas fa-exclamation-circle text-rose-500 mt-1"></i>
                            <p class="text-[11px] font-bold text-rose-900 leading-relaxed uppercase tracking-tight">
                                Warning:
                                This will terminate the admission record and release the assigned bed ({{
                                admission.bed.bed_number }}). Final billing should be verified.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer bg-slate-50/50">
                        <button type="button" class="px-6 py-3 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all mr-auto" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="px-8 py-3 bg-rose-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-rose-100 hover:bg-rose-700 transition-all">
                            Confirm
                            Patient Discharge
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Other Modals (Medication, Fluid, Instruction, Transfer, Nutrition) - Simplified Redesign Tags -->
    <!-- Medication (MedicationChart) Modal -->
    <div class="modal fade" id="medicationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-purple-50 border-b border-purple-100">
                    <h5 class="text-sm font-black text-purple-900 uppercase tracking-widest flex items-center gap-3">
                        <i class="fas fa-pills text-purple-500"></i> Prescribe Inpatient Medication
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="{% url 'inpatient:add_medication' admission.id %}" method="POST" id="medChartForm">
                    {% csrf_token %}
                    <div class="modal-body bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2 relative">
                                <label class="form-label">Medication</label>
                                <div class="relative">
                                    <input type="text" id="med-search-input" placeholder="Search medications..." class="form-control w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                                    <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                </div>
                                <div id="med-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg max-h-64 overflow-y-auto">
                                    <!-- Options will be populated via JavaScript -->
                                </div>
                                <div class="hidden">{{ med_form.item }}</div>
                                <div id="whole-dispense-notice" class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-xl flex gap-3 hidden">
                                    <i class="fas fa-info-circle text-amber-500 mt-0.5"></i>
                                    <p class="text-[11px] font-bold text-amber-900 leading-relaxed uppercase tracking-tight">Note: This medication is usually prescribed as a whole package.</p>
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Units Per Dose</label>
                                {{ med_form.dose_count }}
                            </div>
                            <div>
                                <label class="form-label">Frequency</label>
                                {{ med_form.frequency }}
                            </div>
                            <div class="md:col-span-2">
                                <label class="form-label">Total Quantity</label>
                                {{ med_form.quantity }}
                                <p class="text-[10px] text-slate-400 mt-1">Total units to dispense</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-slate-50/50">
                        <button type="button" class="px-6 py-3 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="px-8 py-3 bg-purple-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-purple-100 hover:bg-purple-700 transition-all">
                            Prescribe
                            Medication
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="fluidModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-blue-50/50 flex justify-between items-center">
                    <h5 class="text-sm font-black text-blue-900 uppercase tracking-widest">Hydrological Balance Entry</h5>
                    <button type="button" class="btn-close text-blue-400 hover:text-blue-600 transition-colors" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_fluid' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body space-y-4">
                        {% for field in fluid_form %}
                            <div>
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="w-full py-4 bg-blue-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">
                            Save
                            Fluid Record
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="instructionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-amber-50/50 flex justify-between items-center">
                    <h5 class="text-sm font-black text-amber-900 uppercase tracking-widest">Clinical Physician Orders</h5>
                    <button type="button" class="btn-close text-amber-400 hover:text-amber-600 transition-colors" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_doctor_instruction' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body space-y-4">
                        {% for field in instruction_form %}
                            <div>
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="w-full py-4 bg-amber-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-amber-700 transition-all shadow-lg shadow-amber-100">
                            Commit
                            Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="nutritionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-orange-50/50 flex justify-between items-center">
                    <h5 class="text-sm font-black text-orange-900 uppercase tracking-widest">Dietary & Nutrition Order</h5>
                    <button type="button" class="btn-close text-orange-400 hover:text-orange-600 transition-colors" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_nutrition' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body space-y-4">
                        {% for field in nutrition_form %}
                            <div>
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="w-full py-4 bg-orange-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-700 transition-all shadow-lg shadow-orange-100">Update Nutrition Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content overflow-hidden">
                <div class="modal-header bg-indigo-50/50 flex justify-between items-center">
                    <h5 class="text-sm font-black text-indigo-900 uppercase tracking-widest">Internal Ward Transfer</h5>
                    <button type="button" class="btn-close text-indigo-400 hover:text-indigo-600 transition-colors" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:transfer_patient' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body space-y-4">
                        {% for field in transfer_form %}
                            <div>
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                            Execute
                            Transfer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    {{ vitals_data|default:"{}"|json_script:"vitals-data" }}
    {{ medical_tests_data|default:"[]"|json_script:"services-data" }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // Safe Metadata Injection
    const medMetadata = {{ med_metadata_json|default:"{}"|safe }};

    function showClinicalTab(tabName) {
        document.querySelectorAll('.clinical-pane').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.clinical-tab').forEach(t => t.classList.remove('active', 'text-slate-900', 'border-indigo-600'));
        document.querySelectorAll('.clinical-tab').forEach(t => t.classList.add('text-slate-400', 'border-transparent'));

        document.getElementById('clinical-' + tabName).style.display = 'block';
        const activeBtn = document.getElementById('tab-btn-' + tabName);
        activeBtn.classList.remove('text-slate-400', 'border-transparent');
        activeBtn.classList.add('active', 'text-slate-900', 'border-indigo-600');
    }

    // Auto-switch to tab from URL parameter on page load
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');

        if (activeTab) {
            // Valid tabs: notes, medications, fluids, instructions, investigations, nutrition, timeline
            const validTabs = ['notes', 'medications', 'fluids', 'instructions', 'investigations', 'nutrition', 'timeline'];
            if (validTabs.includes(activeTab)) {
                showClinicalTab(activeTab);
            }
        }

        // ==================== DYNAMIC BED LOADING ====================
        const wardSelect = document.getElementById('id_ward');
        const bedSelect = document.getElementById('id_to_bed');

        if (wardSelect && bedSelect) {
            // Style Django rendered fields
            wardSelect.classList.add('form-select', 'form-control');
            bedSelect.classList.add('form-select', 'form-control');

            wardSelect.addEventListener('change', function () {
                const wardId = this.value;
                bedSelect.innerHTML = '<option value="">Loading beds...</option>';

                if (wardId) {
                    fetch(`/inpatient/wards/${wardId}/available-beds/`)
                        .then(response => response.json())
                        .then(data => {
                            bedSelect.innerHTML = '<option value="" selected="">---------</option>';
                            if (data.beds.length > 0) {
                                data.beds.forEach(bed => {
                                    const option = document.createElement('option');
                                    option.value = bed.id;
                                    option.textContent = `${bed.bed_number} (${bed.bed_type})`;
                                    bedSelect.appendChild(option);
                                });
                            } else {
                                bedSelect.innerHTML = '<option value="">No beds available</option>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            bedSelect.innerHTML = '<option value="">Error loading beds</option>';
                        });
                } else {
                    bedSelect.innerHTML = '<option value="" selected="">---------</option>';
                }
            });
        }
    });



    document.addEventListener('DOMContentLoaded', function () {
        // ... previous vitals chart logic ...
        const vitalsDataEl = document.getElementById('vitals-data');
        const vitalsData = vitalsDataEl ? JSON.parse(vitalsDataEl.textContent) : {};

        const ctx = document.getElementById('vitalsChart');
        if (ctx && vitalsData.times && vitalsData.times.length > 0) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: vitalsData.times,
                    datasets: [
                        {
                            label: 'Pulse (bpm)',
                            data: vitalsData.pulse,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.05)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3
                        },
                        {
                            label: 'Systolic BP',
                            data: vitalsData.systolic,
                            borderColor: '#6366f1',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'SpO2 (%)',
                            data: vitalsData.spo2,
                            borderColor: '#10b981',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { display: false },
                        x: { display: false }
                    }
                }
            });
        }
    });

    // ==================== SEARCHABLE MEDICATION SELECT ====================
    const medSearchInput = document.getElementById('med-search-input');
    const medDropdown = document.getElementById('med-dropdown');
    const medSelect = document.querySelector('.medication-select');
    let medications = [];

    // Populate medications from the hidden select
    if (medSelect) {
        Array.from(medSelect.options).forEach(option => {
            if (option.value) {
                medications.push({
                    id: option.value,
                    name: option.textContent.trim()
                });
            }
        });
    }

    // Show dropdown with filtered results
    function showMedicationDropdown(searchTerm = '') {
        const filtered = medications.filter(med =>
            med.name.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (filtered.length === 0) {
            medDropdown.innerHTML = '<div class="px-4 py-3 text-sm text-slate-400 italic">No medications found</div>';
        } else {
            medDropdown.innerHTML = filtered.map(med => `
                <div class="med-option px-4 py-2 hover:bg-indigo-50 cursor-pointer text-sm transition-colors" data-id="${med.id}">
                    <div class="font-semibold text-slate-900">${med.name}</div>
                </div>
            `).join('');

            // Add click handlers to options
            medDropdown.querySelectorAll('.med-option').forEach(option => {
                option.addEventListener('click', function () {
                    const medId = this.dataset.id;
                    const medName = medications.find(m => m.id == medId).name;

                    // Update hidden select and search input
                    medSelect.value = medId;
                    medSearchInput.value = medName;
                    medDropdown.classList.add('hidden');

                    // Trigger change event for calculation
                    medSelect.dispatchEvent(new Event('change'));
                });
            });
        }

        medDropdown.classList.remove('hidden');
    }

    // Search input handlers
    if (medSearchInput) {
        medSearchInput.addEventListener('focus', function () {
            showMedicationDropdown(this.value);
        });

        medSearchInput.addEventListener('input', function () {
            showMedicationDropdown(this.value);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!medSearchInput.contains(e.target) && !medDropdown.contains(e.target)) {
                medDropdown.classList.add('hidden');
            }
        });
    }

    // ==================== SMART PRESCRIPTION CALCULATION ====================
    // medMetadata is already defined safely at top of script block

    // Get form elements
    const doseInput = document.querySelector('#{{ med_form.dose_count.id_for_label }}');
    const qtyInput = document.querySelector('#{{ med_form.quantity.id_for_label }}');
    const qtyHelp = document.getElementById('qty-help-text');
    const wholeNotice = document.getElementById('whole-dispense-notice');

    if (medSelect) {
        medSelect.addEventListener('change', function () {
            const medId = this.value;
            if (medId && medMetadata[medId] && medMetadata[medId].is_dispensed_as_whole) {
                wholeNotice.classList.remove('hidden');
            } else {
                wholeNotice.classList.add('hidden');
            }
        });
    }

    // No auto-calculation needed — quantity is manually entered (matching PrescriptionItem)

    // Form submission handler - convert "Full Dosage" back to 1
    const medForm = document.querySelector('#medicationModal form');
    if (medForm) {
        medForm.addEventListener('submit', function (e) {
            if (durInput && durInput.value === 'Full Dosage') {
                durInput.type = 'number';
                durInput.value = '1';
            }
        });
    }

    </script>
{% endblock %}
{% endblock %}
