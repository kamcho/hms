{% extends 'users/dashboard_base.html' %}
{% load static %}
{% block title %}{{ deceased.full_name }} - Morgue{% endblock %}
{% block content %}
    <div class="px-8 py-6 max-w-[1600px] mx-auto deceased-container">
        <!-- Breadcrumbs & Back -->
        <div class="mb-8">
            <a href="{% url 'morgue:deceased_list' %}" class="inline-flex items-center text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-indigo-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> Back to Mortuary Registry
            </a>
        </div>
        <!-- Premium Header Card -->
        <div class="premium-header relative mb-8">
            <div class="header-accent"></div>
            <div class="relative z-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8">
                <div class="flex items-center gap-6">
                    <div class="relative">
                        <div class="w-24 h-24 rounded-3xl bg-indigo-600 shadow-xl flex items-center justify-center text-white text-3xl font-black">{{ deceased.surname|first }}{{ deceased.other_names|first }}</div>
                        {% if not deceased.is_released %}
                            <div class="absolute -bottom-2 -right-2 w-8 h-8 rounded-xl bg-emerald-500 border-4 border-white flex items-center justify-center text-white text-xs shadow-lg" title="Currently Admitted">
                                <i class="fas fa-hospital"></i>
                            </div>
                        {% else %}
                            <div class="absolute -bottom-2 -right-2 w-8 h-8 rounded-xl bg-slate-400 border-4 border-white flex items-center justify-center text-white text-xs shadow-lg" title="Released">
                                <i class="fas fa-check"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h1 class="text-3xl font-black text-slate-900 tracking-tight">{{ deceased.full_name }}</h1>
                            <span class="badge-premium badge-indigo">TAG: {{ deceased.tag }}</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-y-2 gap-x-6">
                            <div class="flex items-center gap-2 text-slate-500 font-bold text-sm">
                                <i class="fas fa-venus-mars text-indigo-500"></i> {{ deceased.get_sex_display }}
                            </div>
                            <div class="flex items-center gap-2 text-slate-500 font-bold text-sm">
                                <i class="fas fa-cross text-indigo-500"></i> DOD: {{ deceased.date_of_death|date:"d M Y" }}
                            </div>
                            <div class="flex items-center gap-2 text-slate-500 font-bold text-sm">
                                <i class="fas fa-snowflake text-indigo-500"></i> {{ deceased.get_storage_area_display }} •
                                {{ deceased.get_storage_chamber_display }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 w-full lg:w-auto">
                    {% if not deceased.is_released %}
                        <a href="{% url 'morgue:deceased_update' deceased.pk %}" class="flex-1 lg:flex-none px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest hover:border-indigo-600 hover:text-indigo-600 transition-all shadow-sm flex items-center justify-center gap-2">
                            <i class="fas fa-edit"></i> Edit Record
                        </a>
                        <a href="{% url 'morgue:release_deceased' deceased.pk %}" class="flex-1 lg:flex-none px-6 py-3 bg-amber-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-amber-700 shadow-lg shadow-amber-100 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> Proceed to Release
                        </a>
                    {% else %}
                        <div class="px-6 py-3 bg-slate-100 text-slate-500 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> Formal Release Completed
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Financial Status Bar -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="info-card flex justify-between items-center bg-indigo-50/30 border-indigo-100">
                <div>
                    <div class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Total Services Cost</div>
                    <div class="text-2xl font-black text-slate-900">${{ total_services_cost|floatformat:2 }}</div>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-indigo-100 flex items-center justify-center text-indigo-600">
                    <i class="fas fa-hand-holding-heart"></i>
                </div>
            </div>
            <div class="info-card flex justify-between items-center bg-emerald-50/30 border-emerald-100">
                <div>
                    <div class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-1">Total Invoiced</div>
                    <div class="text-2xl font-black text-slate-900">${{ total_invoiced|floatformat:2 }}</div>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-emerald-100 flex items-center justify-center text-emerald-600">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
            </div>
            <div class="info-card flex justify-between items-center {% if outstanding_balance > 0 %}bg-rose-50/30 border-rose-100{% else %}bg-slate-50/30 border-slate-100{% endif %}">
                <div>
                    <div class="text-[10px] font-black {% if outstanding_balance > 0 %}text-rose-500{% else %}text-slate-500{% endif %} uppercase tracking-widest mb-1">Outstanding Balance</div>
                    <div class="text-2xl font-black text-slate-900">${{ outstanding_balance|floatformat:2 }}</div>
                </div>
                <div class="w-12 h-12 rounded-2xl {% if outstanding_balance > 0 %}bg-rose-100 text-rose-600{% else %}bg-slate-100 text-slate-600{% endif %} flex items-center justify-center">
                    <i class="fas fa-wallet"></i>
                </div>
            </div>
        </div>
        <!-- Main Workspace -->
        <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 overflow-hidden min-h-[600px]">
            <!-- Tabs Navigation -->
            <div class="px-8 py-4 bg-slate-50/50 border-b border-slate-100">
                <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                    <button onclick="showDeceasedTab('overview')" id="tab-btn-overview" class="premium-tab active whitespace-nowrap">
                        <i class="fas fa-id-card mr-2"></i> Record Overview
                    </button>
                    <button onclick="showDeceasedTab('nok')" id="tab-btn-nok" class="premium-tab whitespace-nowrap">
                        <i class="fas fa-users mr-2"></i> Next of Kin
                    </button>
                    <button onclick="showDeceasedTab('admissions')" id="tab-btn-admissions" class="premium-tab whitespace-nowrap">
                        <i class="fas fa-clipboard-list mr-2"></i> Admissions
                    </button>
                    <button onclick="showDeceasedTab('services')" id="tab-btn-services" class="premium-tab whitespace-nowrap">
                        <i class="fas fa-concierge-bell mr-2"></i> Services
                    </button>
                    <button onclick="showDeceasedTab('billing')" id="tab-btn-billing" class="premium-tab whitespace-nowrap">
                        <i class="fas fa-file-invoice-dollar mr-2"></i> Invoices
                    </button>
                </div>
            </div>
            <div class="p-8">
                <!-- Overview Tab -->
                <div id="deceased-overview" class="deceased-pane active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Personal Info Card -->
                        <div class="space-y-6">
                            <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-50 pb-3">Personal & Identity</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Deceased Type</div>
                                    <div class="text-sm font-bold text-slate-900 uppercase tracking-tight">{{ deceased.get_deceased_type_display }}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Scheme</div>
                                    <div class="text-sm font-bold text-slate-900 uppercase tracking-tight">{{ deceased.get_scheme_display }}</div>
                                </div>
                                <div class="col-span-2">
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">{{ deceased.get_id_type_display }}</div>
                                    <div class="text-sm font-bold text-slate-900 uppercase tracking-tight">{{ deceased.id_number }}</div>
                                </div>
                            </div>
                        </div>
                        <!-- Death details -->
                        <div class="space-y-6">
                            <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-50 pb-3">Death Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">
                                        Time
                                        of Death
                                    </div>
                                    <div class="text-sm font-bold text-slate-900 uppercase tracking-tight">{{ deceased.time_of_death|time:"H:i" }}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">
                                        Place
                                        of Death
                                    </div>
                                    <div class="text-sm font-bold text-slate-900 uppercase tracking-tight">{{ deceased.place_of_death }}</div>
                                </div>
                                <div class="col-span-2">
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">
                                        Cause
                                        of Death
                                    </div>
                                    <div class="text-sm font-medium text-slate-600 leading-relaxed">{{ deceased.cause_of_death }}</div>
                                </div>
                            </div>
                        </div>
                        <!-- Address & storage -->
                        <div class="space-y-6">
                            <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-50 pb-3">Residence & Storage</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Residence</div>
                                    <div class="text-sm font-bold text-slate-900">{{ deceased.residence }}, {{ deceased.town }}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Expected Removal</div>
                                    <div class="text-sm font-bold text-slate-900">{{ deceased.expected_removal_date|date:"d                                     M Y" }}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Nationality</div>
                                    <div class="text-sm font-bold text-slate-900">{{ deceased.nationality }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Next of Kin Tab -->
                <div id="deceased-nok" class="deceased-pane" style="display: none;">
                    <div class="flex justify-between items-center mb-8">
                        <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">Family & Emergency Contacts</h4>
                        {% if not deceased.is_released %}
                            <a href="{% url 'morgue:next_of_kin_create' deceased.pk %}" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-100">
                                <i class="fas fa-plus mr-2"></i> Add Next of Kin
                            </a>
                        {% endif %}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for kin in next_of_kin %}
                            <div class="info-card border-l-4 {% if kin.is_primary %}border-l-emerald-500{% else %}border-l-slate-300{% endif %}">
                                <div class="flex justify-between items-start mb-4">
                                    <h5 class="font-black text-slate-900 uppercase tracking-tight">{{ kin.name }}</h5>
                                    {% if kin.is_primary %}<span class="badge-premium badge-emerald">Primary</span>{% endif %}
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2 text-xs font-bold text-slate-500">
                                        <i class="fas fa-link w-4"></i> {{ kin.get_relationship_display }}
                                    </div>
                                    <div class="flex items-center gap-2 text-xs font-bold text-slate-500">
                                        <i class="fas fa-phone w-4"></i> {{ kin.phone|default:"N/A" }}
                                    </div>
                                    <div class="flex items-center gap-2 text-xs font-bold text-slate-500">
                                        <i class="fas fa-envelope w-4"></i> {{ kin.email|default:"N/A" }}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="col-span-full py-20 bg-slate-50 rounded-[32px] text-center border-2 border-dashed border-slate-200">
                                <i class="fas fa-users text-4xl text-slate-200 mb-4"></i>
                                <p class="font-black text-slate-400 uppercase tracking-widest">No family contacts listed</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Admissions Tab -->
                <div id="deceased-admissions" class="deceased-pane" style="display: none;">
                    <div class="flex justify-between items-center mb-8">
                        <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">Admission History</h4>
                        {% if not deceased.is_released %}
                            <a href="{% url 'morgue:create_admission' deceased.pk %}" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest">
                                <i class="fas fa-plus mr-2"></i> New Admission
                            </a>
                        {% endif %}
                    </div>
                    <div class="space-y-4">
                        {% for admission in admissions %}
                            <div class="info-card flex flex-col md:flex-row justify-between items-center gap-6">
                                <div class="flex items-center gap-6">
                                    <div class="w-12 h-12 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-500 font-black">{{ forloop.revcounter }}</div>
                                    <div>
                                        <div class="text-xs font-black text-slate-900 uppercase tracking-widest">{{ admission.admission_number }}</div>
                                        <div class="text-[10px] font-bold text-slate-400 uppercase">{{ admission.admission_datetime|date:"d M Y, H:i" }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-8">
                                    <div>
                                        <div class="text-[9px] font-black text-slate-400 uppercase mb-1">Status</div>
                                        <span class="badge-premium {% if admission.status == 'ADMITTED' %}badge-indigo{% else %}badge-slate{% endif %}">{{ admission.get_status_display }}</span>
                                    </div>
                                    {% if admission.release_date %}
                                        <div>
                                            <div class="text-[9px] font-black text-slate-400 uppercase mb-1">Released To</div>
                                            <div class="text-xs font-bold text-slate-900">{{ admission.released_to|default:"N/A" }}</div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <div class="py-20 bg-slate-50 rounded-[32px] text-center border-2 border-dashed border-slate-200">
                                <p class="font-black text-slate-400 uppercase tracking-widest">No admission records found</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Services Tab -->
                <div id="deceased-services" class="deceased-pane" style="display: none;">
                    <div class="flex justify-between items-center mb-8">
                        <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">Performed Mortuary Services</h4>
                        {% if not deceased.is_released %}
                            <button onclick="openServiceModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest">
                                <i class="fas fa-hand-holding-heart mr-2"></i> Log Service
                            </button>
                        {% endif %}
                    </div>
                    {% if performed_services %}
                        <div class="overflow-hidden bg-white rounded-2xl border border-slate-100">
                            <table class="premium-table">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Quantity</th>
                                        <th>Date Performed</th>
                                        <th>Staff Member</th>
                                        <th class="text-right">Charges</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in performed_services %}
                                        <tr>
                                            <td class="font-bold">{{ record.service.name }}</td>
                                            <td class="font-bold text-slate-500">{{ record.quantity }}</td>
                                            <td class="text-xs font-bold text-slate-400 uppercase">{{ record.date_performed|date:"d                                     M, H:i" }}</td>
                                            <td class="text-xs font-black text-indigo-600 uppercase">{{ record.performed_by.last_name|upper }}</td>
                                            <td class="text-right font-black text-emerald-600">${% widthratio record.service.price 1                                     record.quantity %}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="py-20 bg-slate-50 rounded-[32px] text-center border-2 border-dashed border-slate-200">
                            <p class="font-black text-slate-400 uppercase tracking-widest">No services logged for this session</p>
                        </div>
                    {% endif %}
                </div>
                <!-- Billing Tab -->
                <div id="deceased-billing" class="deceased-pane" style="display: none;">
                    <div class="flex justify-between items-center mb-8">
                        <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest">Mortuary Invoices</h4>
                        {% if not deceased.is_released and uninvoiced_services %}
                            <button onclick="openInvoiceModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest">
                                <i class="fas fa-plus mr-2"></i>
                                {% if invoices %}
                                    Add to Invoice
                                {% else %}
                                    Create Invoice
                                {% endif %}
                            </button>
                        {% endif %}
                    </div>
                    {% if invoices %}
                        <div class="space-y-4">
                            {% for invoice in invoices %}
                                <div class="info-card flex flex-col md:flex-row justify-between items-center gap-6">
                                    <div class="flex items-center gap-6">
                                        <div class="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600">
                                            <i class="fas fa-file-invoice"></i>
                                        </div>
                                        <div>
                                            <div class="text-xs font-black text-slate-900 uppercase tracking-widest">INV-{{ invoice.id }}</div>
                                            <div class="text-[10px] font-bold text-slate-400 uppercase">{{ invoice.created_at|date:"d M Y" }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-12">
                                        <div>
                                            <div class="text-[9px] font-black text-slate-400 uppercase mb-1">Amount Due</div>
                                            <div class="text-sm font-black text-slate-900">${{ invoice.total_amount|floatformat:2 }}</div>
                                        </div>
                                        <div>
                                            <div class="text-[9px] font-black text-slate-400 uppercase mb-1">Status</div>
                                            <span class="badge-premium {% if invoice.status == 'Paid' %}badge-emerald{% elif invoice.status == 'Pending' %}badge-rose{% else %}badge-slate{% endif %}">{{ invoice.get_status_display }}</span>
                                        </div>
                                        <a href="{% url 'accounts:invoice_detail' invoice.id %}" class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-900 hover:text-white transition-all">
                                            <i class="fas fa-arrow-right text-[10px]"></i>
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="py-20 bg-slate-50 rounded-[32px] text-center border-2 border-dashed border-slate-200">
                            <p class="font-black text-slate-400 uppercase tracking-widest">No invoices generated yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% if not deceased.is_released %}
        <!-- Log Service Modal -->
        <div id="serviceModal" class="modal-overlay" style="display: none; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);">
            <div class="modal-content !max-w-md w-full bg-white mx-4">
                <div class="modal-header">
                    <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest">Log Mortuary Service</h3>
                </div>
                <div class="modal-body">
                    <form id="serviceForm" class="space-y-6">
                        {% csrf_token %}
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Service</label>
                            <div class="premium-input-wrapper">{{ service_form.service }}</div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Quantity</label>
                            <div class="premium-input-wrapper">{{ service_form.quantity }}</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer flex gap-3">
                    <button onclick="closeServiceModal()" class="flex-1 px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all">Cancel</button>
                    <button onclick="submitService()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all">Add Service</button>
                </div>
            </div>
        </div>
        <!-- Invoice Creation Modal -->
        <div id="invoiceModal" class="modal-overlay" style="display: none; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);">
            <div class="modal-content !max-w-2xl w-full bg-white mx-4">
                <div class="modal-header">
                    <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest">
                        {% if invoices %}
                            Update Mortuary
                            Invoice
                        {% else %}
                            Create Mortuary Invoice
                        {% endif %}
                    </h3>
                </div>
                <div class="modal-body">
                    <p class="text-[11px] font-bold text-slate-500 uppercase mb-6">Select uninvoiced services to include:</p>
                    <form id="invoiceForm">
                        {% csrf_token %}
                        {% if uninvoiced_services %}
                            <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                {% for service in uninvoiced_services %}
                                    <label class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100 cursor-pointer hover:border-indigo-300 transition-all">
                                        <input type="checkbox" name="service_ids" value="{{ service.id }}" data-price="{{ service.service.price }}" data-quantity="{{ service.quantity }}" class="w-5 h-5 rounded-lg border-slate-300 text-indigo-600 focus:ring-indigo-500" onchange="updateInvoiceTotal()">
                                        <div class="flex-1">
                                            <div class="text-xs font-black text-slate-900 uppercase">{{ service.service.name }}</div>
                                            <div class="text-[10px] font-bold text-slate-400 capitalize">{{ service.date_performed|date:"d M, H:i" }} • Qty: {{ service.quantity }}</div>
                                        </div>
                                        <div class="text-xs font-black text-indigo-600">${% widthratio service.service.price 1                             service.quantity %}</div>
                                    </label>
                                {% endfor %}
                            </div>
                            <div class="mt-8 p-6 bg-indigo-50 rounded-2xl border border-indigo-100 flex justify-between items-center">
                                <span class="text-xs font-black text-indigo-900 uppercase tracking-widest">Total Invoice
                                Amount</span>
                                <span id="invoiceTotal" class="text-2xl font-black text-indigo-600">$0.00</span>
                            </div>
                        {% else %}
                            <div class="py-12 bg-slate-50 rounded-2xl text-center border-2 border-dashed border-slate-200">
                                <i class="fas fa-check-circle text-emerald-500 text-2xl mb-3"></i>
                                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">
                                    All services have been
                                    invoiced
                                </p>
                            </div>
                        {% endif %}
                    </form>
                </div>
                <div class="modal-footer flex gap-3">
                    <button onclick="closeInvoiceModal()" class="flex-1 px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all">Cancel</button>
                    {% if uninvoiced_services %}<button onclick="submitInvoice()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all">Generate Invoice</button>{% endif %}
                </div>
            </div>
        </div>
    {% endif %}
    <style>
    /* Premium Modern Aesthetic */
    :root {
        --primary-indigo: #6366f1;
        --primary-dark: #4f46e5;
        --secondary-slate: #64748b;
        --bg-slate: #f8fafc;
        --border-slate: #e2e8f0;
    }

    .px-8 {
        padding-left: 2rem;
        padding-right: 2rem;
    }

    .py-6 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }

    .max-w-\[1600px\] {
        max-width: 1600px;
    }

    .mx-auto {
        margin-left: auto;
        margin-right: auto;
    }

    .deceased-container {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Premium Header Card */
    .premium-header {
        background: white;
        border-radius: 32px;
        border: 1px solid var(--border-slate);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        position: relative;
        overflow: hidden;
    }

    .header-accent {
        position: absolute;
        top: 0;
        right: 0;
        width: 16rem;
        height: 16rem;
        background: rgba(99, 102, 241, 0.05);
        border-radius: 9999px;
        margin-right: -8rem;
        margin-top: -8rem;
        filter: blur(40px);
    }

    /* Information Cards */
    .info-card {
        background: white;
        border-radius: 24px;
        border: 1px solid var(--border-slate);
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Tabs Styling */
    .premium-tab {
        padding: 0.75rem 1.5rem;
        font-size: 0.75rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border-radius: 12px;
        transition: all 0.2s;
        color: var(--secondary-slate);
        border: 2px solid transparent;
    }

    .premium-tab:hover:not(.active) {
        background: #f1f5f9;
        color: #1e293b;
    }

    .premium-tab.active {
        background: #eef2ff;
        color: var(--primary-indigo);
        border-color: #e0e7ff;
    }

    /* Status Badges */
    .badge-premium {
        padding: 0.25rem 0.75rem;
        font-size: 0.625rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-radius: 9999px;
    }

    .badge-indigo {
        background: #eef2ff;
        color: #4338ca;
        border: 1px solid #e0e7ff;
    }

    .badge-emerald {
        background: #ecfdf5;
        color: #047857;
        border: 1px solid #d1fae5;
    }

    .badge-rose {
        background: #fff1f2;
        color: #be123c;
        border: 1px solid #ffe4e6;
    }

    .badge-slate {
        background: #f8fafc;
        color: #475569;
        border: 1px solid #f1f5f9;
    }

    /* Tables */
    .premium-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .premium-table th {
        padding: 1rem;
        font-size: 0.625rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--secondary-slate);
        background: #f8fafc;
        border-bottom: 1px solid var(--border-slate);
    }

    .premium-table td {
        padding: 1rem;
        font-size: 0.875rem;
        color: #1e293b;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Modals */
    .modal-content {
        border-radius: 24px;
        border: none;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .modal-header {
        border-bottom: 1px solid #f1f5f9;
        padding: 1.5rem 2rem;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        border-top: 1px solid #f1f5f9;
        padding: 1.5rem 2rem;
    }

    /* Utilities */
    .font-black {
        font-weight: 900;
    }

    .tracking-tight {
        letter-spacing: -0.025em;
    }

    .tracking-widest {
        letter-spacing: 0.1em;
    }

    .text-xs {
        font-size: 0.75rem;
    }

    .text-3xl {
        font-size: 1.875rem;
        line-height: 2.25rem;
    }

    .uppercase {
        text-transform: uppercase;
    }

    @media (max-width: 1024px) {
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
    }
    </style>
    <script>
    // Tab Navigation
    function showDeceasedTab(tabName) {
        // Hide all panes
        document.querySelectorAll('.deceased-pane').forEach(pane => {
            pane.style.display = 'none';
        });

        // Deactivate all buttons
        document.querySelectorAll('.premium-tab').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected pane
        document.getElementById('deceased-' + tabName).style.display = 'block';

        // Activate selected button
        document.getElementById('tab-btn-' + tabName).classList.add('active');

        // Store active tab in local storage
        localStorage.setItem('activeDeceasedTab', tabName);
    }

    // Restore active tab on load
    document.addEventListener('DOMContentLoaded', function () {
        const savedTab = localStorage.getItem('activeDeceasedTab');
        if (savedTab && document.getElementById('deceased-' + savedTab)) {
            showDeceasedTab(savedTab);
        }
    });

    {% if not deceased.is_released %}
    function openServiceModal() {
        document.getElementById('serviceModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeServiceModal() {
        document.getElementById('serviceModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function submitService() {
        const form = document.getElementById('serviceForm');
        const formData = new FormData(form);

        fetch("{% url 'morgue:log_service' deceased.pk %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error processing service. Please check details.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
            });
    }

    function openInvoiceModal() {
        document.getElementById('invoiceModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        updateInvoiceTotal();
    }

    function closeInvoiceModal() {
        document.getElementById('invoiceModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.querySelectorAll('#invoiceForm input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateInvoiceTotal();
    }

    function updateInvoiceTotal() {
        let total = 0;
        document.querySelectorAll('#invoiceForm input[type="checkbox"]:checked').forEach(checkbox => {
            const price = parseFloat(checkbox.dataset.price);
            const quantity = parseInt(checkbox.dataset.quantity);
            total += price * quantity;
        });
        document.getElementById('invoiceTotal').textContent = '$' + total.toFixed(2);
    }

    function submitInvoice() {
        const checkboxes = document.querySelectorAll('#invoiceForm input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one service to invoice.');
            return;
        }

        const serviceIds = Array.from(checkboxes).map(cb => cb.value);
        const csrfToken = document.querySelector('#invoiceForm input[name="csrfmiddlewaretoken"]').value;

        fetch("{% url 'morgue:create_deceased_invoice' deceased.pk %}", {
            method: 'POST',
            body: JSON.stringify({ service_ids: serviceIds }),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
            });
    }
    {% endif %}

    // Shared outside click handler
    window.onclick = function (event) {
        const serviceModal = document.getElementById('serviceModal');
        const invoiceModal = document.getElementById('invoiceModal');
        if (event.target == serviceModal) closeServiceModal();
        if (event.target == invoiceModal) closeInvoiceModal();
    }
    </script>
{% endblock %}
