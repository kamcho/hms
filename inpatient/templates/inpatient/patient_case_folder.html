{% extends 'users/dashboard_base.html' %}
{% load static %}
{% block title %}{{ admission.patient.full_name }} - Clinical Case Folder{% endblock %}
{% block content %}
    <div class="px-8 py-6 max-w-[1600px] mx-auto">
        <!-- Breadcrumbs/Back Navigation -->
        <div class="mb-8">
            <a href="{% url 'inpatient:dashboard' %}" class="inline-flex items-center text-[11px] font-black uppercase tracking-widest text-slate-400 hover:text-indigo-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> Back to Inpatient Dashboard
            </a>
        </div>
        <!-- Unified Clinical Dashboard Header (clean white theme) -->
        <div class="bg-white rounded-[32px] shadow-2xl shadow-indigo-500/10 border border-slate-100 p-8 mb-8 relative overflow-hidden group">
            <!-- Subtle background accent -->
            <div class="absolute top-0 right-0 w-[480px] h-[480px] bg-gradient-to-br from-indigo-50 to-slate-50 rounded-full -mr-24 -mt-24 blur-3xl opacity-60 pointer-events-none"></div>

            <div class="relative z-10">
                <div class="flex flex-col xl:flex-row gap-10">
                    <!-- Column 1: Identity & Demographics -->
                    <div class="xl:w-1/3 flex flex-col gap-6 pr-6 xl:border-r border-slate-100">
                        <!-- Patient identity -->
                        <div class="flex items-start gap-5">
                            <div class="relative shrink-0">
                                <div class="w-20 h-20 rounded-[28px] bg-slate-900 flex items-center justify-center text-white text-2xl font-black shadow-xl shadow-slate-200">
                                    {{ admission.patient.first_name|first|upper }}{{ admission.patient.last_name|first|upper }}
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-7 h-7 rounded-lg bg-emerald-500 border-4 border-white flex items-center justify-center text-white text-[9px] font-black shadow-lg">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            <div>
                                <h1 class="text-2xl font-black text-slate-900 tracking-tight leading-none mb-1">{{ admission.patient.full_name }}</h1>
                                <div class="flex flex-wrap items-center gap-2 mb-1">
                                    <span class="px-2.5 py-1 bg-indigo-100 text-indigo-700 text-[9px] font-black rounded-lg uppercase tracking-wider">
                                        ADM-{{ admission.id }}
                                    </span>
                                    <span class="px-2.5 py-1 bg-slate-900 text-white text-[9px] font-black rounded-lg uppercase tracking-wider">
                                        #PAT-{{ admission.patient.id|stringformat:"05d" }}
                                    </span>
                                </div>
                                <div class="flex flex-wrap items-center gap-3 text-[10px] text-slate-500 font-semibold">
                                    <span class="inline-flex items-center gap-1">
                                        <i class="fas fa-user-circle text-slate-400"></i>
                                        {{ admission.patient.age }} yrs • {{ admission.patient.get_gender_display }}
                                    </span>
                                    <span class="inline-flex items-center gap-1">
                                        <i class="fas fa-clock text-slate-400"></i>
                                        Admitted {{ admission.admitted_at|date:"M d, Y H:i" }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- Location & Admission context -->
                            <div class="bg-slate-50/80 rounded-2xl p-4 border border-slate-100 hover:border-indigo-200 transition-colors">
                                <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center justify-between">
                                    <span>Current Ward / Bed</span>
                                    <i class="fas fa-bed text-indigo-500"></i>
                                </div>
                                <div class="text-sm font-black text-slate-900 leading-tight">
                                    {% if admission.bed %}
                                        {{ admission.bed.ward.name }} <span class="mx-1 opacity-20">•</span> Bed {{ admission.bed.bed_number }}
                                    {% else %}
                                        Not currently assigned to a bed
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Demographics quick grid -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-white rounded-xl p-3 border border-slate-100 flex flex-col gap-1 shadow-sm">
                                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Age / Gender</span>
                                    <span class="text-[11px] font-black text-slate-700 uppercase">
                                        {{ admission.patient.age }}Y
                                        <span class="text-slate-300 mx-0.5">/</span>
                                        {{ admission.patient.get_gender_display }}
                                    </span>
                                </div>
                                <div class="bg-white rounded-xl p-3 border border-slate-100 flex flex-col gap-1 shadow-sm">
                                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Blood Group</span>
                                    <span class="text-[11px] font-black text-rose-600 uppercase">
                                        {{ admission.patient.blood_group|default:"Unknown" }}
                                    </span>
                                </div>
                                <div class="bg-white rounded-xl p-3 border border-slate-100 flex flex-col gap-1 shadow-sm col-span-2">
                                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Contact & Location</span>
                                    <div class="flex flex-wrap items-center gap-3 text-[11px] font-semibold text-slate-600">
                                        <span class="inline-flex items-center gap-1">
                                            <i class="fas fa-phone-alt text-slate-400"></i>
                                            {{ admission.patient.phone|default:"No phone on file" }}
                                        </span>
                                        <span class="inline-flex items-center gap-1">
                                            <i class="fas fa-map-marker-alt text-slate-400"></i>
                                            {{ admission.patient.location|default:"Location not set" }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Provisional diagnosis -->
                            <div class="bg-indigo-900 rounded-2xl p-4 text-white relative overflow-hidden group/diag">
                                <div class="absolute inset-0 bg-gradient-to-r from-indigo-900 to-indigo-800 opacity-90"></div>
                                <div class="relative z-10">
                                    <div class="text-[8px] font-black text-indigo-300 uppercase tracking-widest mb-1 flex items-center gap-1">
                                        <i class="fas fa-stethoscope"></i> Provisional DX
                                    </div>
                                    <div class="text-[11px] font-bold leading-tight line-clamp-2">
                                        {{ admission.provisional_diagnosis|default:"Pending Assessment" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Live Vitals Snapshot -->
                    <div class="xl:w-[40%] flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest">Clinical Vitals Snapshot</h3>
                                {% if latest_vitals %}
                                    <p class="text-[9px] font-bold text-slate-400 uppercase mt-1">
                                        Last recorded {{ latest_vitals.recorded_at|timesince }} ago
                                    </p>
                                {% else %}
                                    <p class="text-[9px] font-bold text-amber-500 uppercase mt-1">
                                        No vitals have been recorded for this admission yet
                                    </p>
                                {% endif %}
                            </div>
                            {% if admission.status != 'Discharged' %}
                                <button onclick="showModal('vitalsModal')" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-emerald-600 transition-all flex items-center gap-2 shadow-lg shadow-slate-200">
                                    <i class="fas fa-plus-circle text-emerald-400"></i> Log Vitals
                                </button>
                            {% endif %}
                        </div>

                        <div class="grid grid-cols-2 gap-5 flex-1">
                            <!-- Pulse Rate Card -->
                            <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm relative overflow-hidden group/vital hover:shadow-xl hover:shadow-indigo-500/5 transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center text-lg">
                                        <i class="fas fa-heartbeat animate-pulse"></i>
                                    </div>
                                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Pulse Rate</span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-4xl font-black text-slate-900 tracking-tighter">{{ latest_vitals.pulse_rate|default:"--" }}</span>
                                    <span class="text-xs font-bold text-slate-400 uppercase">bpm</span>
                                </div>
                                <div class="mt-4 h-1 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-rose-500 w-[70%]" style="width: {% if latest_vitals.pulse_rate %}{{ latest_vitals.pulse_rate }}%{% else %}0%{% endif %}; max-width: 100%;"></div>
                                </div>
                            </div>

                            <!-- BP Card -->
                            <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm relative overflow-hidden group/vital hover:shadow-xl hover:shadow-indigo-500/5 transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center text-lg">
                                        <i class="fas fa-gauge-high"></i>
                                    </div>
                                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Sys/Dia BP</span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-4xl font-black text-slate-900 tracking-tighter">{{ latest_vitals.systolic_bp|default:"-" }}/{{ latest_vitals.diastolic_bp|default:"-" }}</span>
                                    <span class="text-xs font-bold text-slate-400 uppercase">mmHg</span>
                                </div>
                                <div class="mt-4 text-[9px] font-bold {% if latest_vitals.systolic_bp > 140 %}text-rose-500{% else %}text-emerald-500{% endif %} flex items-center gap-1">
                                    <i class="fas fa-circle text-[6px]"></i> {% if latest_vitals.systolic_bp > 140 %}Elevated Reading{% else %}Stable Pressure{% endif %}
                                </div>
                            </div>

                            <!-- SpO2 Card -->
                            <div class="bg-emerald-50/50 rounded-3xl p-6 border border-emerald-100 shadow-sm relative overflow-hidden group/vital hover:shadow-xl hover:shadow-emerald-500/5 transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-white text-emerald-500 flex items-center justify-center text-lg shadow-sm">
                                        <i class="fas fa-wind"></i>
                                    </div>
                                    <span class="text-[8px] font-black text-emerald-900/40 uppercase tracking-widest">Oxygen Content</span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-4xl font-black text-emerald-900 tracking-tighter">{{ latest_vitals.spo2|default:"--" }}</span>
                                    <span class="text-xs font-bold text-emerald-500 uppercase">% SpO2</span>
                                </div>
                                <div class="mt-4 h-1 w-full bg-emerald-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-600" style="width: {{ latest_vitals.spo2|default:0 }}%;"></div>
                                </div>
                            </div>

                            <!-- Temperature Card -->
                            <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm relative overflow-hidden group/vital hover:shadow-xl hover:shadow-indigo-500/5 transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-amber-50 text-amber-500 flex items-center justify-center text-lg">
                                        <i class="fas fa-thermometer-half"></i>
                                    </div>
                                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Temperature</span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-4xl font-black text-slate-900 tracking-tighter">{{ latest_vitals.temperature|default:"--" }}</span>
                                    <span class="text-xs font-bold text-amber-500 uppercase">°C Core</span>
                                </div>
                                <div class="mt-4 text-[9px] font-bold text-slate-400 uppercase tracking-widest flex justify-between">
                                    <span>Norm: 36.5 - 37.5</span>
                                    <i class="fas fa-sync animate-spin-slow"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 3: Visual Audit & Actions (30%) -->
                    <div class="xl:w-[30%] flex flex-col gap-6 pl-6 xl:border-l border-slate-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Clinical Trends</h3>
                            <button class="w-8 h-8 rounded-lg bg-slate-50 border border-slate-100 text-slate-400 flex items-center justify-center hover:bg-slate-900 hover:text-white transition-all shadow-sm">
                                <i class="fas fa-expand-alt text-[10px]"></i>
                            </button>
                        </div>

                        <!-- Chart Area -->
                        <div class="flex-1 min-h-[140px] bg-slate-900 rounded-[32px] p-4 relative overflow-hidden shadow-2xl shadow-indigo-500/10">
                            <div class="absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
                            <div class="w-full h-full relative" style="opacity: 0.9;">
                                <canvas id="vitalsChart"></canvas>
                            </div>
                        </div>

                        <!-- Main Primary Actions -->
                        <div class="grid grid-cols-2 gap-3 mt-auto">
                            {% if admission.status != 'Discharged' %}
                                <button onclick="showModal('transferModal')" class="px-4 py-3 bg-white border border-slate-200 text-slate-700 rounded-2xl text-[9px] font-black uppercase tracking-widest hover:border-indigo-600 hover:text-indigo-600 transition-all flex items-center justify-center gap-2 shadow-sm">
                                    <i class="fas fa-bed"></i> Transfer
                                </button>
                                <a href="{% url 'home:refer_patient' admission.visit.id %}" class="px-4 py-3 bg-white border border-slate-200 text-slate-700 rounded-2xl text-[9px] font-black uppercase tracking-widest hover:border-purple-600 hover:text-purple-600 transition-all flex items-center justify-center gap-2 shadow-sm">
                                    <i class="fas fa-hospital"></i> Refer
                                </a>
                                {% if invoice_is_paid %}
                                    <button onclick="showModal('dischargeModal')" class="col-span-2 py-4 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-emerald-600 shadow-xl shadow-slate-200 transition-all flex items-center justify-center gap-2 transform active:scale-95">
                                        <i class="fas fa-sign-out-alt"></i> Discharge Clinical Record
                                    </button>
                                {% else %}
                                    <div class="col-span-2 py-4 bg-slate-100 text-slate-400 border border-slate-200 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 cursor-not-allowed opacity-80" title="Invoice must be paid before discharge">
                                        <i class="fas fa-lock"></i> Discharge Locked (Unpaid)
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="col-span-2 py-4 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2">
                                    <i class="fas fa-check-circle"></i> Case Permanently Closed
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Workspace -->
        <div class="space-y-8">
            <!-- Full Width: Clinical Tabs & Workspace -->
            <div class="w-full space-y-8">
                <!-- Premium Case Console Navigation -->
                <div class="bg-white rounded-[32px] shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden min-h-[850px] flex flex-col">
                    <div class="px-8 py-5 bg-slate-50 border-b border-slate-100">
                        <div class="flex items-center gap-2 p-1.5 bg-slate-200/50 rounded-[20px] w-max max-w-full overflow-x-auto no-scrollbar shadow-inner">
                            <button onclick="showClinicalTab('notes')" id="tab-btn-notes" class="clinical-tab active px-6 py-2.5 rounded-[14px] text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all duration-300">
                                <i class="fas fa-notes-medical mr-2 text-indigo-500"></i> Clinical Notes
                            </button>
                            <button onclick="showClinicalTab('medications')" id="tab-btn-medications" class="clinical-tab px-6 py-2.5 rounded-[14px] text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all duration-300">
                                <i class="fas fa-pills mr-2 text-purple-500"></i> Treatment Chart
                            </button>
                            <button onclick="showClinicalTab('consumables')" id="tab-btn-consumables" class="clinical-tab px-6 py-2.5 rounded-[14px] text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all duration-300">
                                <i class="fas fa-box-open mr-2 text-blue-500"></i> Billing / Consumables
                            </button>
                            <button onclick="showClinicalTab('investigations')" id="tab-btn-investigations" class="clinical-tab px-6 py-2.5 rounded-[14px] text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all duration-300 border-none">
                                <i class="fas fa-microscope mr-2 text-emerald-500"></i> Diagnostics
                            </button>
                            <button onclick="showClinicalTab('nutrition')" id="tab-btn-nutrition" class="clinical-tab px-6 py-2.5 rounded-[14px] text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all duration-300">
                                <i class="fas fa-utensils mr-2 text-orange-500"></i> Nutrition
                            </button>
                            <button onclick="showClinicalTab('timeline')" id="tab-btn-timeline" class="clinical-tab px-6 py-2.5 rounded-[14px] text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all duration-300">
                                <i class="fas fa-history mr-2 text-slate-500"></i> Timeline
                            </button>
                        </div>
                    </div>
                    <div class="p-8">
                        <!-- Clinical Notes Tab Content -->
                        <div id="clinical-notes" class="clinical-pane active space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-500">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                                <div>
                                    <h4 class="text-xl font-black text-slate-900 tracking-tight">Progress Notes</h4>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Clinical Documentation Timeline</p>
                                </div>
                                {% if user.role in 'Doctor,Nurse' and admission.status != 'Discharged' %}
                                    <button onclick="showModal('noteModal')" class="flex items-center gap-2 px-5 py-2.5 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 transition-all shadow-xl shadow-slate-200 transform active:scale-95">
                                        <i class="fas fa-plus-circle text-indigo-400"></i> New Entry
                                    </button>
                                {% endif %}
                            </div>
                            
                            <div class="space-y-8 relative pl-10 pt-4">
                                <div class="absolute left-3 top-0 bottom-0 w-1 bg-gradient-to-b from-indigo-500/20 via-slate-100 to-transparent rounded-full"></div>
                                {% for note in notes %}
                                    <div class="relative bg-white rounded-[24px] p-8 border border-slate-100/80 shadow-sm hover:shadow-md transition-all hover:border-indigo-100 group">
                                        <!-- Glowing Timeline Node -->
                                        <div class="absolute -left-[39px] top-10 w-4.5 h-4.5 rounded-full bg-white border-4 border-indigo-600 shadow-[0_0_10px_rgba(79,70,229,0.3)] z-10 transition-all group-hover:scale-125 group-hover:shadow-[0_0_15px_rgba(79,70,229,0.5)]"></div>
                                        
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 pb-6 border-b border-slate-50">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600 shrink-0 text-lg shadow-inner">
                                                    {% if note.note_type == 'Progress' %}
                                                        <i class="fas fa-chart-line"></i>
                                                    {% elif note.note_type == 'Doctor' %}
                                                        <i class="fas fa-user-md"></i>
                                                    {% else %}
                                                        <i class="fas fa-user-nurse"></i>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <div class="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-0.5">{{ note.get_note_type_display|upper }} ENTRY</div>
                                                    <div class="text-xs font-bold text-slate-400 tracking-tight">{{ note.created_at|date:"l, d M Y" }} <span class="mx-1 opacity-30">•</span> {{ note.created_at|date:"H:i" }}</div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-3 px-4 py-2 bg-slate-50 rounded-xl border border-slate-100/50">
                                                <div class="w-7 h-7 rounded-lg bg-slate-900 border border-slate-700 flex items-center justify-center text-[10px] text-white font-black shadow-sm">
                                                    {{ note.created_by.last_name|first|upper }}
                                                </div>
                                                <span class="text-[11px] font-black text-slate-700 uppercase tracking-widest">DR. {{ note.created_by.last_name|upper|default:"SYSTEM" }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="text-sm text-slate-600 leading-relaxed font-semibold whitespace-pre-line tracking-tight bg-slate-50/30 p-4 rounded-xl">
                                            {{ note.content }}
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="py-24 flex flex-col items-center justify-center text-center">
                                        <div class="w-24 h-24 rounded-[32px] bg-slate-50 flex items-center justify-center text-slate-200 mb-6 shadow-inner">
                                            <i class="fas fa-clipboard-list text-4xl"></i>
                                        </div>
                                        <h5 class="text-sm font-black text-slate-900 uppercase tracking-widest mb-1">Timeline is empty</h5>
                                        <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">No clinical notes recorded for this admission.</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- Medications Tab Content -->
                        <div id="clinical-medications" class="clinical-pane space-y-6" style="display: none;">
                            <div class="flex justify-between items-center mb-8">
                                <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest border-l-4 border-purple-500 pl-4">Treatment Card (Active meds)</h4>
                                {% if user.role == 'Doctor' and admission.status != 'Discharged' %}
                                    <button onclick="showMedicationModal()" class="px-4 py-2 bg-purple-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-purple-100 hover:bg-purple-700 transition-all inline-flex items-center">
                                        <i class="fas fa-pills mr-2"></i> Prescribe
                                    </button>
                                {% endif %}
                            </div>
                            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
                                <div class="overflow-x-auto no-scrollbar">
                                    <table class="w-full text-left border-collapse whitespace-nowrap min-w-[1000px]">
                                        <thead>
                                            <tr class="bg-slate-50 text-[10px] font-black text-slate-700 uppercase tracking-widest text-center border-b border-slate-200">
                                                <th class="p-3 border-r border-slate-200 text-left sticky left-0 bg-slate-50 z-10 w-48">Drug Name</th>
                                                <th class="p-3 border-r border-slate-200 w-16">Dose</th>
                                                <th class="p-3 border-r border-slate-200 w-24">Frequency</th>
                                                <th class="p-3 border-r border-slate-200 w-20">Duration</th>
                                                <th class="p-3 border-r border-slate-200 w-32">Prescribed</th>
                                                <th class="p-0 text-left bg-slate-50 align-top">
                                                    <div class="p-3 border-b border-slate-200 text-center w-full block">TREATMENT CHART (ADMINISTRATION SCHEDULE)</div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-200">
                                        {% for med in medications %}
                                            <tr class="group hover:bg-slate-50/30 transition-all">
                                                <!-- Drug Name -->
                                                <td class="p-3 border-r border-slate-200 sticky left-0 bg-white group-hover:bg-slate-50/90 z-10 align-middle">
                                                    <div class="font-bold text-slate-900 text-xs w-48 whitespace-normal leading-tight caps">{{ med.item.name }}</div>
                                                    {% if med.instructions %}
                                                        <div class="text-[9px] text-amber-600 mt-1 flex items-start gap-1 whitespace-normal leading-tight" title="{{ med.instructions }}">
                                                            <i class="fas fa-info-circle mt-0.5"></i> <span class="line-clamp-2">{{ med.instructions }}</span>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <!-- Dose -->
                                                <td class="p-3 border-r border-slate-200 text-center text-xs font-semibold text-slate-700 align-middle">
                                                    {{ med.dose_count }}
                                                </td>
                                                <!-- Frequency -->
                                                <td class="p-3 border-r border-slate-200 text-center text-xs font-semibold text-slate-700 align-middle">
                                                    {{ med.frequency }}
                                                </td>
                                                <!-- Duration -->
                                                <td class="p-3 border-r border-slate-200 text-center text-xs font-semibold text-slate-700 align-middle">
                                                    {{ med.duration_days }} Days
                                                </td>
                                                <!-- Prescribed -->
                                                <td class="p-3 border-r border-slate-200 text-center align-middle">
                                                    <div class="text-[10px] font-bold text-slate-800">{{ med.prescribed_at|date:"d/m/y H:i" }}</div>
                                                    <div class="text-[9px] text-slate-500 uppercase mt-0.5">Dr. {{ med.prescribed_by.last_name }}</div>
                                                </td>
                                                <!-- Administration Grid -->
                                                <td class="p-0 align-middle bg-slate-50/30 h-full">
                                                    {% if med.administration_records.exists %}
                                                        <div class="flex h-full w-max min-w-full">
                                                            {% regroup med.administration_records.all by day_number as days_list %}
                                                            {% for day in days_list %}
                                                                <div class="flex flex-col border-r border-slate-200 last:border-r-0">
                                                                    <div class="bg-indigo-50/80 text-[9px] font-black text-center py-1 border-b border-slate-200 uppercase tracking-widest text-indigo-900">
                                                                        DAY {{ day.grouper }}
                                                                    </div>
                                                                    <div class="flex flex-1 h-full">
                                                                        {% for record in day.list %}
                                                                            <div class="flex flex-col items-center justify-between border-r border-slate-100 last:border-r-0 p-1 min-w-[50px] transition-colors relative group/dose hover:bg-slate-100/80 h-full">
                                                                                <!-- Dose header mimicking time 9am, 3pm etc but generic D1, D2 -->
                                                                                <div class="text-[8px] font-black text-slate-400 mb-1 w-full text-center pb-0.5 border-b border-slate-100/50">D{{ record.dose_number }}</div>
                                                                                
                                                                                <!-- Action / Status -->
                                                                                <div class="py-1 flex flex-col items-center justify-center flex-1 w-full">
                                                                                    {% if record.status == 'Administered' %}
                                                                                        <i class="fas fa-check text-emerald-500 text-[12px] mb-0.5"></i>
                                                                                        <span class="text-[8px] text-emerald-700 font-bold tracking-tighter">{{ record.administered_at|date:"H:i" }}</span>
                                                                                        <!-- Tooltip -->
                                                                                        <div class="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-slate-800 hidden group-hover/dose:flex items-center justify-center z-20 rounded shadow-lg p-2 pointer-events-none before:content-[''] before:absolute before:-top-1 before:left-1/2 before:-translate-x-1/2 before:border-4 before:border-transparent before:border-b-slate-800 min-w-max">
                                                                                            <span class="text-[9px] font-bold text-white uppercase text-center leading-tight">Administered By<br>{{ record.administered_by.last_name|default:record.administered_by.username }}</span>
                                                                                        </div>
                                                                                    {% elif record.status == 'Missed' %}
                                                                                        <i class="fas fa-times text-rose-500 text-[12px] mb-0.5"></i>
                                                                                        <span class="text-[7px] text-rose-600 font-bold tracking-tighter uppercase">Missed</span>
                                                                                    {% else %}
                                                                                        {% if user.role == 'Nurse' and admission.status != 'Discharged' %}
                                                                                            <a href="{% url 'inpatient:administer_medication' record.id %}" class="w-7 h-7 rounded-full bg-white border border-slate-200 text-slate-300 hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 hover:shadow-sm flex items-center justify-center transition-all cursor-pointer" title="Record Administration">
                                                                                                <i class="fas fa-syringe text-[10px]"></i>
                                                                                            </a>
                                                                                        {% else %}
                                                                                            <i class="fas fa-minus text-slate-200 text-[10px]"></i>
                                                                                        {% endif %}
                                                                                    {% endif %}
                                                                                </div>
                                                                            </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% else %}
                                                         <div class="p-3 w-full h-full flex items-center justify-center">
                                                            {% if not med.is_administered and user.role == 'Nurse' and admission.status != 'Discharged' %}
                                                                <a href="{% url 'inpatient:administer_medication' med.id %}" class="inline-block py-1.5 px-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-[9px] font-black uppercase tracking-widest shadow-sm transition-all whitespace-nowrap">
                                                                    <i class="fas fa-syringe mr-1"></i> Record Legacy Admin
                                                                </a>
                                                            {% else %}
                                                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Legacy Chart / No Grid</span>
                                                            {% endif %}
                                                         </div>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="6" class="p-10 text-center">
                                                    <i class="fas fa-notes-medical text-4xl text-slate-200 mb-4 block"></i>
                                                    <p class="font-black text-slate-400 uppercase tracking-widest text-sm">No Treatment Chart Available</p>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <style>
                                .no-scrollbar::-webkit-scrollbar { display: none; }
                                .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
                                
                                .clinical-tab.active {
                                    background: white !important;
                                    color: #0f172a !important; /* slate-900 */
                                    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                                }
                                .clinical-tab:not(.active) {
                                    color: #64748b; /* slate-500 */
                                    opacity: 0.7;
                                }
                                .clinical-tab:not(.active):hover {
                                    opacity: 1;
                                    background: rgba(255,255,255,0.4);
                                }
                            </style>
                        </div>
                        <!-- Consumables Tab Content -->
                        <div id="clinical-consumables" class="clinical-pane space-y-6" style="display: none;">
                            {% if admission.status != 'Discharged' %}
                                {% include 'inventory/partials/dispense_widget.html' with patient=admission.patient visit=admission.visit allowed_departments="Mini Pharmacy,Pharmacy" %}
                            {% else %}
                                <div class="py-20 flex flex-col items-center justify-center text-center opacity-40">
                                    <i class="fas fa-lock text-6xl text-slate-200 mb-6"></i>
                                    <p class="font-black text-slate-400 uppercase tracking-widest">
                                        Case Folder closed for
                                        dispensing
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                        <!-- Fluid Balance Tab Content -->
                        <!-- Fluid Balance Tab Content -->
                        <div id="clinical-fluids" class="clinical-pane space-y-8 animate-in fade-in duration-500" style="display: none;">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div>
                                    <h4 class="text-xl font-black text-slate-900 tracking-tight">Intake & Output</h4>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Daily Hydration Monitoring</p>
                                </div>
                                {% if admission.status != 'Discharged' %}
                                    <button onclick="showModal('fluidModal')" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all transform active:scale-95">
                                        <i class="fas fa-plus-circle text-blue-200"></i> Record Event
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Fluid Trend Summary -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50/30 rounded-[32px] p-8 border border-blue-100 flex flex-col items-center justify-center relative overflow-hidden group">
                                    <div class="absolute -right-4 -bottom-4 opacity-10 group-hover:scale-110 transition-transform duration-500 pointer-events-none">
                                        <i class="fas fa-faucet-drip text-9xl text-blue-200"></i>
                                    </div>
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center text-blue-500 shadow-sm mb-4">
                                        <i class="fas fa-plus text-lg"></i>
                                    </div>
                                    <div class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1">Total Intake</div>
                                    <div class="flex items-baseline gap-2 pb-2">
                                        <span class="text-4xl font-black text-blue-900 tracking-tighter">{{ fluid_intake|default:"0" }}</span>
                                        <span class="text-lg font-bold text-blue-400">mL</span>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-rose-50 to-orange-50/30 rounded-[32px] p-8 border border-rose-100 flex flex-col items-center justify-center relative overflow-hidden group">
                                    <div class="absolute -right-4 -bottom-4 opacity-10 group-hover:scale-110 transition-transform duration-500 pointer-events-none">
                                        <i class="fas fa-tint-slash text-9xl text-rose-200"></i>
                                    </div>
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center text-rose-500 shadow-sm mb-4">
                                        <i class="fas fa-minus text-lg"></i>
                                    </div>
                                    <div class="text-[10px] font-black text-rose-600 uppercase tracking-widest mb-1">Total Output</div>
                                    <div class="flex items-baseline gap-2 pb-2">
                                        <span class="text-4xl font-black text-rose-900 tracking-tighter">{{ fluid_output|default:"0" }}</span>
                                        <span class="text-lg font-bold text-rose-400">mL</span>
                                    </div>
                                </div>

                                <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[32px] p-8 border border-slate-700 flex flex-col items-center justify-center col-span-1 md:col-span-2 lg:col-span-1 shadow-2xl shadow-slate-200">
                                    <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Net Fluid Balance</div>
                                    <div class="flex items-baseline gap-2">
                                        <span class="text-4xl font-black text-white tracking-tighter">{{ fluid_intake|default:0|add:0 }}</span>
                                        <span class="text-lg font-bold text-slate-500">mL</span>
                                    </div>
                                    <div class="mt-4 w-full h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-500 w-[65%]"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-[24px] border border-slate-100 overflow-hidden shadow-sm">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-slate-50">
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Type</th>
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Description</th>
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Volume</th>
                                            <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        {% for fluid in admission.fluid_balances.all|slice:":10" %}
                                            <tr class="hover:bg-slate-50 transition-colors">
                                                <td class="px-8 py-4">
                                                    <span class="px-2 py-0.5 {% if fluid.fluid_type == 'Intake' %}bg-blue-100 text-blue-700{% else %}bg-rose-100 text-rose-700{% endif %} text-[9px] font-black rounded-lg uppercase">{{ fluid.fluid_type }}</span>
                                                </td>
                                                <td class="px-8 py-4 text-sm font-bold text-slate-700">{{ fluid.item }}</td>
                                                <td class="px-8 py-4 text-sm font-black text-slate-900">{{ fluid.amount_ml }} mL</td>
                                                <td class="px-8 py-4 text-right text-[10px] font-bold text-slate-400 uppercase">{{ fluid.recorded_at|date:"H:i" }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="4" class="px-8 py-10 text-center text-[10px] font-black uppercase text-slate-300 tracking-widest">No hydrological records</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                     
                         <!-- Nutrition Tab Content -->
                        <div id="clinical-nutrition" class="clinical-pane animate-in fade-in duration-500" style="display: none;">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-10">
                                <div>
                                    <h4 class="text-xl font-black text-slate-900 tracking-tight">Nutrition Services</h4>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Prescribed Diet and Culinary Orders</p>
                                </div>
                                {% if user.role in 'Doctor,Nurse' and admission.status != 'Discharged' %}
                                    <button onclick="showModal('nutritionModal')" class="flex items-center gap-2 px-6 py-3 bg-orange-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-700 shadow-xl shadow-orange-100 transition-all transform active:scale-95">
                                        <i class="fas fa-edit text-orange-200"></i> Update Prescription
                                    </button>
                                {% endif %}
                            </div>

                            {% if current_nutrition %}
                                <div class="bg-white border-2 border-orange-100 rounded-[40px] p-10 mb-10 relative overflow-hidden flex flex-col items-center text-center shadow-xl shadow-orange-100/30">
                                    <div class="absolute top-0 right-0 w-[400px] h-[400px] bg-orange-50/50 rounded-full -mr-32 -mt-32 blur-3xl opacity-50"></div>
                                    
                                    <div class="w-20 h-20 rounded-3xl bg-gradient-to-br from-orange-400 to-amber-600 flex items-center justify-center text-white text-3xl shadow-xl shadow-orange-200 mb-6 relative z-10">
                                        <i class="fas fa-utensils"></i>
                                    </div>

                                    <div class="relative z-10">
                                        <div class="text-[11px] font-black text-orange-500 uppercase tracking-[0.2em] mb-3">CURRENTLY PRESCRIBED DIET</div>
                                        <h2 class="text-4xl font-black text-slate-900 mb-6 tracking-tight leading-none group-hover:scale-105 transition-transform">
                                            {{ current_nutrition.get_diet_type_display }}
                                        </h2>
                                        
                                        <div class="max-w-xl mx-auto bg-slate-50/80 rounded-[28px] p-8 border border-slate-100">
                                            <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">SPECIFIC DIETARY INSTRUCTIONS</div>
                                            <p class="text-base font-bold text-slate-700 leading-relaxed italic">
                                                "{{ current_nutrition.specific_instructions|default:'No special instructions provided.' }}"
                                            </p>
                                        </div>

                                        <div class="mt-8 flex flex-col items-center gap-4">
                                            <div class="h-px w-24 bg-slate-100"></div>
                                            <div class="flex items-center gap-3 bg-white px-5 py-2 rounded-full border border-slate-100 shadow-sm">
                                                <div class="w-6 h-6 rounded-full bg-slate-900 flex items-center justify-center text-[9px] text-white font-black">
                                                    {{ current_nutrition.prescribed_by.last_name|first|upper }}
                                                </div>
                                                <div class="text-[10px] font-black text-slate-500 tracking-wider">
                                                    ORDERED BY <span class="text-slate-900">DR. {{ current_nutrition.prescribed_by.last_name|upper }}</span> <span class="mx-1 opacity-30">•</span> {{ current_nutrition.prescribed_at|date:"d M, H:i" }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="bg-slate-50 rounded-[32px] p-12 text-center border-2 border-dashed border-slate-200">
                                    <p class="font-black text-slate-400 uppercase tracking-widest">
                                        No specific diet prescribed
                                        yet
                                    </p>
                                    <p class="text-xs text-slate-400 mt-2">Default: General Ward Diet</p>
                                </div>
                            {% endif %}
                            <div class="mt-10">
                                <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">
                                    Nutrition
                                    History
                                </h5>
                                <div class="space-y-4">
                                    {% for order in nutrition_orders|slice:"1:" %}
                                        <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl">
                                            <div class="flex items-center gap-4">
                                                <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400">
                                                    <i class="fas fa-utensils"></i>
                                                </div>
                                                <div>
                                                    <div class="text-sm font-black text-slate-900">
                                                        {{ order.get_diet_type_display }}
                                                    </div>
                                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">{{ order.prescribed_at|date:"d M Y" }}</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-[10px] font-black text-slate-900 uppercase tracking-wider">
                                                    DR.
                                                    {{ order.prescribed_by.last_name|upper }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <!-- Procedures Tab Content -->
                        <!-- Procedures Tab Content -->
                        <div id="clinical-procedures" class="clinical-pane animate-in fade-in duration-500" style="display: none;">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                                <div>
                                    <h4 class="text-xl font-black text-slate-900 tracking-tight">Clinical Procedures</h4>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Interventions and Surgical Charges</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Left: Procedure Widget -->
                                <div class="lg:col-span-2">
                                    {% if admission.status != 'Discharged' %}
                                        <div class="bg-white rounded-[32px] border border-slate-100 p-8 shadow-sm">
                                            {% include 'accounts/partials/procedure_widget.html' %}
                                        </div>
                                    {% else %}
                                        <div class="py-24 flex flex-col items-center justify-center text-center bg-slate-50/50 rounded-[32px] border-2 border-dashed border-slate-200">
                                            <div class="w-16 h-16 rounded-2xl bg-white flex items-center justify-center text-slate-300 mb-6 shadow-sm">
                                                <i class="fas fa-lock text-2xl"></i>
                                            </div>
                                            <p class="font-black text-slate-400 uppercase tracking-widest text-xs">Folder Locked</p>
                                            <p class="text-[10px] text-slate-300 font-bold uppercase mt-1">No further procedures can be recorded</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- Right: Instructions/Info -->
                                <div class="space-y-6">
                                    <div class="bg-indigo-900 rounded-[32px] p-8 text-white relative overflow-hidden shadow-2xl shadow-indigo-200">
                                        <div class="absolute -right-8 -top-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                                        <h5 class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-indigo-300 mb-6">
                                            <i class="fas fa-info-circle"></i> Billing Guide
                                        </h5>
                                        <p class="text-xs font-bold leading-relaxed text-indigo-100/80">
                                            Procedures selected are immediately applied to the patient's active invoice. 
                                            <br><br>
                                            Please verify accurate clinical selection as reversing charges requires administrative clearance.
                                        </p>
                                        <div class="mt-8 pt-6 border-t border-white/10 flex items-center justify-between">
                                            <span class="text-[9px] font-black text-indigo-400 uppercase">Automated Billing</span>
                                            <i class="fas fa-shield-alt text-indigo-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Investigations Tab Content -->
                        <!-- Investigations Tab Content -->
                        <div id="clinical-investigations" class="clinical-pane animate-in fade-in duration-500" style="display: none;">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-10">
                                <div>
                                    <h4 class="text-xl font-black text-slate-900 tracking-tight">Diagnostics Hub</h4>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Laboratory and Imaging Dispatch</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                                <!-- Request Section -->
                                <div class="space-y-6">
                                    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] px-4">New Requisition</h5>
                                    {% if user.role in 'Doctor,Nurse' and admission.status != 'Discharged' %}
                                        <div class="bg-white rounded-[32px] border border-slate-100 p-8 shadow-sm">
                                            {% include 'home/partials/next_action_widget.html' with patient_id=admission.patient.pk %}
                                        </div>
                                    {% else %}
                                        <div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-[32px] p-20 text-center">
                                            <i class="fas fa-lock text-4xl text-slate-200 mb-4 block"></i>
                                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Requisition Restricted</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Recent Results -->
                                <div class="space-y-6">
                                   <div class="flex items-center justify-between px-4">
                                        <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Validated Results</h5>
                                        <span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-[8px] font-black rounded uppercase">Live Feed</span>
                                   </div>
                                    <div class="bg-slate-50/50 rounded-[32px] p-2 border border-slate-100">
                                        {% include 'lab/partials/lab_result_widget.html' with lab_results=lab_results %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Activity Log Tab Content -->
                    <div id="clinical-timeline" class="clinical-pane" style="display: none;">
                        <div class="flex justify-between items-center mb-10">
                            <h4 class="text-sm font-black text-slate-900 uppercase tracking-widest border-l-4 border-slate-900 pl-4">Full Clinical Activity Log</h4>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                Sorted by Most
                                Recent
                            </div>
                        </div>
                        <div class="space-y-8 relative pl-8">
                            <div class="absolute left-0 top-0 bottom-0 w-px bg-slate-100 ml-3.5"></div>
                            {% for log in activity_log %}
                                <div class="relative pl-6"> <!-- Container padding to separate text from icon -->
                                    <div class="absolute -left-9 top-4 w-9 h-9 rounded-xl bg-{{ log.color }}-50 text-{{ log.color }}-600 border border-{{ log.color }}-100 flex items-center justify-center shadow-sm z-10 transition-transform hover:scale-110">
                                        <i class="fas {{ log.icon }} text-xs"></i>
                                    </div>
                                    <div class="bg-white border border-slate-100 p-6 rounded-2xl hover:border-slate-300 transition-all group shadow-sm">
                                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-3"> <!-- Added flex layout for title/time -->
                                            <h5 class="text-xs font-black text-slate-900 uppercase tracking-widest leading-relaxed"> <!-- Added leading-relaxed -->
                                                {{ log.title}}
                                            </h5>
                                            <span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-1 rounded-lg shrink-0">{{ log.time|date:"H:i" }}</span> <!-- Added px-3 py-1 and shrink-0 -->
                                        </div>
                                        <p class="text-sm font-medium text-slate-600 mb-5 leading-relaxed group-hover:text-slate-900"> <!-- Added mb-5 and leading-relaxed -->
                                            {{ log.detail }}
                                        </p>
                                        <div class="flex flex-wrap items-center justify-between gap-3 pt-4 border-t border-slate-50"> <!-- Added flex-wrap, gap, and top border -->
                                            <div class="flex items-center gap-2">
                                                <i class="far fa-calendar-alt text-slate-300 text-[10px]"></i> <!-- Added Calendar Icon -->
                                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">{{ log.time|date:"d M Y" }}</span> <!-- Removed italic -->
                                            </div>
                                            <div class="text-[8px] font-black text-slate-500 uppercase tracking-widest bg-slate-50 border border-slate-100 px-3 py-1.5 rounded-lg flex items-center gap-1.5 shadow-sm"> <!-- Better styling for BY user tag -->
                                                <i class="fas fa-user-circle text-slate-400"></i>
                                                {{ log.user.username|upper|default:"SYSTEM" }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="py-20 flex flex-col items-center justify-center opacity-40">
                                    <i class="fas fa-history text-6xl text-slate-200 mb-6"></i>
                                    <p class="font-black text-slate-400 uppercase tracking-widest">
                                        Admission history
                                        starting...
                                    </p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modals Migration: Standard HMS Modal Styling -->
<style>
    .modal-content {
        border-radius: 32px !important;
        border: none !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
    }

    .modal-header {
        border-bottom: 1px solid #f1f5f9 !important;
        padding: 24px 32px !important;
    }

    .modal-footer {
        border-top: 1px solid #f1f5f9 !important;
        padding: 24px 32px !important;
    }

    .modal-body {
        padding: 32px !important;
    }

    .form-control {
        border-radius: 12px !important;
        border-color: #e2e8f0 !important;
        font-size: 14px !important;
        padding: 10px 16px !important;
        transition: all 0.2s;
    }

    .form-control:focus {
        border-color: #6366f1 !important;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
        outline: none !important;
    }

    .form-label {
        font-size: 11px !important;
        font-weight: 900 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
        color: #64748b !important;
        margin-bottom: 8px !important;
        display: block !important;
    }

    .clinical-tab {
        color: #94a3b8;
        border: 2px solid transparent;
    }

    .clinical-tab.active {
        color: #6366f1;
        background: #eef2ff;
        border-color: #e0e7ff;
    }

    .clinical-tab:hover:not(.active) {
        color: #64748b;
        background: #f8fafc;
    }

    @media print {
        .dashboard-container {
            display: block !important;
        }

        .sidebar,
        .top-bar,
        .flex,
        .btn,
        .clinical-tab,
        .no-print {
            display: none !important;
        }

        .patient-card {
            box-shadow: none !important;
            border: 1px solid #eee !important;
        }
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Tailwind safe-list for dynamic colors */
</style>
<!-- Placeholder for all Modals (Vitals, Notes, Discharge etc) with HMS styles applied -->
{% block modals %}
    <!-- Vitals Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="vitalsModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideModal('vitalsModal')"></div>
        <div class="relative z-10 w-full max-w-xl bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-emerald-50 border-b border-emerald-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-emerald-900 uppercase tracking-widest">Record Patient Vitals</h5>
                    <button type="button" onclick="hideModal('vitalsModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-emerald-400 hover:text-emerald-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_vitals' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="p-8 space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            {{ vitals_form.as_p }}
                        </div>
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100">
                        <button type="submit" class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-emerald-500/20 transition-all active:scale-[0.98]">
                            Save Vitals
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Note Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="noteModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideModal('noteModal')"></div>
        <div class="relative z-10 w-full max-w-lg bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-slate-900 uppercase tracking-widest">New Progress Note</h5>
                    <button type="button" onclick="hideModal('noteModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-slate-400 hover:text-slate-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_clinical_note' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="p-8 space-y-6">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Note Category</label>
                            {{ note_form.note_type }}
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Clinical Narrative</label>
                            {{ note_form.content }}
                        </div>
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100">
                        <button type="submit" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-indigo-500/20 transition-all active:scale-[0.98]">
                            Commit to Record
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Discharge Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="dischargeModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideModal('dischargeModal')"></div>
        <div class="relative z-10 w-full max-w-2xl bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-rose-50 border-b border-rose-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-rose-900 uppercase tracking-widest flex items-center gap-3">
                        <i class="fas fa-sign-out-alt"></i> Clinical Discharge Process
                    </h5>
                    <button type="button" onclick="hideModal('dischargeModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-rose-400 hover:text-rose-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:discharge_patient' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="p-8 space-y-6 bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Effective Date/Time</label>
                                <input type="datetime-local" name="discharged_at" class="form-control" required>
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Final Diagnosis</label>
                                <input type="text" name="final_diagnosis" class="form-control" placeholder="Primary reason for discharge" required>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Clinical Summary</label>
                            <textarea name="discharge_summary" class="form-control" rows="4" placeholder="Brief clinical course and condition at discharge..." required></textarea>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Post-Discharge Instructions</label>
                            <textarea name="discharge_instructions" class="form-control" rows="3" placeholder="Medications, follow-up clinic, etc."></textarea>
                        </div>
                        <div class="p-6 bg-rose-50 rounded-2xl border border-rose-100 flex gap-4">
                            <i class="fas fa-exclamation-circle text-rose-500 mt-1"></i>
                            <p class="text-[11px] font-bold text-rose-900 leading-relaxed uppercase tracking-tight">
                                Warning:
                                This will terminate the admission record and release the assigned bed ({{ admission.bed.bed_number }}). Final billing should be verified.
                            </p>
                        </div>
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100 flex gap-4">
                        <button type="button" onclick="hideModal('dischargeModal')" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all border border-transparent hover:border-slate-200 rounded-2xl">Cancel</button>
                        <button type="submit" class="flex-[2] py-4 bg-rose-600 hover:bg-rose-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-rose-500/20 transition-all active:scale-[0.98]">
                            Confirm Patient Discharge
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Other Modals (Medication, Fluid, Instruction, Transfer, Nutrition) - Simplified Redesign Tags -->
    <!-- Medication Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="medicationModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideMedicationModal()"></div>
        <!-- Modal panel -->
        <div class="relative z-10 w-full max-w-2xl bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-purple-50 border-b border-purple-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-purple-900 uppercase tracking-widest flex items-center gap-3">
                        <i class="fas fa-pills text-purple-500"></i> Prescribe Inpatient Medication
                    </h5>
                    <button type="button" onclick="hideMedicationModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-purple-400 hover:text-purple-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_medication' admission.id %}" method="POST" id="medChartForm">
                    {% csrf_token %}
                    <div class="p-8 bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Medication Search -->
                            <div class="md:col-span-2 relative">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Select Medication</label>
                                <div class="relative">
                                    <input type="text" id="med-search-input" placeholder="Search by name, generic or class..." class="form-control w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold focus:ring-4 focus:ring-purple-500/10 focus:border-purple-500 outline-none transition-all placeholder:text-slate-300" autocomplete="off">
                                    <i class="fas fa-search absolute right-5 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none"></i>
                                </div>
                                <div id="med-dropdown" class="hidden absolute z-50 w-full mt-2 bg-white border border-slate-100 rounded-2xl shadow-2xl max-h-[300px] overflow-y-auto p-2">
                                    <!-- Options populated via JS -->
                                </div>
                                <div class="hidden">{{ med_form.item }}</div>
                                <div id="whole-dispense-notice" class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-2xl flex gap-3 hidden">
                                    <i class="fas fa-bell text-amber-500 mt-0.5"></i>
                                    <p class="text-[11px] font-bold text-amber-900 leading-relaxed uppercase tracking-tight">Note: This medication is usually prescribed as a whole package.</p>
                                </div>
                            </div>

                            <!-- Dosage Info -->
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Units Per Dose</label>
                                {{ med_form.dose_count }}
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Frequency</label>
                                {{ med_form.frequency }}
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Duration (Days)</label>
                                {{ med_form.duration_days }}
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Total Quantity</label>
                                {{ med_form.quantity }}
                                <p class="text-[10px] text-slate-400 mt-2 font-medium">Accumulated units</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Instructions / Notes</label>
                                {{ med_form.instructions }}
                                <p class="text-[10px] text-slate-400 mt-2 font-medium">Special administration or patient-specific notes</p>
                            </div>
                        </div>
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100 flex gap-4">
                        <button type="button" onclick="hideMedicationModal()" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all border border-transparent hover:border-slate-200 rounded-2xl">
                            Cancel
                        </button>
                        <button type="submit" class="flex-[2] py-4 bg-purple-600 hover:bg-purple-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-purple-500/20 transition-all active:scale-[0.98]">
                            Confirm Prescription
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Fluid Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="fluidModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideModal('fluidModal')"></div>
        <div class="relative z-10 w-full max-w-lg bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-blue-900 uppercase tracking-widest">Hydrological Balance Entry</h5>
                    <button type="button" onclick="hideModal('fluidModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-blue-400 hover:text-blue-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_fluid' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="p-8 space-y-6">
                        {{ fluid_form.as_p }}
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100">
                        <button type="submit" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-blue-500/20 transition-all active:scale-[0.98]">
                            Record Fluid
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Instruction Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="instructionModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideModal('instructionModal')"></div>
        <div class="relative z-10 w-full max-w-lg bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-amber-50 border-b border-amber-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-amber-900 uppercase tracking-widest">New Clinical Instruction</h5>
                    <button type="button" onclick="hideModal('instructionModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-amber-400 hover:text-amber-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_doctor_instruction' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="p-8 space-y-6">
                        {{ instruction_form.as_p }}
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100">
                        <button type="submit" class="w-full py-4 bg-amber-600 hover:bg-amber-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-amber-500/20 transition-all active:scale-[0.98]">
                            Commit Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Nutrition Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="nutritionModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideModal('nutritionModal')"></div>
        <div class="relative z-10 w-full max-w-lg bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-orange-50 border-b border-orange-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-orange-900 uppercase tracking-widest">Dietary & Nutrition Order</h5>
                    <button type="button" onclick="hideModal('nutritionModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-orange-400 hover:text-orange-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:add_nutrition' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="p-8 space-y-6">
                        {{ nutrition_form.as_p }}
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100">
                        <button type="submit" class="w-full py-4 bg-orange-600 hover:bg-orange-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-orange-500/20 transition-all active:scale-[0.98]">
                            Update Nutrition Plan
                        </button>
                    </div>
                </form>
            </div>
    </div>
    <!-- Transfer Modal (Tailwind + Fail-safe Inline Styles) -->
    <div id="transferModal" style="display: none; position: fixed; inset: 0; z-index: 2147483647; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;" role="dialog" aria-modal="true">
        <div style="position: fixed; inset: 0; background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(8px);" aria-hidden="true" onclick="hideModal('transferModal')"></div>
        <div class="relative z-10 w-full max-w-lg bg-white rounded-[32px] text-left overflow-hidden shadow-2xl transform transition-all border border-slate-100">
                <div class="px-8 py-6 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                    <h5 class="text-sm font-black text-indigo-900 uppercase tracking-widest">Internal Ward Transfer</h5>
                    <button type="button" onclick="hideModal('transferModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white text-indigo-400 hover:text-indigo-600 transition-all shadow-sm">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <form action="{% url 'inpatient:transfer_patient' admission.id %}" method="POST">
                    {% csrf_token %}
                    <div class="p-8 space-y-6">
                        {{ transfer_form.as_p }}
                    </div>
                    <div class="px-8 py-6 bg-slate-50 border-t border-slate-100">
                        <button type="submit" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-indigo-500/20 transition-all active:scale-[0.98]">
                            Execute Transfer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    {{ vitals_data|default:"{}"|json_script:"vitals-data" }}
    {{ medical_tests_data|default:"[]"|json_script:"services-data" }}
    <script src="{% static 'users/vendor/chart.js/chart.min.js' %}"></script>
    <script>
    function showModal(id) {
        const modal = document.getElementById(id);
        modal.style.setProperty('display', 'flex', 'important');
        document.body.style.overflow = 'hidden';
    }

    function hideModal(id) {
        const modal = document.getElementById(id);
        modal.style.setProperty('display', 'none', 'important');
        document.body.style.overflow = '';
    }

    function showMedicationModal() {
        showModal('medicationModal');
    }

    function hideMedicationModal() {
        hideModal('medicationModal');
    }
    // Safe Metadata Injection
    const medMetadata = {{ med_metadata_json|default:"{}"|safe }};

    function showClinicalTab(tabName) {
        document.querySelectorAll('.clinical-pane').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.clinical-tab').forEach(t => t.classList.remove('active', 'text-slate-900', 'border-indigo-600'));
        document.querySelectorAll('.clinical-tab').forEach(t => t.classList.add('text-slate-400', 'border-transparent'));

        document.getElementById('clinical-' + tabName).style.display = 'block';
        const activeBtn = document.getElementById('tab-btn-' + tabName);
        activeBtn.classList.remove('text-slate-400', 'border-transparent');
        activeBtn.classList.add('active', 'text-slate-900', 'border-indigo-600');
    }

    // Auto-switch to tab from URL parameter on page load
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');

        if (activeTab) {
            // Valid tabs: notes, medications, fluids, instructions, investigations, nutrition, timeline
            const validTabs = ['notes', 'medications', 'fluids', 'investigations', 'nutrition', 'timeline'];
            if (validTabs.includes(activeTab)) {
                showClinicalTab(activeTab);
            }
        }

        // ==================== DYNAMIC BED LOADING ====================
        const wardSelect = document.getElementById('id_ward');
        const bedSelect = document.getElementById('id_to_bed');

        if (wardSelect && bedSelect) {
            // Style Django rendered fields
            wardSelect.classList.add('form-select', 'form-control');
            bedSelect.classList.add('form-select', 'form-control');

            wardSelect.addEventListener('change', function () {
                const wardId = this.value;
                bedSelect.innerHTML = '<option value="">Loading beds...</option>';

                if (wardId) {
                    fetch(`/inpatient/wards/${wardId}/available-beds/`)
                        .then(response => response.json())
                        .then(data => {
                            bedSelect.innerHTML = '<option value="" selected="">---------</option>';
                            if (data.beds.length > 0) {
                                data.beds.forEach(bed => {
                                    const option = document.createElement('option');
                                    option.value = bed.id;
                                    option.textContent = `${bed.bed_number} (${bed.bed_type})`;
                                    bedSelect.appendChild(option);
                                });
                            } else {
                                bedSelect.innerHTML = '<option value="">No beds available</option>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            bedSelect.innerHTML = '<option value="">Error loading beds</option>';
                        });
                } else {
                    bedSelect.innerHTML = '<option value="" selected="">---------</option>';
                }
            });
        }
    });



    document.addEventListener('DOMContentLoaded', function () {
        // ... previous vitals chart logic ...
        const vitalsDataEl = document.getElementById('vitals-data');
        const vitalsData = vitalsDataEl ? JSON.parse(vitalsDataEl.textContent) : {};

        const ctx = document.getElementById('vitalsChart');
        if (ctx && vitalsData.times && vitalsData.times.length > 0) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: vitalsData.times,
                    datasets: [
                        {
                            label: 'Pulse (bpm)',
                            data: vitalsData.pulse,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.05)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3
                        },
                        {
                            label: 'Systolic BP',
                            data: vitalsData.systolic,
                            borderColor: '#6366f1',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'SpO2 (%)',
                            data: vitalsData.spo2,
                            borderColor: '#10b981',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { display: false },
                        x: { display: false }
                    }
                }
            });
        }
    });

    // ==================== SEARCHABLE MEDICATION SELECT ====================
    const medSearchInput = document.getElementById('med-search-input');
    const medDropdown = document.getElementById('med-dropdown');
    const medSelect = document.querySelector('.medication-select');
    let medications = [];

    // Populate medications from the hidden select
    if (medSelect) {
        Array.from(medSelect.options).forEach(option => {
            if (option.value) {
                medications.push({
                    id: option.value,
                    name: option.textContent.trim()
                });
            }
        });
    }

    // Show dropdown with filtered results
    function showMedicationDropdown(searchTerm = '') {
        const filtered = medications.filter(med =>
            med.name.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (filtered.length === 0) {
            medDropdown.innerHTML = '<div class="px-4 py-3 text-sm text-slate-400 italic">No medications found</div>';
        } else {
            medDropdown.innerHTML = filtered.map(med => `
                <div class="med-option px-4 py-2 hover:bg-indigo-50 cursor-pointer text-sm transition-colors" data-id="${med.id}">
                    <div class="font-semibold text-slate-900">${med.name}</div>
                </div>
            `).join('');

            // Add click handlers to options
            medDropdown.querySelectorAll('.med-option').forEach(option => {
                option.addEventListener('click', function () {
                    const medId = this.dataset.id;
                    const medName = medications.find(m => m.id == medId).name;

                    // Update hidden select and search input
                    medSelect.value = medId;
                    medSearchInput.value = medName;
                    medDropdown.classList.add('hidden');

                    // Trigger change event for calculation
                    medSelect.dispatchEvent(new Event('change'));
                });
            });
        }

        medDropdown.classList.remove('hidden');
    }

    // Search input handlers
    if (medSearchInput) {
        medSearchInput.addEventListener('focus', function () {
            showMedicationDropdown(this.value);
        });

        medSearchInput.addEventListener('input', function () {
            showMedicationDropdown(this.value);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!medSearchInput.contains(e.target) && !medDropdown.contains(e.target)) {
                medDropdown.classList.add('hidden');
            }
        });
    }

    // ==================== SMART PRESCRIPTION CALCULATION ====================
    // medMetadata is already defined safely at top of script block

    // Get form elements
    const doseInput = document.querySelector('#{{ med_form.dose_count.id_for_label }}');
    const qtyInput = document.querySelector('#{{ med_form.quantity.id_for_label }}');
    const qtyHelp = document.getElementById('qty-help-text');
    const wholeNotice = document.getElementById('whole-dispense-notice');

    if (medSelect) {
        medSelect.addEventListener('change', function () {
            const medId = this.value;
            if (medId && medMetadata[medId] && medMetadata[medId].is_dispensed_as_whole) {
                wholeNotice.classList.remove('hidden');
            } else {
                wholeNotice.classList.add('hidden');
            }
        });
    }

    // No auto-calculation needed — quantity is manually entered (matching PrescriptionItem)

    // Form submission handler - convert "Full Dosage" back to 1
    const medForm = document.querySelector('#medicationModal form');
    if (medForm) {
        medForm.addEventListener('submit', function (e) {
            if (durInput && durInput.value === 'Full Dosage') {
                durInput.type = 'number';
                durInput.value = '1';
            }
        });
    }

    </script>
{% endblock %}
{% endblock %}
