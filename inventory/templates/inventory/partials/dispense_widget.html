<div class="bg-indigo-50/30 border border-indigo-100 rounded-[32px] p-8 mb-6">
    <h5 class="text-xs font-black text-indigo-900 uppercase tracking-widest mb-6 flex items-center gap-2">
        <i class="fas fa-syringe"></i> Dispense Consumables / Items
    </h5>
    <div id="dispenseContainer" class="space-y-6">
        <!-- Hidden Context Fields -->
        {% if patient %}
            <input type="hidden" id="dispense_patient_id" value="{{ patient.id }}">
        {% elif admission %}
            <input type="hidden" id="dispense_patient_id" value="{{ admission.patient.id }}">
        {% endif %}
        {% if visit %}
            <input type="hidden" id="dispense_visit_id" value="{{ visit.id }}">
        {% elif admission %}
            <input type="hidden" id="dispense_visit_id" value="{{ admission.visit.id|default:'' }}">
        {% endif %}
        
        {% csrf_token %}

        <!-- Department Selection -->
        <div class="mb-4">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">
                Dispense
                From
            </label>
            <div class="flex flex-wrap gap-2" id="department-options">
                {% for dept in dispensing_departments %}
                    {% if not allowed_departments or dept.name in allowed_departments %}
                        <label class="cursor-pointer relative">
                            <input type="radio" name="dispense_department" value="{{ dept.id }}" class="peer sr-only" {% if dept.name == 'Pharmacy' %}checked{% endif %}>
                            <div class="px-4 py-2 rounded-lg border-2 border-slate-200 text-xs font-bold text-slate-500 peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-slate-50 peer-checked:hover:bg-indigo-700 transition-all flex items-center gap-2">
                                <i class="fas fa-check-circle hidden peer-checked:inline-block"></i>
                                <span class="peer-checked:hidden"><i class="far fa-circle"></i></span>
                                {{ dept.name }}
                            </div>
                        </label>
                    {% endif %}
                {% empty %}
                    <div class="text-xs text-slate-400 italic">No departments available</div>
                {% endfor %}
            </div>
        </div>
        <!-- Search -->
        <div class="relative">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">
                Search
                Item
            </label>
            <input type="text" id="itemSearch" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="Type to search (e.g. Syringe, Gloves)..." oninput="debouncedSearch(this.value)" autocomplete="off">
            <input type="hidden" id="selectedItemId">
            <!-- Dropdown Results -->
            <div id="searchResults" class="absolute w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 z-50 hidden max-h-60 overflow-y-auto"></div>
        </div>
        <!-- Selected Item Details -->
        <div id="selectedItemDetails" class="hidden bg-white border border-slate-100 rounded-xl p-4 flex flex-col gap-4 animate-fade-in">
            <div class="flex justify-between items-center w-full">
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Selected</div>
                    <div class="font-black text-slate-800" id="selectedItemName">--</div>
                </div>
                <div class="flex items-center gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Quantity</label>
                        <input type="number" id="dispense_quantity" value="1" min="1" class="w-20 px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold text-center">
                    </div>
                    <button type="button" onclick="clearSelection()" class="text-slate-400 hover:text-rose-500 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Instructions Field -->
            <div class="w-full">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Special Instructions / Notes</label>
                <textarea id="dispense_instructions" rows="2" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="Enter any specific instructions for the pharmacist or patient..."></textarea>
            </div>
        </div>
        <button type="button" id="dispenseBtn" disabled onclick="handleDispense()" class="w-full py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-100 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none transition-all">Dispense to Patient</button>
    </div>
</div>
<!-- History of Dispensed Items -->
<div class="space-y-4">
    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Dispensed History (This Visit)</h5>
    <div id="dispensedHistoryList" class="space-y-3">
        {% for dispensed in dispensed_items %}
            <div class="bg-white border border-slate-100 p-4 rounded-xl flex justify-between items-center hover:border-indigo-100 transition-colors">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="text-sm font-bold text-slate-800">{{ dispensed.item_name }}</div>
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-tighter {{ dispensed.status_class }}">{{ dispensed.status }}</span>
                    </div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase">{{ dispensed.at|date:"d M H:i" }} â€¢ By {{ dispensed.by.first_name|default:dispensed.by.id_number }}</div>
                </div>
                <div class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-black rounded-lg ml-4">x{{ dispensed.quantity }}</div>
            </div>
        {% empty %}
            <div class="text-center py-8 opacity-50">
                <p class="text-xs font-bold text-slate-400 uppercase">No items dispensed yet</p>
            </div>
        {% endfor %}
    </div>
</div>
<script>
    let searchTimeout;

    function debouncedSearch(query) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (query.length < 2) {
                document.getElementById('searchResults').classList.add('hidden');
                return;
            }
            const departmentId = document.querySelector('input[name="dispense_department"]:checked')?.value;
            if (!departmentId) {
                alert("Please select a department first.");
                return;
            }

            fetch(`{% url 'inventory:search_inventory' %}?q=${encodeURIComponent(query)}&department_id=${departmentId}`)
                .then(r => r.json())
                .then(data => {
                    renderResults(data.results);
                });
        }, 300);
    }

    function renderResults(items) {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';
        if (items.length === 0) {
            container.innerHTML = '<div class="p-3 text-xs text-slate-400 italic">No items found in this department</div>';
            container.classList.remove('hidden');
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-slate-50 last:border-0 transition-colors';
            const hasStock = item.stock > 0;
            const stockClass = hasStock ? 'text-emerald-600' : 'text-rose-600';

            div.innerHTML = `
                <div class="font-bold text-slate-700 text-sm">${item.text}</div>
                <div class="flex justify-between items-center mt-1">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">${item.category}</div>
                    <div class="text-[10px] font-bold ${stockClass}">
                        ${hasStock ? `Stock: ${item.stock}` : 'Out of Stock'}
                    </div>
                </div>
            `;
            if (hasStock) {
                div.onclick = () => selectItem(item);
            } else {
                // div.classList.add('opacity-50', 'cursor-not-allowed');
                div.onclick = () => selectItem(item); // Allow anyway
                div.innerHTML += '<div class="text-[9px] font-black text-rose-500 uppercase mt-1">Requested via procurement if needed</div>';
            }
            container.appendChild(div);
        });
        container.classList.remove('hidden');
    }

    function selectItem(item) {
        document.getElementById('selectedItemId').value = item.id;
        document.getElementById('selectedItemName').innerText = item.text;

        // Store Stock Limit
        const qtyInput = document.getElementById('dispense_quantity');
        qtyInput.max = item.stock;
        qtyInput.value = 1; // Reset to 1

        // Add Stock Display
        const stockDisplay = document.getElementById('selectedItemStock');
        if (stockDisplay) {
            stockDisplay.innerText = `Available: ${item.stock}`;
        } else {
            // Create if not exists (quick fix if element missing)
            const infoDiv = document.getElementById('selectedItemName').parentElement;
            const span = document.createElement('div');
            span.id = 'selectedItemStock';
            span.className = 'text-xs font-bold text-emerald-600 mt-1';
            span.innerText = `Available: ${item.stock}`;
            infoDiv.appendChild(span);
        }

        document.getElementById('itemSearch').value = '';
        document.getElementById('searchResults').classList.add('hidden');

        document.getElementById('selectedItemDetails').classList.remove('hidden');
        document.getElementById('dispenseBtn').disabled = false;

        // Validation Listener
        qtyInput.oninput = function () {
            const val = parseInt(this.value) || 0;
            const max = parseInt(this.max) || 0;
            const btn = document.getElementById('dispenseBtn');
            const errorMsg = document.getElementById('qtyError');

            if (val > max && max > 0) {
                this.classList.add('border-rose-500', 'ring-1', 'ring-rose-500');
                // btn.disabled = true; // Don't block even if above stock, just warn
                if (!errorMsg) {
                    const error = document.createElement('div');
                    error.id = 'qtyError';
                    error.className = 'text-[10px] text-rose-500 font-bold mt-1';
                    error.innerText = `Note: Only ${max} in system stock. Proceeding will request re-stock.`;
                    this.parentElement.appendChild(error);
                }
            } else {
                this.classList.remove('border-rose-500', 'ring-1', 'ring-rose-500');
                btn.disabled = false;
                if (errorMsg) errorMsg.remove();
            }
        };
    }

    function clearSelection() {
        document.getElementById('selectedItemId').value = '';
        document.getElementById('selectedItemDetails').classList.add('hidden');
        document.getElementById('dispenseBtn').disabled = true;
    }

    function handleDispense() {
        const btn = document.getElementById('dispenseBtn');

        // Manual data gathering since we removed the form
        const patientId = document.getElementById('dispense_patient_id')?.value;
        const visitId = document.getElementById('dispense_visit_id')?.value;
        const itemId = document.getElementById('selectedItemId').value;
        const quantity = document.getElementById('dispense_quantity').value;
        const instructions = document.getElementById('dispense_instructions').value;

        const formData = new FormData();
        console.log("Dispensing Diagnostic:", { patientId, visitId, itemId, quantity, instructions });

        if (patientId) formData.append('patient_id', patientId);
        if (visitId) formData.append('visit_id', visitId);
        formData.append('item_id', itemId);
        formData.append('quantity', quantity);
        formData.append('instructions', instructions);

        // Get selected department
        const deptInput = document.querySelector('input[name="dispense_department"]:checked');
        if (deptInput) {
            formData.append('department_id', deptInput.value);
        } else {
            alert('Please select a department to dispense from.');
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        btn.disabled = true;
        const orgText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';

        fetch(`{% url 'inventory:dispense_item' %}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    // Ideally refresh just the list, but full reload is safer for now to update stock too
                    window.location.reload();
                } else {
                    alert(data.message);
                    btn.disabled = false;
                    btn.innerHTML = orgText;
                }
            })
            .catch(err => {
                console.error(err);
                alert('An error occurred');
                btn.disabled = false;
                btn.innerHTML = orgText;
            });
    }

    // Close search results on click outside
    document.addEventListener('click', function (e) {
        const searchContainer = document.getElementById('itemSearch')?.parentElement;
        if (searchContainer && !searchContainer.contains(e.target)) {
            document.getElementById('searchResults').classList.add('hidden');
        }
    });
</script>
<style>
    /* Additional Radio Button Styling */
    input[name="dispense_department"]:checked+div {
        background-color: #4f46e5 !important;
        color: white !important;
        border-color: #4f46e5 !important;
    }

    input[name="dispense_department"]:checked+div i.fa-check-circle {
        display: inline-block !important;
    }

    input[name="dispense_department"]:checked+div span {
        display: none !important;
    }
</style>
