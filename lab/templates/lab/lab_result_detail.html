{% extends 'users/dashboard_base.html' %}
{% load static %}
{% block title %}{{ title }} - HMS{% endblock %}
{% block content %}
    <style>
    :root {
        --clinical-primary: #6366f1;
        --clinical-primary-light: #eef2ff;
        --clinical-secondary: #64748b;
        --clinical-success: #10b981;
        --clinical-warning: #f59e0b;
        --clinical-danger: #ef4444;
        --clinical-bg: #f8fafc;
        --clinical-card-bg: rgba(255, 255, 255, 0.9);
        --clinical-border: #e2e8f0;
        --clinical-text-main: #1e293b;
        --clinical-text-muted: #64748b;
        --clinical-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.05), 0 4px 6px -2px rgba(99, 102, 241, 0.03);
    }

    .lab-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
        animation: fadeIn 0.4s ease-out;
    }

    /* Glassmorphism Header */
    .lab-header {
        background: var(--clinical-card-bg);
        backdrop-filter: blur(12px);
        border: 1px solid white;
        border-radius: 20px;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--clinical-shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .patient-summary {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .patient-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        background: var(--clinical-primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--clinical-primary);
        font-size: 1.5rem;
        font-weight: 800;
        box-shadow: inset 0 2px 4px rgba(99, 102, 241, 0.1);
    }

    .patient-meta h1 {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--clinical-text-main);
        margin: 0 0 0.25rem 0;
        letter-spacing: -0.025em;
    }

    .patient-meta p {
        font-size: 0.875rem;
        color: var(--clinical-text-muted);
        margin: 0;
        font-weight: 500;
    }

    .status-pill {
        padding: 0.5rem 1rem;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-pending {
        background: #fff7ed;
        color: #c2410c;
        border: 1px solid #ffedd5;
    }

    .status-progress {
        background: #eff6ff;
        color: #1d4ed8;
        border: 1px solid #dbeafe;
    }

    .status-completed {
        background: #ecfdf5;
        color: #047857;
        border: 1px solid #d1fae5;
    }

    .status-urgent {
        background: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fecaca;
    }

    .status-normal {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    /* Layout Grid */
    .detail-grid {
        display: grid;
        grid-template-columns: 1.8fr 1.2fr;
        gap: 2rem;
    }

    .modern-card {
        background: white;
        border: 1px solid var(--clinical-border);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: var(--clinical-shadow);
        transition: all 0.3s ease;
    }

    .modern-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.1);
    }

    .card-header {
        padding: 1.25rem 1.75rem;
        background: #f8fafc;
        border-bottom: 1px solid var(--clinical-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 0.95rem;
        font-weight: 800;
        color: var(--clinical-text-main);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .card-body {
        padding: 1.75rem;
    }

    /* Info Items */
    .info-strip {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.25rem;
        margin-bottom: 2rem;
    }

    .item-box {
        padding: 1rem;
        background: #f8fafc;
        border: 1px solid var(--clinical-border);
        border-radius: 12px;
    }

    .item-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: 800;
        color: var(--clinical-text-muted);
        margin-bottom: 0.35rem;
        display: block;
    }

    .item-value {
        font-size: 0.95rem;
        color: var(--clinical-text-main);
        font-weight: 600;
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--clinical-text-muted);
        margin-bottom: 0.5rem;
        display: block;
        text-transform: uppercase;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1.5px solid var(--clinical-border);
        border-radius: 12px;
        font-size: 0.9rem;
        transition: all 0.2s;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--clinical-primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    /* File Upload Area */
    .upload-zone {
        border: 2px dashed var(--clinical-border);
        border-radius: 16px;
        padding: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8fafc;
    }

    .upload-zone:hover {
        border-color: var(--clinical-primary);
        background: var(--clinical-primary-light);
    }

    .upload-icon {
        font-size: 2.5rem;
        color: var(--clinical-primary);
        margin-bottom: 1rem;
    }

    /* Custom Checkbox */
    .fancy-checkbox {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border: 1.5px solid var(--clinical-border);
        border-radius: 12px;
        width: fit-content;
        font-weight: 600;
        color: var(--clinical-text-main);
    }

    .fancy-checkbox input {
        width: 1.2rem;
        height: 1.2rem;
        accent-color: var(--clinical-primary);
    }

    /* Buttons */
    .modern-btn {
        padding: 0.8rem 1.5rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
    }

    .btn-primary {
        background: var(--clinical-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(99, 102, 241, 0.4);
    }

    .report-badge {
        background: #ecfdf5;
        border: 1px solid #d1fae5;
        padding: 1.5rem;
        border-radius: 16px;
        margin-bottom: 1.5rem;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    </style>
    <div class="lab-container">
        <!-- Premium Header -->
        <header class="lab-header">
            <a href="{% url 'lab:radiology_dashboard' %}" class="modern-btn" style="background: white; border: 1px solid var(--clinical-border); color: var(--clinical-secondary); text-decoration: none; padding: 0.6rem 1.2rem;">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>
            <div class="patient-summary">
                <div class="patient-icon">{{ lab_result.patient.first_name.0 }}{{ lab_result.patient.last_name.0 }}</div>
                <div class="patient-meta">
                    <h1>{{ lab_result.patient.full_name }}</h1>
                    <p>
                        <i class="fas fa-microscope"></i> {{ lab_result.service.name }}
                    </p>
                </div>
            </div>
            <div class="header-actions" style="display: flex; gap: 1rem; align-items: center;">
                <div class="status-pill {% if lab_result.status == 'Pending' %}status-pending{% elif lab_result.status == 'In Progress' %}status-progress{% else %}status-completed{% endif %}">
                    <i class="fas {% if lab_result.status == 'Pending' %}fa-clock{% elif lab_result.status == 'In Progress' %}fa-spinner fa-spin{% else %}fa-check-circle{% endif %}"></i>
                    {{ lab_result.status }}
                </div>
                <div class="status-pill {% if lab_result.priority == 'Urgent' %}status-urgent{% else %}status-normal{% endif %}">
                    <i class="fas fa-exclamation-triangle"></i> {{ lab_result.priority }}
                </div>
            </div>
        </header>
        <div class="detail-grid">
            <!-- Left Column: Test Results & Update -->
            <div style="display: flex; flex-direction: column; gap: 2rem;">
                <!-- Consumables Card -->
                <div class="modern-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-prescription-bottle-alt"></i> Consumables & Items
                        </h2>
                    </div>
                    <div class="card-body">
                        {% if not is_read_only %}
                            {% include 'inventory/partials/dispense_widget.html' with patient=patient visit=visit dispensed_items=dispensed_items %}
                        {% else %}
                             <div class="space-y-4">
                                <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Dispensed History (This Visit)</h5>
                                <div id="dispensedHistoryList" class="space-y-3">
                                    {% for dispensed in dispensed_items %}
                                        <div class="bg-white border border-slate-100 p-4 rounded-xl flex justify-between items-center hover:border-indigo-100 transition-colors">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <div class="text-sm font-bold text-slate-800">{{ dispensed.item_name }}</div>
                                                    <span class="px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-tighter {{ dispensed.status_class }}">{{ dispensed.status }}</span>
                                                </div>
                                                <div class="text-[10px] font-bold text-slate-400 uppercase">{{ dispensed.at|date:"d M H:i" }} • By {{ dispensed.by.first_name|default:dispensed.by.id_number }}</div>
                                            </div>
                                            <div class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-black rounded-lg ml-4">x{{ dispensed.quantity }}</div>
                                        </div>
                                    {% empty %}
                                        <div class="text-center py-8 opacity-50">
                                            <p class="text-xs font-bold text-slate-400 uppercase">No items dispensed yet</p>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <!-- Service Parameters Card -->
                <div class="modern-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-list-ul"></i> Service Parameters
                        </h2>
                    </div>
                    <div class="card-body">
                        {% if lab_result.parameters.all %}
                            <div class="table-responsive" style="margin-bottom: 2rem;">
                                <table class="table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid var(--clinical-border); text-align: left;">
                                            <th style="padding: 0.75rem; font-size: 0.75rem; text-transform: uppercase; color: var(--clinical-text-muted);">Parameter</th>
                                            <th style="padding: 0.75rem; font-size: 0.75rem; text-transform: uppercase; color: var(--clinical-text-muted);">Value</th>
                                            <th style="padding: 0.75rem; font-size: 0.75rem; text-transform: uppercase; color: var(--clinical-text-muted);">Unit</th>
                                            <th style="padding: 0.75rem; font-size: 0.75rem; text-transform: uppercase; color: var(--clinical-text-muted);">Ref. Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for param in lab_result.parameters.all %}
                                            <tr style="border-bottom: 1px solid var(--clinical-border);">
                                                <td style="padding: 0.75rem; font-weight: 600; color: var(--clinical-text-main);">
                                                    {{ param.name }}
                                                </td>
                                                <td style="padding: 0.75rem; font-weight: 700; color: var(--clinical-primary);">
                                                    {{ param.value }}
                                                </td>
                                                <td style="padding: 0.75rem; color: var(--clinical-text-muted);">{{ param.unit }}</td>
                                                <td style="padding: 0.75rem; color: var(--clinical-text-muted);">{{ param.ranges }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div style="text-align: center; padding: 1.5rem; background: #f8fafc; border-radius: 12px; border: 1px dashed var(--clinical-border); margin-bottom: 2rem;">
                                <p style="margin: 0; color: var(--clinical-text-muted); font-size: 0.85rem;">
                                    No parameters added
                                    yet.
                                </p>
                            </div>
                        {% endif %}
                        {% if not is_read_only %}
                            <h3 class="form-label" style="margin-bottom: 1rem;">
                                <i class="fas fa-plus"></i> Add Parameter
                            </h3>
                            <form method="post">
                                {% csrf_token %}
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group" style="margin-bottom: 0;">{{ parameter_form.name }}</div>
                                    <div class="form-group" style="margin-bottom: 0;">{{ parameter_form.value }}</div>
                                    <div class="form-group" style="margin-bottom: 0;">{{ parameter_form.unit }}</div>
                                    <div class="form-group" style="margin-bottom: 0;">{{ parameter_form.ranges }}</div>
                                </div>
                                <button type="submit" name="create_parameter" class="modern-btn" style="background: white; border: 1px solid var(--clinical-primary); color: var(--clinical-primary); width: 100%; justify-content: center;">
                                    <i class="fas fa-plus-circle"></i> Add Parameter
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                <div class="modern-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-vial"></i> Test Specifications
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="info-strip">
                            <div class="item-box">
                                <span class="item-label">Requesting Clinician</span>
                                <span class="item-value">{{ lab_result.requested_by.username|title }}</span>
                            </div>
                            <div class="item-box">
                                <span class="item-label">Request Date</span>
                                <span class="item-value">{{ lab_result.requested_at|date:"M d, Y • H:i" }}</span>
                            </div>
                            {% if lab_result.specimen %}
                                <div class="item-box">
                                    <span class="item-label">Specimen Type</span>
                                    <span class="item-value">{{ lab_result.specimen }}</span>
                                </div>
                            {% endif %}
                        </div>
                        {% if lab_result.clinical_notes %}
                            <div style="background: #eff6ff; padding: 1.25rem; border-radius: 12px; border: 1px solid #dbeafe; margin-bottom: 2rem;">
                                <span class="item-label" style="color: #1d4ed8;"><i class="fas fa-comment-medical"></i>
                                    Clinician's Notes</span>
                                    <p style="margin: 0.5rem 0 0; color: #1e3a8a; font-size: 0.9rem; line-height: 1.6;">
                                    {{ lab_result.clinical_notes }}
                                </p>
                            </div>
                        {% endif %}
                        {% if not is_read_only %}
                    <form method="post">
                        {% csrf_token %}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Processing Status</label>
                                {{ form.status }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Diagnostic Findings</label>
                            {{ form.results }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Clinical Interpretation</label>
                            {{ form.interpretation }}
                        </div>
                        <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--clinical-border);">
                            <button type="submit" name="update_result" class="modern-btn btn-primary">
                                <i class="fas fa-save"></i> Save Diagnostic Result
                            </button>
                        </div>
                    </form>
                {% else %}
                    <!-- Read-Only View for Results -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div class="item-box">
                            <span class="item-label">Diagnostic Findings</span>
                            <div class="item-value" style="white-space: pre-wrap; background: #fff; padding: 1rem; border: 1.5px solid var(--clinical-border); border-radius: 12px; min-height: 100px;">{{ lab_result.results|default:"No findings recorded yet." }}</div>
                        </div>
                        <div class="item-box">
                            <span class="item-label">Clinical Interpretation</span>
                            <div class="item-value" style="white-space: pre-wrap; background: #fff; padding: 1rem; border: 1.5px solid var(--clinical-border); border-radius: 12px; min-height: 100px;">{{ lab_result.interpretation|default:"No interpretation recorded yet." }}</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Right Column: Lab Report & Documentation -->
    <div style="display: flex; flex-direction: column; gap: 2rem;">
        <div class="modern-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-file-signature"></i> Final Report
                </h2>
            </div>
            <div class="card-body">
                {% if lab_report %}
                    <div class="report-badge">
                        <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1.25rem;">
                            <div style="width: 44px; height: 44px; border-radius: 10px; background: white; display: flex; align-items: center; justify-content: center; color: var(--clinical-success); box-shadow: 0 4px 6px rgba(0,0,0,0.04);">
                                <i class="fas fa-check-circle fa-lg"></i>
                            </div>
                            <div>
                                <h4 style="margin: 0; color: #065f46; font-size: 0.95rem; font-weight: 800;">
                                    Report
                                    Finalized
                                </h4>
                                <p style="margin: 0.2rem 0 0; color: #059669; font-size: 0.8rem; font-weight: 600;">
                                    {{ lab_report.created_at|date:"M d, Y • H:i" }}
                                </p>
                            </div>
                        </div>
                        {% if lab_report.report_file %}
                            <a href="{{ lab_report.report_file.url }}" target="_blank" class="modern-btn" style="width: 100%; background: white; border: 1px solid #d1fae5; color: #047857; margin-bottom: 1rem;">
                                <i class="fas fa-file-pdf"></i> View Annex Document
                            </a>
                        {% endif %}
                        {% if lab_report.report_text %}<div style="background: white; padding: 1rem; border-radius: 10px; border: 1px dashed #d1fae5; font-size: 0.85rem; color: #065f46; line-height: 1.5;">{{ lab_report.report_text|linebreaks }}</div>{% endif %}
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 16px; border: 1px dashed var(--clinical-border); margin-bottom: 2rem;">
                        <i class="fas fa-file-medical-alt fa-3x" style="color: var(--clinical-border); margin-bottom: 1rem; display: block;"></i>
                        <p style="margin: 0; color: var(--clinical-text-muted); font-size: 0.85rem; font-weight: 600;">No report generated yet.</p>
                    </div>
                {% endif %}
                {% if not is_read_only %}
                    <h3 class="form-label" style="margin-bottom: 1.25rem;">
                        <i class="fas fa-plus-circle"></i>
                        {% if lab_report %}
                            Revise
                        {% else %}
                            Generate
                        {% endif %}
                        Report
                    </h3>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="form-group">
                            <input type="file" id="report_file" name="report_file" style="display: none;">
                            <div class="upload-zone" onclick="document.getElementById('report_file').click()">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <h4 style="font-size: 0.9rem; margin: 0 0 0.5rem 0; color: var(--clinical-text-main);">Upload Attachment</h4>
                                <p style="font-size: 0.75rem; color: var(--clinical-text-muted); margin: 0;" id="file-name">Drag & drop or click to browse</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Summary Remarks</label>
                            <textarea name="report_text" rows="4" class="form-control" placeholder="Key takeaways and summary for the clinician...">{{ lab_report.report_text }}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="fancy-checkbox">
                                <input type="checkbox" name="is_final" {% if lab_report.is_final %}checked{% endif %}>
                                <span>Validate & Mark as Final</span>
                            </label>
                        </div>
                        <button type="submit" name="create_report" class="modern-btn btn-primary" style="width: 100%; justify-content: center;">
                            <i class="fas fa-paper-plane"></i> Publish Report
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>
<script>
    // File input visual feedback
    document.getElementById('report_file').addEventListener('change', function (e) {
        const fileName = e.target.files[0]?.name;
        if (fileName) {
            document.getElementById('file-name').innerHTML = `<span style="color: var(--clinical-primary); font-weight: 800;">Selected: ${fileName}</span>`;
            document.querySelector('.upload-zone').style.borderColor = 'var(--clinical-primary)';
            document.querySelector('.upload-zone').style.background = 'var(--clinical-primary-light)';
        }
    });

    // Nice select replacement styling if needed, otherwise standard inputs
    document.querySelectorAll('select').forEach(sel => {
        sel.classList.add('form-control');
    });
    document.querySelectorAll('input[type="text"]').forEach(input => {
        input.classList.add('form-control');
    });

    // Auto-expanding textareas
    document.querySelectorAll('textarea').forEach(area => {
        area.classList.add('form-control');

        // Initial adjust
        area.style.overflowY = 'hidden';
        area.style.resize = 'none';

        const adjustHeight = (el) => {
            el.style.height = 'auto'; // Reset height to calculate scrollHeight
            el.style.height = (el.scrollHeight + 2) + 'px'; // +2 for border
        };

        // Adjust on load if there's content
        if (area.value) adjustHeight(area);

        // Adjust on input
        area.addEventListener('input', function () {
            adjustHeight(this);
        });
    });
</script>
{% endblock %}
