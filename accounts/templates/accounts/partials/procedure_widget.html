<div class="bg-indigo-50/30 border border-indigo-100 rounded-[32px] p-8 mb-6">
    <h5 class="text-xs font-black text-indigo-900 uppercase tracking-widest mb-6 flex items-center gap-2">
        <i class="fas fa-stethoscope"></i> Charge Procedure
    </h5>

    <form id="procedureForm" class="space-y-6" onsubmit="handleProcedureCharge(event)">
        <!-- Hidden Context Fields -->
        {% if patient %}
        <input type="hidden" name="patient_id" value="{{ patient.id }}">
        {% elif admission %}
        <input type="hidden" name="patient_id" value="{{ admission.patient.id }}">
        {% endif %}

        {% if visit %}
        <input type="hidden" name="visit_id" value="{{ visit.id }}">
        {% elif admission %}
        <input type="hidden" name="visit_id" value="{{ admission.visit.id|default:'' }}">
        {% endif %}

        <!-- Search -->
        <div class="relative">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Search
                Procedure</label>
            <input type="text" id="procedureSearch"
                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                placeholder="Type to search (e.g. Suturing, Delivery)..." oninput="debouncedProcedureSearch(this.value)"
                autocomplete="off">
            <input type="hidden" name="procedure_id" id="selectedProcedureId">

            <!-- Dropdown Results -->
            <div id="procedureSearchResults"
                class="absolute w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 z-50 hidden max-h-60 overflow-y-auto">
            </div>
        </div>

        <!-- Selected Item Details -->
        <div id="selectedProcedureDetails"
            class="hidden bg-white border border-slate-100 rounded-xl p-4 flex justify-between items-center animate-fade-in">
            <div>
                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Selected</div>
                <div class="font-black text-slate-800" id="selectedProcedureName">--</div>
            </div>
            <div class="flex items-center gap-4">
                <div>
                    <label
                        class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Price</label>
                    <div class="px-3 py-2 bg-slate-50 rounded-lg text-sm font-bold text-slate-700"
                        id="selectedProcedurePrice">--</div>
                </div>
                <button type="button" onclick="clearProcedureSelection()"
                    class="text-slate-400 hover:text-rose-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Notes -->
        <div>
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Clinical Notes
                (Optional)</label>
            <textarea name="notes" rows="2"
                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none"
                placeholder="Add any relevant notes..."></textarea>
        </div>

        <button type="submit" id="chargeBtn" disabled
            class="w-full py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-100 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none transition-all">
            Charge to Patient
        </button>
    </form>
</div>

<!-- History of Procedures -->
<div class="space-y-4">
    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Performed Procedures (This Visit)
    </h5>
    <div id="proceduresHistoryList" class="space-y-3">
        {% for proc in performed_procedures %}
        <div
            class="bg-white border border-slate-100 p-4 rounded-xl flex justify-between items-center hover:border-indigo-100 transition-colors">
            <div>
                <div class="text-sm font-bold text-slate-800">{{ proc.name }}</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase">{{ proc.created_at|date:"d M H:i" }}</div>
            </div>
            <div class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-black rounded-lg">
                KES {{ proc.unit_price }}
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8 opacity-50">
            <p class="text-xs font-bold text-slate-400 uppercase">No procedures recorded yet</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    let procSearchTimeout;

    function debouncedProcedureSearch(query) {
        clearTimeout(procSearchTimeout);
        procSearchTimeout = setTimeout(() => {
            if (query.length < 2) {
                document.getElementById('procedureSearchResults').classList.add('hidden');
                return;
            }
            fetch(`{% url 'accounts:search_procedures' %}?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => showProcedureResults(data.results));
        }, 300);
    }

    function showProcedureResults(items) {
        const container = document.getElementById('procedureSearchResults');
        container.innerHTML = '';
        if (items.length === 0) {
            container.classList.add('hidden');
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-slate-50 last:border-0 transition-colors';
            div.innerHTML = `
                <div class="text-sm font-bold text-slate-800">${item.text}</div>
            `;
            div.onclick = () => selectProcedure(item);
            container.appendChild(div);
        });
        container.classList.remove('hidden');
    }

    function selectProcedure(item) {
        document.getElementById('selectedProcedureId').value = item.id;
        document.getElementById('selectedProcedureName').innerText = item.text.split('(')[0];
        document.getElementById('selectedProcedurePrice').innerText = `KES ${item.price}`;
        document.getElementById('procedureSearch').value = '';
        document.getElementById('procedureSearchResults').classList.add('hidden');

        document.getElementById('selectedProcedureDetails').classList.remove('hidden');
        document.getElementById('chargeBtn').disabled = false;
    }

    function clearProcedureSelection() {
        document.getElementById('selectedProcedureId').value = '';
        document.getElementById('selectedProcedureDetails').classList.add('hidden');
        document.getElementById('chargeBtn').disabled = true;
    }

    function handleProcedureCharge(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const btn = document.getElementById('chargeBtn');

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        btn.disabled = true;
        const orgText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';

        fetch(`{% url 'accounts:charge_procedure' %}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert(data.message);
                    btn.disabled = false;
                    btn.innerHTML = orgText;
                }
            })
            .catch(err => {
                console.error(err);
                alert('An error occurred');
                btn.disabled = false;
                btn.innerHTML = orgText;
            });
    }

    // Close search results on click outside
    document.addEventListener('click', function (e) {
        const searchContainer = document.getElementById('procedureSearch')?.parentElement;
        if (searchContainer && !searchContainer.contains(e.target)) {
            document.getElementById('procedureSearchResults').classList.add('hidden');
        }
    });
</script>