{% extends 'users/dashboard_base.html' %}
{% load static %}
{% block title %}{{ title }} - HMS Clinical Exit{% endblock %}
{% block content %}
    <div class="px-8 py-10 max-w-[1400px] mx-auto">
        <!-- Header Area -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-10 h-10 rounded-xl bg-rose-600 flex items-center justify-center text-white text-lg shadow-lg shadow-rose-200">
                        <i class="fas fa-sign-out-alt"></i>
                    </span>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Clinical Discharge Process</h1>
                </div>
                <p class="text-slate-500 font-bold ml-1">
                    Finalizing medical records and billing for <span class="text-slate-900">{{ admission.patient.full_name }}</span>
                </p>
            </div>
            <div class="flex gap-4">
                <a href="{% url 'inpatient:patient_case_folder' admission.id %}" class="px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest hover:border-indigo-600 hover:text-indigo-600 transition-all shadow-sm flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Return to Case Folder
                </a>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <!-- Billing & Stay Summary -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Billing Dashboard -->
                <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 overflow-hidden">
                    <div class="px-10 py-6 bg-slate-50/50 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="text-sm font-black text-slate-900 uppercase tracking-widest flex items-center gap-3">
                            <i class="fas fa-file-invoice-dollar text-indigo-500"></i> Provisionary Billing Summary
                        </h2>
                        <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-[10px] font-black rounded-full uppercase tracking-widest">Pre-Discharge
                        Audit</span>
                    </div>
                    <div class="p-0">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/30">
                                    <th class="px-10 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Item Description</th>
                                    <th class="px-8 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider text-center">Reference / Details</th>
                                    <th class="px-10 py-4 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right">Amount (USD)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <!-- Ward Accommodation -->
                                <tr class="hover:bg-slate-50 transition-colors">
                                    <td class="px-10 py-6">
                                        <div class="text-sm font-black text-slate-900">Ward Accommodation</div>
                                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                                            {{
                                            admission.bed.ward.name }} ({{ admission.bed.ward.ward_type }})
                                        </div>
                                    </td>
                                    <td class="px-8 py-6 text-center">
                                        <span class="px-3 py-1 bg-slate-100 text-slate-600 text-[11px] font-black rounded-lg">
                                            {{ days_stayed }} Day{{ days_stayed|pluralize }} @ ${{
                                            admission.bed.ward.base_charge_per_day }}/day
                                        </span>
                                    </td>
                                    <td class="px-10 py-6 text-right text-lg font-black text-slate-900">${{ ward_cost }}</td>
                                </tr>
                                <!-- Medications -->
                                <tr class="hover:bg-slate-50 transition-colors">
                                    <td class="px-10 py-6">
                                        <div class="text-sm font-black text-slate-900">Medical Supplies & Pharmacy</div>
                                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Dispensed during admission</div>
                                    </td>
                                    <td class="px-8 py-6 text-center">
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Standard
                                        Hospital Catalog</span>
                                    </td>
                                    <td class="px-10 py-6 text-right text-lg font-black text-slate-900">${{ med_cost }}</td>
                                </tr>
                                <!-- Services -->
                                <tr class="hover:bg-slate-50 transition-colors">
                                    <td class="px-10 py-6">
                                        <div class="text-sm font-black text-slate-900">Clinical Services</div>
                                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Oxygen, Procedures, Nursing Care</div>
                                    </td>
                                    <td class="px-8 py-6 text-center">
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Variable
                                        / Point of service</span>
                                    </td>
                                    <td class="px-10 py-6 text-right text-lg font-black text-slate-900">${{ service_cost }}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="bg-indigo-600 text-white">
                                    <td colspan="2" class="px-10 py-6 text-sm font-black uppercase tracking-widest">
                                        Total
                                        Estimated Liability
                                    </td>
                                    <td class="px-10 py-6 text-right text-3xl font-black">${{ total_bill }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <!-- Authorization Form -->
                <div class="bg-white rounded-[32px] shadow-lg border-2 border-emerald-100 overflow-hidden relative">
                    <div class="absolute top-0 right-0 w-48 h-48 bg-emerald-50 rounded-full -mr-24 -mt-24 blur-3xl opacity-50"></div>
                    <div class="px-10 py-6 bg-emerald-50/50 border-b border-emerald-100 flex items-center gap-3">
                        <i class="fas fa-clipboard-check text-emerald-600"></i>
                        <h2 class="text-sm font-black text-emerald-900 uppercase tracking-widest font-black">
                            Physician
                            Authorization
                        </h2>
                    </div>
                    <form method="post" class="p-10 space-y-8 relative z-10">
                        {% csrf_token %}
                        <div class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">
                                Confirmed
                                Final Diagnosis
                            </label>
                            {{ form.final_diagnosis }}
                            {% if form.final_diagnosis.errors %}
                                <p class="text-[10px] font-bold text-rose-500 mt-1 uppercase">
                                    {{ form.final_diagnosis.errors.0
                                    }}
                                </p>
                            {% endif %}
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">
                                Discharge
                                Summary & Home Care Instructions
                            </label>
                            {{ form.discharge_summary }}
                            <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-tight">
                                Outline clinical
                                course, follow-up dates, and activity restrictions
                            </p>
                            {% if form.discharge_summary.errors %}
                                <p class="text-[10px] font-bold text-rose-500 mt-1 uppercase">
                                    {{
                                    form.discharge_summary.errors.0 }}
                                </p>
                            {% endif %}
                        </div>
                        <div class="p-6 bg-amber-50 rounded-2xl border border-amber-100 flex items-start gap-4">
                            <div class="w-10 h-10 rounded-xl bg-amber-500 flex items-center justify-center text-white shrink-0">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-1">Authorization Warning</div>
                                <p class="text-[11px] font-bold text-amber-900 leading-relaxed uppercase tracking-tight">
                                    By
                                    confirming this discharge, you certify the patient is clinically fit for release. This
                                    action will release Bed {{ admission.bed.bed_number }} and finalize the admission
                                    folder.
                                </p>
                            </div>
                        </div>
                        <div class="pt-6 border-t border-slate-50 flex justify-end">
                            <button type="submit" class="w-full md:w-auto px-12 py-5 bg-emerald-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-xl shadow-emerald-100 hover:bg-emerald-700 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3 uppercase">
                                <i class="fas fa-check-double text-lg"></i> Authorize Final Discharge
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Right Side: Admission Context -->
            <div class="space-y-8">
                <div class="bg-slate-900 rounded-[32px] shadow-2xl p-8 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                    <h3 class="text-xs font-black uppercase tracking-widest mb-8 text-indigo-400 flex items-center gap-2">
                        <i class="fas fa-info-circle"></i> Admission Context
                    </h3>
                    <div class="space-y-8">
                        <div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                Time of
                                Admission
                            </div>
                            <div class="text-lg font-black text-white">{{ admission.admitted_at|date:"F d, Y" }}</div>
                            <div class="text-[11px] font-bold text-indigo-400 mt-1 uppercase tracking-widest">
                                {{
                                admission.admitted_at|time:"H:i" }} HRS
                            </div>
                        </div>
                        <div class="pt-8 border-t border-white/5">
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">
                                Entrance
                                Diagnosis
                            </div>
                            <div class="p-4 bg-white/5 rounded-2xl border border-white/10 text-sm font-medium text-slate-100 leading-relaxed italic">"{{ admission.provisional_diagnosis }}"</div>
                        </div>
                        <div class="pt-8 border-t border-white/5">
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">
                                Ward
                                Assignment
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-black text-slate-100 uppercase tracking-widest">{{
                                admission.bed.ward.name }}</span>
                                <span class="px-2 py-1 bg-indigo-500 text-white text-[9px] font-black rounded-lg uppercase tracking-wider">UNIT
                                {{ admission.bed.bed_number }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Discharge Checklist -->
                <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 p-8">
                    <h3 class="text-xs font-black text-slate-900 uppercase tracking-widest mb-6">Process Checklist</h3>
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 text-[11px] font-black text-emerald-600 uppercase tracking-widest">
                            <i class="fas fa-check-circle"></i> Clinical Stability Verified
                        </div>
                        <div class="flex items-center gap-3 text-[11px] font-black text-emerald-600 uppercase tracking-widest">
                            <i class="fas fa-check-circle"></i> Billing Audit Performed
                        </div>
                        <div class="flex items-center gap-3 text-[11px] font-black text-slate-400 uppercase tracking-widest">
                            <i class="far fa-circle"></i> Medication Reconciliation
                        </div>
                        <div class="flex items-center gap-3 text-[11px] font-black text-slate-400 uppercase tracking-widest">
                            <i class="far fa-circle"></i> Return of Personal Items
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
    textarea,
    input {
        width: 100% !important;
        background: #f8fafc !important;
        border: 2px solid #f1f5f9 !important;
        border-radius: 20px !important;
        padding: 14px 18px !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        color: #1e293b !important;
        transition: all 0.3s !important;
    }

    textarea {
        height: 160px !important;
    }

    textarea:focus,
    input:focus {
        background: #fff !important;
        border-color: #10b981 !important;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1) !important;
        outline: none !important;
    }
    </style>
{% endblock %}
