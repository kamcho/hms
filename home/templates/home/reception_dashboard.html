{% extends 'users/dashboard_base.html' %}
{% load custom_filters %}

{% block title %}Reception Dashboard - HMS{% endblock %}

{% block content %}
<div class="container">
    <div class="header-row">
        <h2>Reception Dashboard</h2>
    </div>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-content">
                <h3>Today's Visits</h3>
                <div class="stat-number">{{ today_visits }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>Total Patients</h3>
                <div class="stat-number">{{ total_patients }}</div>
            </div>
        </div>
        {% if user_role == 'Receptionist' %}
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="stat-content">
                <h3>Unpaid Invoices</h3>
                <div class="stat-number">{{ unpaid_invoices }}</div>
            </div>
        </div>
        {% elif user_role == 'Triage Nurse' %}
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clipboard-check"></i>
            </div>
            <div class="stat-content">
                <h3>Today's Triage</h3>
                <div class="stat-number">{{ today_triage_entries }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-clock"></i>
            </div>
            <div class="stat-content">
                <h3>Pending Triage</h3>
                <div class="stat-number">{{ pending_triage_count }}</div>
            </div>
        </div>
        {% endif %}
        {% if user_role == 'Receptionist' %}
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="stat-content">
                <h3>Recent Patients</h3>
                <div class="stat-number">{{ patients|length }}</div>
                <a href="{% url 'home:patient_create' %}" class="add-patient-btn">
                    <i class="fas fa-plus"></i> Add New Patient
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="content-grid">
        {% if user_role == 'Receptionist' %}
        <div class="section">
            <div class="section-header">
                <h3>Patient Service Invoices</h3>
                <button id="reloadInvoices" class="reload-btn" title="Reload Invoice Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="search-section">
                <form method="GET" class="search-form">
                    <div class="search-container">
                        <input type="text" name="invoice_search" class="search-input"
                            placeholder="Search by patient name or service name..." value="{{ invoice_search }}">
                        <button type="submit" class="btn btn-primary search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        {% if invoice_search %}
                        <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                            <i class="fas fa-times"></i> Clear
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
            {% if invoice_search %}
            <div class="search-results-info">
                Found <strong>{{ invoices|length }}</strong> invoice(s) matching "<strong>{{ invoice_search }}</strong>"
            </div>
            {% endif %}
            <div class="table-responsive">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>Service</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                        {% for invoice in invoices %}
                        <tr class="invoice-row {% if invoice.deceased %}bg-light-danger{% endif %}"
                            data-invoice-id="{{ invoice.pk }}"
                            data-patient-name="{% if invoice.patient %}{{ invoice.patient.full_name }}{% else %}{{ invoice.deceased.full_name }}{% endif %}"
                            data-service-name="{% for item in invoice.items.all %}{{ item.name }}{% if not forloop.last %}, {% endif %}{% empty %}No services{% endfor %}"
                            data-price="{{ invoice.total_amount }}" data-status="{{ invoice.status }}">
                            <td class="patient-name">
                                {% if invoice.patient %}
                                {{ invoice.patient.full_name }}
                                {% elif invoice.deceased %}
                                <span class="text-danger font-weight-bold">{{ invoice.deceased.full_name }}</span>
                                {% else %}
                                Unknown
                                {% endif %}
                            </td>
                            <td class="service-name">
                                {% for item in invoice.items.all %}
                                {{ item.name }}{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                No services
                                {% endfor %}
                            </td>
                            <td class="price">Ksh {{ invoice.total_amount|format_number:2 }}</td>
                            <td>
                                <span class="invoice-status status-{{ invoice.status|lower }}">
                                    {{ invoice.status }}
                                </span>
                            </td>
                            <td class="date">{{ invoice.created_at|date:"M d, Y H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="no-records">
                                {% if invoice_search %}
                                No invoices found matching "{{ invoice_search }}".
                                {% else %}
                                No patient service invoices found.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% elif user_role == 'Triage Nurse' %}
        <div class="section">
            <div class="section-header">
                <h3>Recent Triage Entries</h3>
                <button class="reload-btn" onclick="location.reload()" title="Refresh entries">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="search-section">
                <form method="GET" class="search-form">
                    <div class="search-container">
                        <input type="text" name="triage_search" class="search-input"
                            placeholder="Search by patient name or phone..." value="{{ triage_search }}">
                        <button type="submit" class="btn btn-primary search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        {% if triage_search %}
                        <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                            <i class="fas fa-times"></i> Clear
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
            {% if triage_search %}
            <div class="search-results-info">
                Found <strong>{{ triage_entries|length }}</strong> entry(s) matching "<strong>{{ triage_search
                    }}</strong>"
            </div>
            {% endif %}
            <div class="table-responsive">
                <table class="premium-table">
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>Vitals</th>
                            <th>Priority Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for triage in triage_entries %}
                        <tr class="triage-row" data-triage-id="{{ triage.pk }}">
                            <td>
                                <div class="patient-profile-inline">
                                    <div class="avatar-initials" data-name="{{ triage.visit.patient.first_name }}">
                                        {{ triage.visit.patient.first_name|first }}{{triage.visit.patient.last_name|first }}
                                    </div>
                                    <div class="name-id">
                                        <span class="full-name">{{ triage.visit.patient.first_name }}
                                            {{triage.visit.patient.last_name }}</span>
                                        <span
                                            class="patient-id">#PAT-{{triage.visit.patient.pk|stringformat:"05d"}}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="vitals-display">
                                    <span class="vital-item" title="Temperature">
                                        <i class="fas fa-thermometer-half"></i> {{ triage.temperature }}°C
                                    </span>
                                    <span class="vital-item" title="Blood Pressure">
                                        <i class="fas fa-heartbeat"></i> {{ triage.blood_pressure }}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="priority-badge-modern priority-{{ triage.priority|lower }}">
                                    <i class="fas fa-circle"></i> {{ triage.get_priority_display }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="no-records">
                                <div class="empty-state-small">
                                    <i class="fas fa-clipboard-list"></i>
                                    <p>No triage entries found today.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <div class="section-header">
                <h3>Visits Pending Triage</h3>
                <button class="reload-btn" onclick="location.reload()" title="Refresh visits">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="search-section">
                <form method="GET" class="search-form">
                    <div class="search-container">
                        <input type="text" name="pending_search" class="search-input"
                            placeholder="Search by patient name or phone..." value="{{ pending_search }}">
                        <button type="submit" class="btn btn-primary search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        {% if pending_search %}
                        <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                            <i class="fas fa-times"></i> Clear
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
            {% if pending_search %}
            <div class="search-results-info">
                Found <strong>{{ visits_without_triage|length }}</strong> visit(s) matching "<strong>{{ pending_search
                    }}</strong>"
            </div>
            {% endif %}
            <div class="table-responsive">
                <table class="premium-table">
                    <thead>
                        <tr>
                            <th>Patient Info</th>
                            <th>Visit Reason</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for visit in visits_without_triage %}
                        <tr class="pending-visit-row" data-visit-id="{{ visit.pk }}">
                            <td>
                                <div class="patient-profile-inline">
                                    <div class="avatar-initials" data-name="{{ visit.patient.first_name }}">
                                        {{ visit.patient.first_name|first }}{{ visit.patient.last_name|first }}
                                    </div>
                                    <div class="name-id">
                                        <span class="full-name">{{ visit.patient.first_name }} {{visit.patient.last_name  }}</span>
                                        <span class="visit-time"><i class="far fa-clock"></i>
                                            {{visit.visit_date|date:"H:i" }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="visit-reason-box">
                                    <span class="reason-text">{{ visit.services_summary|default:"Standard Check-up"|truncatechars:60 }}</span>
                                    <div class="d-flex align-items-center gap-2 mt-1">
                                        <span class="visit-type-tag">{{ visit.get_visit_type_display }}</span>
                                        {% if visit.is_maternity %}
                                        <span class="badge"
                                            style="background: rgba(231, 84, 128, 0.15); color: #e75480; border: 1px solid rgba(231, 84, 128, 0.3); font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 4px;">
                                            <i class="fas fa-baby-carriage"></i> MATERNITY
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="text-right">
                                <button class="btn-triage-start start-triage-btn" data-visit-id="{{ visit.pk }}"
                                    data-patient-name="{{ visit.patient.first_name }} {{ visit.patient.last_name }}"
                                    data-visit-date="{{ visit.visit_date|date:'M d, Y H:i' }}"
                                    data-is-maternity="{{ visit.is_maternity|yesno:'true,false' }}"
                                    data-services="{{ visit.services_summary }}">
                                    <i class="fas fa-stethoscope"></i> Start Triage
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="no-records">
                                <div class="empty-state-small">
                                    <i class="fas fa-check-double"></i>
                                    <p>All clear! No visits pending triage.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if user_role == 'Receptionist' or user_role == 'Admin' %}
        <!-- IPD & Morgue Section -->
        <div class="section admission-morgue-section" style="grid-column: span 2;">
            <div class="tab-container">
                <div class="tabs-header">
                    <button class="dashboard-tab active" onclick="switchDashboardTab(event, 'ipd-tab')">
                        <i class="fas fa-procedures"></i> Active IPD Admissions
                    </button>
                    <button class="dashboard-tab" onclick="switchDashboardTab(event, 'morgue-tab')">
                        <i class="fas fa-box"></i> Active Morgue Cases
                    </button>
                </div>

                <div id="ipd-tab" class="tab-content active">
                    <div class="table-responsive">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Ward/Bed</th>
                                    <th>Admitted At</th>
                                    <th class="text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for admission in ipd_admissions %}
                                <tr>
                                    <td>
                                        <div class="font-bold text-slate-900">{{ admission.patient.full_name }}</div>
                                        <div class="text-xs text-slate-500">#PAT-{{ admission.patient.id }}</div>
                                    </td>
                                    <td>{{ admission.bed.ward.name }} - {{ admission.bed.bed_number }}</td>
                                    <td>{{ admission.admitted_at|date:"M d, Y H:i" }}</td>
                                    <td class="text-right">
                                        <a href="{% url 'accounts:discharge_detail' 'ipd' admission.id %}"
                                            class="btn btn-primary btn-sm">
                                            <i class="fas fa-file-invoice-dollar"></i> Bill & Discharge
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="no-records">No active Inpatient admissions.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="morgue-tab" class="tab-content">
                    <div class="table-responsive">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Deceased</th>
                                    <th>Tag</th>
                                    <th>Admission Date</th>
                                    <th class="text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for admission in morgue_admissions %}
                                <tr>
                                    <td>
                                        <div class="font-bold text-slate-900">{{ admission.deceased.full_name }}</div>
                                        <div class="text-xs text-slate-500">S/N: {{ admission.admission_number }}</div>
                                    </td>
                                    <td><span class="badge bg-secondary">{{ admission.deceased.tag }}</span></td>
                                    <td>{{ admission.admission_datetime|date:"M d, Y H:i" }}</td>
                                    <td class="text-right">
                                        <a href="{% url 'accounts:discharge_detail' 'morgue' admission.id %}"
                                            class="btn btn-primary btn-sm">
                                            <i class="fas fa-file-invoice-dollar"></i> Bill & Release
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="no-records">No active Morgue cases.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if user_role == 'Receptionist' %}
        <div class="section" style="grid-column: span 2;">
            <div class="section-header">
                <h3>Recent Patients (Last 10)</h3>
            </div>
            <div class="search-section">
                <form method="GET" class="search-form">
                    <div class="search-container">
                        <input type="text" name="patient_search" class="search-input"
                            placeholder="Search by name, phone, or location..." value="{{ patient_search }}">
                        <button type="submit" class="btn btn-primary search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        {% if patient_search %}
                        <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                            <i class="fas fa-times"></i> Clear
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
            {% if patient_search %}
            <div class="search-results-info">
                Found <strong>{{ patients|length }}</strong> patient(s) matching "<strong>{{ patient_search }}</strong>"
            </div>
            {% endif %}
            <div class="table-responsive">
                <table class="patient-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Phone</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                        {% for patient in patients %}
                        <tr class="patient-row" data-patient-id="{{ patient.pk }}"
                            data-patient-name="{{ patient.first_name }} {{ patient.last_name }}">
                            <td class="patient-name">{{ patient.first_name }} {{ patient.last_name }}</td>
                            <td>{{ patient.age }}</td>
                            <td>{{ patient.get_gender_display }}</td>
                            <td>{{ patient.phone }}</td>
                            <td>{{ patient.location }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="no-records">
                                {% if patient_search %}
                                No patients found matching "{{ patient_search }}".
                                {% else %}
                                No patients found.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function switchDashboardTab(evt, tabId) {
        const container = evt.currentTarget.closest('.tab-container');

        // Hide all tab content
        const tabContents = container.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));

        // Remove active class from all tabs
        const tabs = container.querySelectorAll('.dashboard-tab');
        tabs.forEach(tab => tab.classList.remove('active'));

        // Show current tab content and set active class
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
</script>

<style>
    .tab-container {
        padding: 0;
    }

    .tabs-header {
        display: flex;
        gap: 2px;
        background: #f1f5f9;
        padding: 0.5rem 0.5rem 0 0.5rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .dashboard-tab {
        padding: 0.75rem 1.5rem;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #64748b;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dashboard-tab.active {
        background: white;
        color: var(--primary-color);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .tab-content {
        display: none;
        padding: 1.5rem;
    }

    .tab-content.active {
        display: block;
    }

    .premium-table {
        width: 100%;
        border-collapse: collapse;
    }

    .premium-table th {
        text-align: left;
        padding: 1rem;
        background: #f8fafc;
        color: #475569;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e2e8f0;
    }

    .premium-table td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
</style>

<!-- Patient Action Modal -->
<div id="patientActionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Patient Actions</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <p>What would you like to do for <strong id="modalPatientName"></strong>?</p>

            <div class="admission-section-integrated" style="margin-top: 1rem;">
                <h4
                    style="margin-bottom: 1.25rem; color: #1e293b; display: flex; align-items: center; gap: 0.625rem; font-size: 1.1rem;">
                    <i class="fas fa-hospital-user" style="color: #10b981;"></i> Admit for OPD Visit
                </h4>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="admitConsultation"
                        style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; color: #64748b;">Consultation
                        Type</label>
                    <select id="admitConsultation" class="form-control" style="width: 100%; border-radius: 8px;">
                        <option value="">-- Select Consultation --</option>
                        {% for service in services %}
                        {% if "Consultation" in service.name %}
                        <option value="{{ service.pk }}" {% if "ANC" in service.name or "PNC" in service.name%}style="font-weight: bold; color: var(--primary-color);" {% endif %}>
                            {{ service.name }} (Ksh {{ service.price|format_number:0 }})
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="admitPaymentMethod"
                        style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; color: #64748b;">Payment
                        Method</label>
                    <select id="admitPaymentMethod" class="form-control" style="width: 100%; border-radius: 8px;">
                        <option value="Cash">Cash</option>
                        <option value="M-Pesa">M-Pesa</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>

                <button id="admitVisitBtn" class="btn btn-success"
                    style="width: 100%; justify-content: center; padding: 0.875rem; border-radius: 10px; font-weight: 600;">
                    <i class="fas fa-check-circle"></i> Complete Admission & Payment
                </button>
            </div>

            <div style="margin: 2rem 0; border-top: 1px solid #e5e7eb; position: relative;">
                <span
                    style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 1rem; color: #6b7280; font-size: 0.875rem;">OR</span>
            </div>

            <div class="quick-invoice-section">
                <h4 style="margin-bottom: 1rem; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-file-invoice-dollar" style="color: var(--primary-color);"></i> Quick Quick Invoice
                </h4>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="quickService"
                        style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Select
                        Service / Item</label>
                    <select id="quickService" class="form-control" style="width: 100%;">
                        <option value="">-- Choose a service --</option>
                        {% regroup services by department as services_by_dept %}
                        {% for dept in services_by_dept %}
                        {% if "Reception" not in dept.grouper.name %}
                        <optgroup label="{{ dept.grouper.name }}">
                            {% for service in dept.list %}
                            {% if "Consultation" not in service.name %}
                            <option value="{{ service.pk }}">{{ service.name }} (Ksh {{ service.price|format_number:2
                                }})</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <button id="generateInvoiceBtn" class="btn btn-primary" onclick="submitQuickInvoice()"
                    style="width: 100%; justify-content: center;">
                    <i class="fas fa-plus"></i> Process Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Processing Modal -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Process Payment Request</h3>
            <span class="close-payment">&times;</span>
        </div>
        <div class="modal-body">
            <div class="invoice-info">
                <p><strong>Patient:</strong> <span id="paymentPatientName"></span></p>
                <p><strong>Service:</strong> <span id="paymentServiceName"></span></p>
                <p><strong>Amount:</strong> <span id="paymentAmount" class="amount-highlight"></span></p>
                <p><strong>Status:</strong> <span id="paymentStatus"></span></p>
            </div>

            {% if not invoice.paid %}
            <div class="payment-options">
                <h4>Select Payment Method:</h4>
                <div class="payment-methods">
                    <button id="mpesaPaymentBtn" class="payment-method-btn">
                        <i class="fas fa-mobile-alt"></i>
                        <div>
                            <strong>M-Pesa</strong>
                            <small>Mobile money payment</small>
                        </div>
                    </button>
                    <button id="cashPaymentBtn" class="payment-method-btn">
                        <i class="fas fa-money-bill-wave"></i>
                        <div>
                            <strong>Cash</strong>
                            <small>Physical cash payment</small>
                        </div>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="already-paid">
                <i class="fas fa-check-circle"></i>
                <p>This invoice has already been paid.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Triage Entry Modal -->
<div id="triageModal" class="modal">
    <div class="modal-content triage-modal-content">
        <div class="modal-header">
            <h3>Add Triage Entry</h3>
            <span class="close-triage">&times;</span>
        </div>
        <div class="modal-body">
            <form id="triageForm">
                <div class="patient-info">
                    <p><strong>Patient:</strong> <span id="triagePatientName"></span></p>
                    <p><strong>Visit Date:</strong> <span id="triageVisitDate"></span></p>
                    <p><strong>Services:</strong> <span id="triageVisitServices"
                            style="color: var(--primary-color); font-weight: bold;"></span></p>
                </div>

                <div class="form-section">
                    <h4>Triage Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select name="category" id="category" class="form-control" required>
                                <option value="">Select Category</option>
                                <option value="GENERAL">General</option>
                                <option value="EMERGENCY">Emergency</option>
                                <option value="PEDIATRIC">Pediatric</option>
                                <option value="MATERNITY">Maternity</option>
                                <option value="SURGERY">Surgery</option>
                                <option value="CARDIAC">Cardiac</option>
                                <option value="NEURO">Neurological</option>
                                <option value="RESPIRATORY">Respiratory</option>
                                <option value="ORTHOPEDIC">Orthopedic</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority</label>
                            <select name="priority" id="priority" class="form-control" required>
                                <option value="">Select Priority</option>
                                <option value="CRITICAL">Critical</option>
                                <option value="HIGH">High</option>
                                <option value="MEDIUM" selected>Medium</option>
                                <option value="LOW">Low</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>Vital Signs</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="temperature">Temperature (°C)</label>
                            <input type="number" name="temperature" id="temperature" class="form-control" step="0.1"
                                min="35" max="42">
                        </div>
                        <div class="form-group">
                            <label for="heart_rate">Heart Rate (bpm)</label>
                            <input type="number" name="heart_rate" id="heart_rate" class="form-control" min="30"
                                max="200">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="blood_pressure_systolic">BP Systolic (mmHg)</label>
                            <input type="number" name="blood_pressure_systolic" id="blood_pressure_systolic"
                                class="form-control" min="60" max="250">
                        </div>
                        <div class="form-group">
                            <label for="blood_pressure_diastolic">BP Diastolic (mmHg)</label>
                            <input type="number" name="blood_pressure_diastolic" id="blood_pressure_diastolic"
                                class="form-control" min="40" max="150">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="respiratory_rate">Respiratory Rate (breaths/min)</label>
                            <input type="number" name="respiratory_rate" id="respiratory_rate" class="form-control"
                                min="8" max="40">
                        </div>
                        <div class="form-group">
                            <label for="oxygen_saturation">O2 Saturation (%)</label>
                            <input type="number" name="oxygen_saturation" id="oxygen_saturation" class="form-control"
                                min="70" max="100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="blood_glucose">Blood Glucose (mg/dL)</label>
                            <input type="number" name="blood_glucose" id="blood_glucose" class="form-control" step="0.1"
                                min="20" max="500">
                        </div>
                        <div class="form-group">
                            <label for="weight">Weight (kg)</label>
                            <input type="number" name="weight" id="weight" class="form-control" step="0.1" min="1"
                                max="300">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="height">Height (cm)</label>
                            <input type="number" name="height" id="height" class="form-control" step="0.1" min="50"
                                max="250">
                        </div>
                        <div class="form-group">
                            <label for="disposition">Disposition</label>
                            <input type="text" name="disposition" id="disposition" class="form-control"
                                placeholder="e.g., Send to Emergency Room">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="send_to" style="color: var(--primary-color); font-weight: 600;">Assign to
                                Consultation Room</label>
                            <select name="send_to" id="send_to" class="form-control" required
                                style="border-color: var(--primary-color); border-width: 2px;">
                                <option value="">-- Select Room --</option>
                                <option value="1">Consultation Room 1</option>
                                <option value="2">Consultation Room 2</option>
                                <option value="3">Consultation Room 3</option>
                                <option value="4">Consultation Room 4</option>
                                <option value="5">Consultation Room 5</option>
                                <option value="Maternity">Maternity (ANC/PNC)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>Assessment Notes</h4>
                    <div class="form-group">
                        <label for="triage_notes">Triage Notes</label>
                        <textarea name="triage_notes" id="triage_notes" class="form-control" rows="4"
                            placeholder="Enter triage nurse assessment notes..."></textarea>
                    </div>
                </div>

                <input type="hidden" name="visit_id" id="visitId">

            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelTriageBtn">Cancel</button>
            <button type="submit" form="triageForm" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Triage Entry
            </button>
        </div>
    </div>
</div>

<style>
    /* Stats Container */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
        border-left: 4px solid var(--primary-color);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--primary-color), #7c3aed);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .stat-content h3 {
        margin: 0 0 0.5rem 0;
        color: #64748b;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #1e293b;
        margin: 0;
    }

    .add-patient-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--primary-color), #7c3aed);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .add-patient-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        background: linear-gradient(135deg, var(--primary-color-dark), #6d28d9);
    }

    /* Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Section Styles */
    .section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .section-header {
        background: linear-gradient(135deg, var(--primary-color), #7c3aed);
        color: white;
        padding: 1.25rem;
        border-bottom: 2px solid var(--primary-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
    }

    .reload-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .reload-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .reload-btn.loading {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Search Section */
    .search-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .search-container {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 300px;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .search-btn,
    .clear-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .search-btn {
        background-color: var(--primary-color);
        color: white;
    }

    .clear-btn {
        background-color: #6c757d;
        color: white;
    }

    .search-btn:hover {
        background-color: var(--primary-color-dark);
    }

    .clear-btn:hover {
        background-color: #5a6268;
    }

    .search-results-info {
        padding: 1rem 1.5rem;
        background: #f0f9ff;
        color: #0369a1;
        font-size: 0.9rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .search-results-info strong {
        font-weight: 600;
    }

    .bg-light-danger {
        background-color: #fff1f2 !important;
    }

    .text-danger {
        color: #dc2626 !important;
    }

    .font-weight-bold {
        font-weight: 700;
    }

    /* Table Styles */
    .invoice-table,
    .patient-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .invoice-table th,
    .patient-table th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
    }

    .invoice-table td,
    .patient-table td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
    }

    .invoice-table tbody tr:hover,
    .patient-table tbody tr:hover {
        background-color: #f8fafc;
    }

    .invoice-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .status-unpaid {
        background: #fef2f2;
        color: #dc2626;
    }

    .status-paid {
        background: #f0fdf4;
        color: #16a34a;
    }

    .patient-name {
        font-weight: 600;
        color: #1e293b;
    }

    .service-name {
        color: var(--primary-color);
        font-weight: 500;
    }

    .price {
        font-weight: 600;
        color: #059669;
    }

    .date {
        color: #64748b;
        font-size: 0.9rem;
    }

    .btn-view {
        background-color: #007bff;
        color: white;
        padding: 0.375rem 0.75rem;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.875rem;
        display: inline-block;
        transition: background-color 0.2s ease;
    }

    .btn-view:hover {
        background-color: #0056b3;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .no-records {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
        font-style: italic;
    }

    .table-responsive {
        overflow-x: auto;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 99999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary-color), #7c3aed);
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
    }

    .close {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }

    .close:hover {
        opacity: 1;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-body p {
        margin: 0 0 1.5rem 0;
        font-size: 1.1rem;
        color: #374151;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .action-buttons .btn {
        flex: 1;
        min-width: 200px;
        padding: 1rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .action-buttons .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .action-buttons .btn-primary:hover {
        background-color: var(--primary-color-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }

    .action-buttons .btn-success {
        background-color: #10b981;
        color: white;
    }

    .action-buttons .btn-success:hover {
        background-color: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Patient Row Clickable */
    .patient-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .patient-row:hover {
        background-color: #f0f9ff !important;
    }

    .patient-row:hover .patient-name {
        color: var(--primary-color);
    }

    /* Triage Table Styles */
    .triage-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .triage-table th,
    .triage-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .triage-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
    }

    .triage-row {
        transition: background-color 0.2s ease;
    }

    .triage-row:hover {
        background-color: #f0f9ff !important;
    }

    .triage-row:hover .patient-name {
        color: var(--primary-color);
    }

    /* Priority Badges */
    .priority-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .priority-critical {
        background-color: #fee2e2;
        color: #dc2626;
    }

    .priority-high {
        background-color: #fed7aa;
        color: #ea580c;
    }

    .priority-medium {
        background-color: #fef3c7;
        color: #d97706;
    }

    .priority-low {
        background-color: #dbeafe;
        color: #2563eb;
    }

    /* Pending Visits Table */
    .pending-visits-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .pending-visits-table th,
    .pending-visits-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .pending-visits-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
    }

    .pending-visit-row {
        transition: background-color 0.2s ease;
    }

    .pending-visit-row:hover {
        background-color: #f0f9ff !important;
    }

    .pending-visit-row:hover .patient-name {
        color: var(--primary-color);
    }

    .start-triage-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .start-triage-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Premium Table Redesign */
    .premium-table {
        width: 100%;
        border-collapse: collapse;
    }

    .premium-table th {
        background: #f8fafc;
        padding: 1rem 1.25rem;
        text-align: left;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        color: #64748b;
        border-bottom: 1px solid #e2e8f0;
    }

    .premium-table td {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .patient-profile-inline {
        display: flex;
        align-items: center;
        gap: 0.875rem;
    }

    .avatar-initials {
        width: 40px;
        height: 40px;
        background: #94a3b8;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
        font-size: 0.875rem;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Avatar Color Groups */
    .avatar-initials[data-name^="A"],
    .avatar-initials[data-name^="B"],
    .avatar-initials[data-name^="C"] {
        background: #4f46e5;
    }

    .avatar-initials[data-name^="D"],
    .avatar-initials[data-name^="E"],
    .avatar-initials[data-name^="F"] {
        background: #10b981;
    }

    .avatar-initials[data-name^="G"],
    .avatar-initials[data-name^="H"],
    .avatar-initials[data-name^="I"] {
        background: #f59e0b;
    }

    .avatar-initials[data-name^="J"],
    .avatar-initials[data-name^="K"],
    .avatar-initials[data-name^="L"] {
        background: #ef4444;
    }

    .avatar-initials[data-name^="M"],
    .avatar-initials[data-name^="N"],
    .avatar-initials[data-name^="O"] {
        background: #8b5cf6;
    }

    .avatar-initials[data-name^="P"],
    .avatar-initials[data-name^="Q"],
    .avatar-initials[data-name^="R"] {
        background: #ec4899;
    }

    .avatar-initials[data-name^="S"],
    .avatar-initials[data-name^="T"],
    .avatar-initials[data-name^="U"] {
        background: #06b6d4;
    }

    .avatar-initials[data-name^="V"],
    .avatar-initials[data-name^="W"],
    .avatar-initials[data-name^="X"],
    .avatar-initials[data-name^="Y"],
    .avatar-initials[data-name^="Z"] {
        background: #334155;
    }

    .name-id {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
    }

    .full-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.9375rem;
    }

    .patient-id {
        font-size: 0.75rem;
        color: #94a3b8;
        font-family: 'Courier New', Courier, monospace;
    }

    .visit-time {
        font-size: 0.75rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Vitals Display */
    .vitals-display {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .vital-item {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        background: #f8fafc;
        padding: 0.375rem 0.625rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        color: #475569;
        font-weight: 500;
        border: 1px solid #e2e8f0;
    }

    .vital-item i {
        color: var(--primary-color);
        width: 12px;
        text-align: center;
    }

    /* Modern Priority Badges */
    .priority-badge-modern {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .priority-badge-modern i {
        font-size: 0.5rem;
    }

    .priority-badge-modern.priority-critical {
        background: #fef2f2;
        color: #dc2626;
        box-shadow: 0 0 0 1px #fee2e2;
    }

    .priority-badge-modern.priority-high {
        background: #fff7ed;
        color: #ea580c;
        box-shadow: 0 0 0 1px #ffedd5;
    }

    .priority-badge-modern.priority-medium {
        background: #fffbeb;
        color: #d97706;
        box-shadow: 0 0 0 1px #fef3c7;
    }

    .priority-badge-modern.priority-low {
        background: #f0fdf4;
        color: #16a34a;
        box-shadow: 0 0 0 1px #dcfce7;
    }

    .time-cell {
        font-size: 0.875rem;
        color: #64748b;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Visit Reason Box */
    .visit-reason-box {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .reason-text {
        font-size: 0.875rem;
        color: #334155;
        font-weight: 500;
    }

    .visit-type-tag {
        font-size: 0.6875rem;
        text-transform: uppercase;
        color: #94a3b8;
        font-weight: 700;
        letter-spacing: 0.05em;
    }

    /* Triage Action Button */
    .btn-triage-start {
        background: linear-gradient(135deg, var(--primary-color), #7c3aed);
        color: white;
        border: none;
        padding: 0.625rem 1.125rem;
        border-radius: 10px;
        font-size: 0.8125rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }

    .btn-triage-start:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
    }

    .text-right {
        text-align: right;
    }

    /* Empty States */
    .empty-state-small {
        padding: 2.5rem 1rem;
        text-align: center;
        color: #94a3b8;
    }

    .empty-state-small i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state-small p {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 500;
    }

    /* Invoice Row Clickable */
    .invoice-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .invoice-row:hover {
        background-color: #f0f9ff !important;
    }

    .invoice-row:hover .patient-name {
        color: var(--primary-color);
    }

    .invoice-row:hover .service-name {
        color: var(--primary-color);
    }

    /* Payment Modal Specific Styles */
    .invoice-info {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-color);
    }

    .invoice-info p {
        margin: 0.5rem 0;
        display: flex;
        justify-content: space-between;
    }

    .amount-highlight {
        color: #059669;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .payment-options h4 {
        margin: 0 0 1rem 0;
        color: #374151;
        font-size: 1.1rem;
    }

    .payment-methods {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .payment-method-btn {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
    }

    .payment-method-btn:hover {
        border-color: var(--primary-color);
        background: #f0f9ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
    }

    .payment-method-btn i {
        font-size: 2rem;
        color: var(--primary-color);
    }

    .payment-method-btn div {
        flex: 1;
    }

    .payment-method-btn strong {
        display: block;
        color: #1f2937;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .payment-method-btn small {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .already-paid {
        text-align: center;
        padding: 2rem;
        color: #059669;
    }

    .already-paid i {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }

    .already-paid p {
        font-size: 1.1rem;
        margin: 0;
    }

    /* Triage Modal Specific Styles */
    .triage-modal-content {
        max-width: 800px;
        width: 95%;
        max-height: 85vh;
        margin: 2vh auto;
    }

    .triage-modal-content .modal-header,
    .triage-modal-content .modal-footer {
        flex-shrink: 0;
    }

    .triage-modal-content .modal-body {
        overflow-y: auto;
        flex-grow: 1;
        padding: 1.5rem;
    }

    .patient-info {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-color);
    }

    .patient-info p {
        margin: 0.5rem 0;
        display: flex;
        justify-content: space-between;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section h4 {
        margin: 0 0 1rem 0;
        color: #374151;
        font-size: 1.1rem;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-control {
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-control:invalid {
        border-color: #ef4444;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
        transform: translateY(-1px);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: 1fr;
        }

        .search-container {
            flex-direction: column;
            align-items: stretch;
        }

        .search-input {
            min-width: auto;
        }

        .search-btn,
        .clear-btn {
            width: 100%;
            justify-content: center;
        }

        .invoice-table,
        .patient-table {
            font-size: 0.875rem;
        }

        .invoice-table th,
        .invoice-table td,
        .patient-table th,
        .patient-table td {
            padding: 0.5rem;
        }
    }

    @media (max-width: 576px) {
        .content-grid {
            grid-template-columns: 1fr;
        }

        .stat-card {
            flex-direction: column;
            text-align: center;
        }

        .invoice-table th:nth-child(4),
        .invoice-table td:nth-child(4),
        .patient-table th:nth-child(3),
        .patient-table td:nth-child(3),
        .patient-table th:nth-child(4),
        .patient-table td:nth-child(4) {
            display: none;
        }
    }

    .patient-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .patient-row:hover {
        background-color: #f1f5f9 !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const reloadBtn = document.getElementById('reloadInvoices');
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        const patientActionModal = document.getElementById('patientActionModal');
        const paymentModal = document.getElementById('paymentModal');
        const triageModal = document.getElementById('triageModal');
        const modalPatientName = document.getElementById('modalPatientName');
        const admitVisitBtn = document.getElementById('admitVisitBtn');
        const closeBtn = document.querySelector('.close');
        const closePaymentBtn = document.querySelector('.close-payment');
        const closeTriageBtn = document.querySelector('.close-triage');

        // Payment modal elements
        const paymentPatientName = document.getElementById('paymentPatientName');
        const paymentServiceName = document.getElementById('paymentServiceName');
        const paymentAmount = document.getElementById('paymentAmount');
        const paymentStatus = document.getElementById('paymentStatus');
        const mpesaPaymentBtn = document.getElementById('mpesaPaymentBtn');
        const cashPaymentBtn = document.getElementById('cashPaymentBtn');

        // Triage modal elements
        const triagePatientName = document.getElementById('triagePatientName');
        const triageVisitDate = document.getElementById('triageVisitDate');
        const triageForm = document.getElementById('triageForm');
        const visitIdInput = document.getElementById('visitId');
        const cancelTriageBtn = document.getElementById('cancelTriageBtn');

        let currentPatientId = null;
        let currentInvoiceId = null;
        let currentInvoiceAmount = null;
        let currentVisitId = null;

        // Invoice reload functionality (only for receptionists)
        if (reloadBtn) {
            reloadBtn.addEventListener('click', function () {
                // Add loading state
                reloadBtn.classList.add('loading');
                reloadBtn.disabled = true;

                // Get current search term
                const searchInput = document.querySelector('input[name="invoice_search"]');
                const searchTerm = searchInput ? searchInput.value : '';

                // Build URL with search parameter
                const url = new URL(window.location.href);
                if (searchTerm) {
                    url.searchParams.set('invoice_search', searchTerm);
                } else {
                    url.searchParams.delete('invoice_search');
                }

                // Fetch updated invoice data
                fetch(url.href + '&ajax=1')
                    .then(response => response.text())
                    .then(html => {
                        // Create a temporary DOM element to parse the response
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        // Find the updated invoice table body
                        const newTableBody = tempDiv.querySelector('#invoiceTableBody');
                        if (newTableBody) {
                            invoiceTableBody.innerHTML = newTableBody.innerHTML;
                        }

                        // Update search results info if it exists
                        const oldSearchInfo = document.querySelector('.search-results-info');
                        const newSearchInfo = tempDiv.querySelector('.search-results-info');
                        if (oldSearchInfo && newSearchInfo) {
                            oldSearchInfo.innerHTML = newSearchInfo.innerHTML;
                        } else if (!oldSearchInfo && newSearchInfo) {
                            // Insert search info after search section
                            const searchSection = document.querySelector('.search-section');
                            searchSection.insertAdjacentHTML('afterend', newSearchInfo.outerHTML);
                        } else if (oldSearchInfo && !newSearchInfo) {
                            oldSearchInfo.remove();
                        }

                        // Show success feedback
                        showNotification('Invoice data refreshed successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error refreshing invoices:', error);
                        showNotification('Error refreshing invoice data. Please try again.', 'error');
                    })
                    .finally(() => {
                        // Remove loading state
                        reloadBtn.classList.remove('loading');
                        reloadBtn.disabled = false;
                    });
            });
        }

        // Invoice row click functionality
        document.addEventListener('click', function (e) {
            const invoiceRow = e.target.closest('.invoice-row');
            if (invoiceRow) {
                const invoiceId = invoiceRow.dataset.invoiceId;
                const patientName = invoiceRow.dataset.patientName;
                const serviceName = invoiceRow.dataset.serviceName;
                const price = invoiceRow.dataset.price;
                const status = invoiceRow.dataset.status;

                currentInvoiceId = invoiceId;
                currentInvoiceAmount = price;

                // Populate payment modal
                paymentPatientName.textContent = patientName;
                paymentServiceName.textContent = serviceName;
                paymentAmount.textContent = 'Ksh ' + parseFloat(price).toLocaleString();
                paymentStatus.textContent = status;
                paymentStatus.className = status === 'Paid' ? 'status-paid' : 'status-unpaid';

                // Show/hide payment options based on status
                const paymentOptions = paymentModal.querySelector('.payment-options');
                const alreadyPaidSection = paymentModal.querySelector('.already-paid');

                if (status === 'Paid') {
                    if (paymentOptions) paymentOptions.style.display = 'none';
                    if (alreadyPaidSection) alreadyPaidSection.style.display = 'block';
                } else {
                    if (paymentOptions) paymentOptions.style.display = 'block';
                    if (alreadyPaidSection) alreadyPaidSection.style.display = 'none';
                }

                paymentModal.style.display = 'block';
            }
        });

        // Patient row click functionality
        document.addEventListener('click', function (e) {
            const patientRow = e.target.closest('.patient-row');
            if (patientRow && !e.target.closest('.btn')) {
                // Don't trigger if clicking on the View button
                const patientId = patientRow.dataset.patientId;
                const patientName = patientRow.dataset.patientName;

                currentPatientId = patientId;
                modalPatientName.textContent = patientName;
                patientActionModal.style.display = 'block';
            }
        });

        // Modal close functionality
        closeBtn.addEventListener('click', function () {
            patientActionModal.style.display = 'none';
            currentPatientId = null;
        });

        closePaymentBtn.addEventListener('click', function () {
            paymentModal.style.display = 'none';
            currentInvoiceId = null;
        });

        closeTriageBtn.addEventListener('click', function () {
            triageModal.style.display = 'none';
            currentVisitId = null;
            triageForm.reset();
        });

        window.addEventListener('click', function (e) {
            if (e.target === patientActionModal) {
                patientActionModal.style.display = 'none';
                currentPatientId = null;
            }
            if (e.target === paymentModal) {
                paymentModal.style.display = 'none';
                currentInvoiceId = null;
            }
            if (e.target === triageModal) {
                triageModal.style.display = 'none';
                currentVisitId = null;
                triageForm.reset();
            }
        });

        // Modal action buttons

        admitVisitBtn.addEventListener('click', function () {
            if (currentPatientId) {
                const consultationId = document.getElementById('admitConsultation').value;
                const paymentMethod = document.getElementById('admitPaymentMethod').value;

                if (!consultationId || !paymentMethod) {
                    showNotification('Please select both consultation type and payment method.', 'error');
                    return;
                }

                // Show processing notification
                showNotification('Processing admission and billing...', 'info');
                admitVisitBtn.disabled = true;

                // Create a new visit and process billing
                fetch('{% url "home:admit_patient_visit" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `patient_id=${currentPatientId}&consultation_id=${consultationId}&payment_method=${paymentMethod}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message || 'Patient admitted successfully!', 'success');
                            patientActionModal.style.display = 'none';
                            // Reload the page to show the new visit in the queue
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showNotification('Error: ' + data.error, 'error');
                            admitVisitBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error admitting patient:', error);
                        showNotification('An error occurred during admission. Please try again.', 'error');
                        admitVisitBtn.disabled = false;
                    });
            }
        });

        // Payment method buttons (only for receptionists)
        if (mpesaPaymentBtn && cashPaymentBtn) {
            mpesaPaymentBtn.addEventListener('click', function () {
                if (currentInvoiceId) {
                    processPayment('mpesa');
                }
            });

            cashPaymentBtn.addEventListener('click', function () {
                if (currentInvoiceId) {
                    processPayment('cash');
                }
            });
        }

        // Start Triage button functionality (for Triage Nurses)
        document.addEventListener('click', function (e) {
            const startTriageBtn = e.target.closest('.start-triage-btn');
            if (startTriageBtn) {
                e.preventDefault();
                e.stopPropagation();

                const visitId = startTriageBtn.dataset.visitId;
                const patientName = startTriageBtn.dataset.patientName;
                const visitDate = startTriageBtn.dataset.visitDate || new Date().toLocaleString();
                const isMaternity = startTriageBtn.dataset.isMaternity === 'true';
                const services = startTriageBtn.dataset.services || 'Standard Check-up';

                console.log('Start Triage clicked:', { visitId, patientName, visitDate, isMaternity });

                // Set current visit ID
                currentVisitId = visitId;

                // Populate triage modal
                triagePatientName.textContent = patientName;
                triageVisitDate.textContent = visitDate;
                document.getElementById('triageVisitServices').textContent = services;
                visitIdInput.value = visitId;

                // Auto-select for maternity if applicable
                if (isMaternity) {
                    const categorySelect = document.getElementById('category');
                    const sendToSelect = document.getElementById('send_to');
                    if (categorySelect) categorySelect.value = 'MATERNITY';
                    if (sendToSelect) sendToSelect.value = 'Maternity';
                    showNotification('Maternity visit detected. Routing pre-selected.', 'info');
                }

                // Show triage modal
                triageModal.style.display = 'block';
                console.log('Triage modal should be visible now');
            }
        });

        // Cancel triage button
        if (cancelTriageBtn) {
            cancelTriageBtn.addEventListener('click', function () {
                triageModal.style.display = 'none';
                currentVisitId = null;
                triageForm.reset();
            });
        }

        // Triage form submission
        if (triageForm) {
            triageForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Get form data
                const formData = new FormData(triageForm);

                // Show processing notification
                showNotification('Saving triage entry...', 'info');

                // Submit triage data
                fetch('/home/triage/create/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Triage entry saved successfully!', 'success');
                            triageModal.style.display = 'none';
                            triageForm.reset();
                            currentVisitId = null;

                            // Reload the page to show updated triage entries
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showNotification('Error saving triage entry: ' + data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving triage entry:', error);
                        showNotification('Error saving triage entry. Please try again.', 'error');
                    });
            });
        }

        function processPayment(method) {
            // Disable buttons to prevent double click
            if (mpesaPaymentBtn) mpesaPaymentBtn.disabled = true;
            if (cashPaymentBtn) cashPaymentBtn.disabled = true;

            // Show processing notification
            showNotification(`Processing ${method.toUpperCase()} payment...`, 'info');

            // Send payment to backend
            const formData = new URLSearchParams();
            formData.append('amount', currentInvoiceAmount);
            formData.append('payment_method', method);
            formData.append('reference', method === 'mpesa' ? 'Mobile Payment' : 'Cash Payment');

            fetch(`/accounts/invoice/${currentInvoiceId}/payment/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`${method.toUpperCase()} payment processed successfully!`, 'success');
                        paymentModal.style.display = 'none';

                        // Force a full page reload to ensure state consistency and prevent double clicks
                        // especially for the 'Process Quick Invoice' flow which might be behind this
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showNotification('Payment processing failed: ' + (data.error || 'Unknown error'), 'error');
                        // Re-enable buttons if payment failed
                        if (mpesaPaymentBtn) mpesaPaymentBtn.disabled = false;
                        if (cashPaymentBtn) cashPaymentBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Payment processing error:', error);
                    showNotification('Error connecting to server. Please check your connection.', 'error');
                    // Re-enable buttons if payment failed
                    if (mpesaPaymentBtn) mpesaPaymentBtn.disabled = false;
                    if (cashPaymentBtn) cashPaymentBtn.disabled = false;
                });
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;

            // Add notification styles
            notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        `;

            if (type === 'success') {
                notification.style.background = '#10b981';
            } else if (type === 'error') {
                notification.style.background = '#ef4444';
            } else if (type === 'info') {
                notification.style.background = '#3b82f6';
            }

            // Add to page
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // New Quick Invoice Function
        window.submitQuickInvoice = function () {
            const serviceId = document.getElementById('quickService').value;
            if (!serviceId) {
                showNotification('Please select a service first', 'error');
                return;
            }

            if (!currentPatientId) {
                showNotification('Patient context lost. Please try again.', 'error');
                return;
            }

            showNotification('Generating invoice...', 'info');

            const formData = new FormData();
            formData.append('patient_id', currentPatientId);
            formData.append('tests', serviceId); // Using 'tests' key as per submit_next_action view

            fetch('{% url "home:submit_next_action" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Invoice generated successfully!', 'success');
                        patientActionModal.style.display = 'none';
                        // Redirect to the new invoice
                        if (data.invoice_id) {
                            setTimeout(() => {
                                window.location.href = `/accounts/invoice/${data.invoice_id}/`;
                            }, 1000);
                        } else {
                            reloadBtn.click();
                        }
                    } else {
                        showNotification('Error: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error generating invoice:', error);
                    showNotification('An error occurred. Please try again.', 'error');
                });
        }
    });
</script>
{% endblock %}