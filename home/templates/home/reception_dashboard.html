{% extends 'users/dashboard_base.html' %}
{% load custom_filters %}
{% block title %}Reception Dashboard - HMS{% endblock %}
{% block content %}
    <style>
    :root {
        --reception-gradient-1: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --reception-gradient-2: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        --reception-gradient-3: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        --reception-gradient-4: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --reception-bg: #0f172a;
        --reception-card-bg: #1e293b;
        --reception-border: rgba(148, 163, 184, 0.1);
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --glass-bg: rgba(30, 41, 59, 0.7);
        --glass-border: rgba(255, 255, 255, 0.05);
    }

    body {
        background: var(--reception-bg);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
    }

    .container {
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Hero Section */
    .reception-hero {
        background: var(--reception-gradient-1);
        padding: 3rem 2rem;
        border-radius: 24px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
        box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.4);
    }

    .reception-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        filter: blur(80px);
    }

    .hero-content h1 {
        font-size: 2.5rem;
        font-weight: 900;
        color: white;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .hero-content p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        margin: 0;
    }

    .hero-actions {
        display: flex;
        gap: 1rem;
        position: relative;
        z-index: 1;
    }

    .quick-action-btn {
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        color: white;
        text-decoration: none;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.3s;
    }

    .quick-action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    /* Analytics Grid */
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .stat-card {
        background: var(--reception-card-bg);
        border: 1px solid var(--reception-border);
        border-radius: 20px;
        padding: 2rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient, var(--reception-gradient-1));
    }

    .stat-card:hover {
        transform: translateY(-8px);
        border-color: rgba(148, 163, 184, 0.3);
        box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.3);
    }

    .stat-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }

    .stat-info h3 {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }

    .stat-info .number {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--text-primary);
        line-height: 1;
    }

    /* Layout Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 2rem;
    }

    .section {
        background: var(--reception-card-bg);
        border: 1px solid var(--reception-border);
        border-radius: 24px;
        padding: 0;
        overflow: hidden;
        box-shadow: 0 20px 50px -20px rgba(0, 0, 0, 0.3);
        margin-bottom: 2rem;
    }

    .section-header {
        padding: 1.75rem 2rem;
        border-bottom: 1px solid var(--reception-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.02);
    }

    .section-header h3 {
        font-size: 1.35rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .search-section {
        padding: 1.25rem 2rem;
        background: rgba(255, 255, 255, 0.01);
        border-bottom: 1px solid var(--reception-border);
    }

    .search-input {
        width: 100%;
        padding: 1rem 1.25rem 1rem 3.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--reception-border);
        border-radius: 16px;
        color: var(--text-primary);
        font-size: 0.95rem;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.08);
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    /* Premium Table Styling */
    .premium-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .premium-table th {
        padding: 1.25rem 2rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid var(--reception-border);
    }

    .premium-table td {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--reception-border);
        color: var(--text-primary);
        vertical-align: middle;
    }

    .premium-table tr:hover td {
        background: rgba(255, 255, 255, 0.03);
    }

    /* Badges & Tags */
    .invoice-status,
    .priority-badge-modern {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .status-paid {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .status-unpaid {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .status-partial {
        background: rgba(99, 102, 241, 0.15);
        color: #6366f1;
    }

    .priority-critical {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .priority-high {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .priority-medium {
        background: rgba(99, 102, 241, 0.15);
        color: #6366f1;
    }

    .priority-low {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .patient-profile-inline {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .avatar-initials {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        background: var(--reception-gradient-1);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
    }

    .name-id {
        display: flex;
        flex-direction: column;
    }

    .full-name {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .patient-id {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .visit-time {
        font-size: 0.75rem;
        color: #10b981;
        margin-top: 0.2rem;
    }

    /* Tabs Component */
    .tabs-header {
        display: flex;
        gap: 1rem;
        padding: 1rem 2rem 0;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid var(--reception-border);
    }

    .dashboard-tab {
        padding: 1rem 1.5rem;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 700;
        color: var(--text-secondary);
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dashboard-tab.active {
        color: white;
        border-bottom-color: #6366f1;
    }

    .tab-content {
        display: none;
        padding: 0;
    }

    .tab-content.active {
        display: block;
    }

    /* Modern Modals */
    .clinical-modal {
        display: none;
        position: fixed;
        z-index: 99999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(10px);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--reception-card-bg);
        border: 1px solid var(--reception-border);
        border-radius: 28px;
        width: 90%;
        max-width: 650px;
        box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.6);
        max-height: 90vh;
        overflow-y: auto;
        position: relative !important;
        z-index: 100000 !important;
        pointer-events: auto !important;
    }

    .modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--reception-border);
        background: rgba(255, 255, 255, 0.03);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 800;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-body {
        padding: 2rem;
    }

    .form-control,
    .clinical-input {
        background: #1a202c !important;
        /* Ultimate dark background */
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        border-radius: 14px !important;
        color: #ffffff !important;
        /* Pure white text for max visibility */
        padding: 0.875rem 1.25rem !important;
        width: 100% !important;
        transition: all 0.3s !important;
        font-family: inherit !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        box-shadow: none !important;
        cursor: pointer;
        position: relative;
        z-index: 100005;
        pointer-events: auto !important;
    }

    .form-control:focus,
    .clinical-input:focus {
        background: #242c3d !important;
        border-color: #6366f1 !important;
        outline: none !important;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2) !important;
    }

    /* Target all inputs and selects globally in this page to be sure */
    input,
    select,
    textarea,
    .form-control,
    .clinical-input {
        background-image: none;
        background-color: #1a202c !important;
        color: #ffffff !important;
        pointer-events: auto !important;
    }

    /* Style for select dropdowns to ensure dark theme */
    select.form-control,
    select.clinical-input {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 1rem center !important;
        background-size: 1.25rem !important;
        padding-right: 3rem !important;
    }

    .form-control option,
    .clinical-input option {
        background-color: #1a202c !important;
        color: white !important;
    }

    .form-grid-modern {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-primary {
        background: var(--reception-gradient-1);
        color: white;
        border: none;
        padding: 0.875rem 1.75rem;
        border-radius: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        text-decoration: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        padding: 0.875rem 1.75rem;
        border-radius: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .close,
    .close-payment,
    .close-triage {
        color: var(--text-secondary);
        font-size: 1.75rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .close:hover {
        color: white;
        transform: rotate(90deg);
    }

    /* Miscellanous */
    .empty-state-small {
        padding: 3rem;
        text-align: center;
        color: var(--text-secondary);
    }

    .empty-state-small i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--reception-bg);
    }

    ::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #475569;
    }

    .reload-btn {
        background: none;
        border: 1px solid var(--reception-border);
        color: var(--text-secondary);
        padding: 0.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .reload-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }
    </style>
    <div class="container">
        <!-- Hero Section -->
        <div class="reception-hero">
            <div class="hero-content">
                <h1>
                    <i class="fas fa-hospital-user"></i> Reception Dashboard
                </h1>
                <p>Streamlined patient intake and coordination hub</p>
            </div>
            <div class="hero-actions">
                {% if user_role == 'Receptionist' or user_role == 'Admin' %}
                    <a href="{% url 'home:patient_create' %}" class="quick-action-btn">
                        <i class="fas fa-plus-circle"></i> Add New Patient
                    </a>
                {% endif %}
            </div>
        </div>
        <!-- Analytics Cards -->
        <div class="analytics-grid">
            <div class="stat-card" style="--gradient: var(--reception-gradient-1)">
                <div class="stat-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-info">
                    <h3>Today's Visits</h3>
                    <div class="number">{{ today_visits }}</div>
                </div>
            </div>
            <div class="stat-card" style="--gradient: var(--reception-gradient-2)">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>Total Patients</h3>
                    <div class="number">{{ total_patients }}</div>
                </div>
            </div>
            {% if user_role == 'Receptionist' or user_role == 'Admin' %}
                <div class="stat-card" style="--gradient: var(--reception-gradient-3)">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Unpaid Invoices</h3>
                        <div class="number">{{ unpaid_invoices }}</div>
                    </div>
                </div>
            {% elif user_role == 'Triage Nurse' %}
                <div class="stat-card" style="--gradient: var(--reception-gradient-3)">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Today's Triage</h3>
                        <div class="number">{{ today_triage_entries }}</div>
                    </div>
                </div>
                <div class="stat-card" style="--gradient: var(--reception-gradient-4)">
                    <div class="stat-icon">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Pending Triage</h3>
                        <div class="number">{{ pending_triage_count }}</div>
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="content-gid">
            {% if user_role == 'Receptionist' or user_role == 'Admin' %}
                <div class="section">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-file-invoice-dollar"></i> Patient Service Invoices
                        </h3>
                        <button id="reloadInvoices" class="reload-btn" title="Reload Invoice Data">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="search-section">
                        <form method="GET" class="search-form">
                            <div class="search-container" style="position: relative;">
                                <i class="fas fa-search" style="position: absolute; left: 1.25rem; top: 1.15rem; color: var(--text-secondary); pointer-events: none;"></i>
                                <input type="text" name="invoice_search" class="search-input" placeholder="Search by patient name or service name..." value="{{ invoice_search }}">
                                {% if invoice_search %}
                                    <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                                        <i class="fas fa-times"></i> Clear
                                    </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    {% if invoice_search %}
                        <div class="search-results-info">
                            Found <strong>{{ invoices|length }}</strong> invoice(s) matching "<strong>{{ invoice_search }}</strong>"
                        </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Service</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceTableBody">
                                {% for invoice in invoices %}
                                    <tr class="invoice-row" data-invoice-id="{{ invoice.pk }}" style="cursor: pointer;" data-patient-name="{% if invoice.patient %}{{ invoice.patient.full_name }}{% else %}{{ invoice.deceased.full_name }}{% endif %}" data-service-name="{% for item in invoice.items.all %}{{ item.name }}{% if not forloop.last %}, {% endif %}{% empty %}No services{% endfor %}" data-price="{{ invoice.balance }}" data-status="{{ invoice.status }}">
                                        <td class="patient-name">
                                            <div class="patient-profile-inline">
                                                <div class="avatar-initials" data-name="{% if invoice.patient %}{{ invoice.patient.first_name }}{% else %}{{ invoice.deceased.first_name }}{% endif %}">
                                                    {% if invoice.patient %}
                                                        {{ invoice.patient.first_name|first }}{{ invoice.patient.last_name|first }}
                                                    {% else %}
                                                        {{ invoice.deceased.first_name|first }}{{ invoice.deceased.last_name|first }}
                                                    {% endif %}
                                                </div>
                                                <div class="name-id">
                                                    <span class="full-name">
                                                        {% if invoice.patient %}
                                                            {{ invoice.patient.full_name }}
                                                        {% elif invoice.deceased %}
                                                            <span class="text-danger">{{ invoice.deceased.full_name }}</span>
                                                        {% else %}
                                                            Unknown
                                                        {% endif %}
                                                    </span>
                                                    <span class="patient-id">#INV-{{ invoice.pk|stringformat:"05d" }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="service-name-cell">
                                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                                {% for item in invoice.items.all %}
                                                    <span style="font-size: 0.85rem; font-weight: 600; color: #6366f1;">{{ item.name }}</span>
                                                {% empty %}
                                                    <span class="text-secondary">No services</span>
                                                {% endfor %}
                                            </div>
                                        </td>
                                        <td class="price">Ksh {{ invoice.balance|format_number:2 }}</td>
                                        <td>
                                            <span class="invoice-status status-{{ invoice.status|lower }}">
                                                <i class="fas {% if invoice.status == 'Paid' %}fa-check-circle{% else %}fa-clock{% endif %}"></i>
                                                {{ invoice.status }}
                                            </span>
                                        </td>
                                        <td class="date">
                                            <div class="time-cell">
                                                <i class="far fa-calendar-alt"></i> {{ invoice.created_at|date:"M d, Y" }}
                                                <span style="display: block; font-size: 0.75rem; color: var(--text-secondary);">{{ invoice.created_at|date:"H:i" }}</span>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="no-records">
                                            <div class="empty-state-small">
                                                <i class="fas fa-file-invoice"></i>
                                                <p>No invoices found matching your criteria.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% elif user_role == 'Triage Nurse' %}
                <div class="section">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-clipboard-list"></i> Recent Triage Entries
                        </h3>
                        <button class="reload-btn" onclick="location.reload()" title="Refresh entries">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="search-section">
                        <form method="GET" class="search-form">
                            <div class="search-container" style="position: relative;">
                                <i class="fas fa-search" style="position: absolute; left: 1.25rem; top: 1.15rem; color: var(--text-secondary); pointer-events: none;"></i>
                                <input type="text" name="triage_search" class="search-input" placeholder="Search by patient name or phone..." value="{{ triage_search }}">
                                {% if triage_search %}
                                    <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                                        <i class="fas fa-times"></i> Clear
                                    </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    {% if triage_search %}
                        <div class="search-results-info">
                            Found <strong>{{ triage_entries|length }}</strong> entry(s) matching "<strong>{{ triage_search }}</strong>"
                        </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Vitals</th>
                                    <th>Priority Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for triage in triage_entries %}
                                    <tr class="triage-row" data-triage-id="{{ triage.pk }}">
                                        <td>
                                            <div class="patient-profile-inline">
                                                <div class="avatar-initials" data-name="{{ triage.visit.patient.first_name }}">{{ triage.visit.patient.first_name|first }}{{ triage.visit.patient.last_name|first }}</div>
                                                <div class="name-id">
                                                    <span class="full-name">{{ triage.visit.patient.first_name }}
                                                    {{ triage.visit.patient.last_name }}</span>
                                                    <span class="patient-id">#PAT-{{ triage.visit.patient.pk|stringformat:"05d" }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="vitals-display">
                                                <span class="vital-item" title="Temperature">
                                                    <i class="fas fa-thermometer-half"></i> {{ triage.temperature }}Â°C
                                                </span>
                                                <span class="vital-item" title="Blood Pressure">
                                                    <i class="fas fa-heartbeat"></i> {{ triage.blood_pressure }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="priority-badge-modern priority-{{ triage.priority|lower }}">
                                                <i class="fas fa-circle"></i> {{ triage.get_priority_display }}
                                            </span>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="no-records">
                                            <div class="empty-state-small">
                                                <i class="fas fa-clipboard-list"></i>
                                                <p>No triage entries found today.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-hourglass-half"></i> Visits Pending Triage
                        </h3>
                        <button class="reload-btn" onclick="location.reload()" title="Refresh visits">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="search-section">
                        <form method="GET" class="search-form">
                            <div class="search-container" style="position: relative;">
                                <i class="fas fa-search" style="position: absolute; left: 1.25rem; top: 1.15rem; color: var(--text-secondary); pointer-events: none;"></i>
                                <input type="text" name="pending_search" class="search-input" placeholder="Search by patient name or phone..." value="{{ pending_search }}">
                                {% if pending_search %}
                                    <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                                        <i class="fas fa-times"></i> Clear
                                    </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    {% if pending_search %}
                        <div class="search-results-info">
                            Found <strong>{{ visits_without_triage|length }}</strong> visit(s) matching "<strong>{{ pending_search }}</strong>"
                        </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Patient Info</th>
                                    <th>Visit Reason</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for visit in visits_without_triage %}
                                    <tr class="pending-visit-row" data-visit-id="{{ visit.pk }}">
                                        <td>
                                            <div class="patient-profile-inline">
                                                <div class="avatar-initials" data-name="{{ visit.patient.first_name }}">{{ visit.patient.first_name|first }}{{ visit.patient.last_name|first }}</div>
                                                <div class="name-id">
                                                    <span class="full-name">{{ visit.patient.full_name }}</span>
                                                    <span class="visit-time"><i class="far fa-clock"></i> {{ visit.visit_date|date:"H:i" }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="visit-reason-box">
                                                <span class="reason-text">{{ visit.services_summary|default:"Standard Check-up"|truncatechars:60 }}</span>
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                                                    <span class="visit-type-tag">{{ visit.get_visit_type_display }}</span>
                                                    {% if visit.is_maternity %}
                                                        <span class="badge" style="background: rgba(231, 84, 128, 0.15); color: #e75480; border: 1px solid rgba(231, 84, 128, 0.3); font-size: 0.65rem; font-weight: 700; padding: 1px 6px; border-radius: 4px;">
                                                            <i class="fas fa-baby-carriage"></i> MATERNITY
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-right">
                                            <button class="btn-triage-start" data-visit-id="{{ visit.pk }}" data-patient-name="{{ visit.patient.full_name }}" data-visit-date="{{ visit.visit_date|date:'M d, Y H:i' }}" data-is-maternity="{{ visit.is_maternity|yesno:'true,false' }}" data-services="{{ visit.services_summary }}">
                                                <i class="fas fa-stethoscope"></i> Triage
                                            </button>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="no-records">
                                            <div class="empty-state-small">
                                                <i class="fas fa-check-double"></i>
                                                <p>All clear! No visits pending triage.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
            {% if user_role == 'Receptionist' or user_role == 'Admin' %}
                <!-- IPD & Morgue Section -->
                <div class="section admission-morgue-section" style="grid-column: span 2;">
                    <div class="tab-container">
                        <div class="tabs-header">
                            <button class="dashboard-tab active" onclick="switchDashboardTab(event, 'ipd-tab')">
                                <i class="fas fa-procedures"></i> IPD Admissions
                            </button>
                            <button class="dashboard-tab" onclick="switchDashboardTab(event, 'morgue-tab')">
                                <i class="fas fa-box"></i> Morgue Cases
                            </button>
                        </div>
                        <div id="ipd-tab" class="tab-content active">
                            <div class="table-responsive">
                                <table class="premium-table">
                                    <thead>
                                        <tr>
                                            <th>Patient</th>
                                            <th>Ward/Bed</th>
                                            <th>Admitted At</th>
                                            <th class="text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for admission in ipd_admissions %}
                                            <tr>
                                                <td>
                                                    <div class="patient-profile-inline">
                                                        <div class="avatar-initials" data-name="{{ admission.patient.first_name }}">
                                                            {{ admission.patient.first_name|first }}{{ admission.patient.last_name|first }}
                                                        </div>
                                                        <div class="name-id">
                                                            <span class="full-name">{{ admission.patient.full_name }}</span>
                                                            <span class="patient-id">#PAT-{{ admission.patient.id|stringformat:"05d" }}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div style="font-weight: 600; color: #10b981;">{{ admission.bed.ward.name }}</div>
                                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                                        Bed: {{ admission.bed.bed_number }}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="time-cell">
                                                        <i class="far fa-calendar-alt"></i> {{ admission.admitted_at|date:"M d, Y" }}
                                                        <span style="display: block; font-size: 0.75rem; color: var(--text-secondary);">{{ admission.admitted_at|date:"H:i" }}</span>
                                                    </div>
                                                </td>
                                                <td class="text-right">
                                                    <a href="{% url 'accounts:discharge_detail' 'ipd' admission.id %}" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                                        <i class="fas fa-file-invoice-dollar"></i> Discharge
                                                    </a>
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="4" class="no-records">
                                                    <div class="empty-state-small">
                                                        <i class="fas fa-procedures"></i>
                                                        <p>No active IPD admissions.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="morgue-tab" class="tab-content" style="display: none;">
                            <div class="table-responsive">
                                <table class="premium-table">
                                    <thead>
                                        <tr>
                                            <th>Deceased</th>
                                            <th>Tag/Number</th>
                                            <th>Status</th>
                                            <th class="text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for admission in morgue_admissions %}
                                            <tr>
                                                <td>
                                                    <div class="patient-profile-inline">
                                                        <div class="avatar-initials" data-name="{{ admission.deceased.first_name }}" style="background: #475569;">
                                                            {{ admission.deceased.first_name|first }}{{ admission.deceased.last_name|first }}
                                                        </div>
                                                        <div class="name-id">
                                                            <span class="full-name text-danger">{{ admission.deceased.full_name }}</span>
                                                            <span class="patient-id">S/N: {{ admission.admission_number }}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="invoice-status status-unpaid">{{ admission.deceased.tag }}</span>
                                                </td>
                                                <td>
                                                    <div class="time-cell">
                                                        <i class="far fa-calendar-alt"></i> {{ admission.admission_datetime|date:"M
                                                        d, Y" }}
                                                        <span style="display: block; font-size: 0.75rem; color: var(--text-secondary);">{{
                                                        admission.admission_datetime|date:"H:i" }}</span>
                                                    </div>
                                                </td>
                                                <td class="text-right">
                                                    <a href="{% url 'accounts:discharge_detail' 'morgue' admission.id %}" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                                        <i class="fas fa-file-invoice-dollar"></i> Release
                                                    </a>
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="4" class="no-records">
                                                    <div class="empty-state-small">
                                                        <i class="fas fa-door-closed"></i>
                                                        <p>No active morgue cases.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            {% if user_role == 'Receptionist' or user_role == 'Admin' %}
                <div class="section" style="grid-column: span 2;">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-users-cog"></i> Recent Patient Directory
                        </h3>
                    </div>
                    <div class="search-section">
                        <form method="GET" class="search-form">
                            <div class="search-container" style="position: relative;">
                                <i class="fas fa-search" style="position: absolute; left: 1.25rem; top: 1.15rem; color: var(--text-secondary); pointer-events: none;"></i>
                                <input type="text" name="patient_search" class="search-input" placeholder="Search by name, phone, or location..." value="{{ patient_search }}">
                                {% if patient_search %}
                                    <a href="{% url 'home:reception_dashboard' %}" class="btn btn-secondary clear-btn">
                                        <i class="fas fa-times"></i> Clear
                                    </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    {% if patient_search %}
                        <div class="search-results-info">
                            Found <strong>{{ patients|length }}</strong> patient(s) matching "<strong>{{ patient_search }}</strong>"
                        </div>
                    {% endif %}
                    <div class="table-responsive">
                        <table class="premium-table">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Age/Gender</th>
                                    <th>Contact</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody id="patientTableBody">
                                {% for patient in patients %}
                                    <tr class="patient-row" data-patient-id="{{ patient.pk }}" data-patient-name="{{ patient.full_name }}">
                                        <td>
                                            <div class="patient-profile-inline">
                                                <div class="avatar-initials" data-name="{{ patient.first_name }}">{{ patient.first_name|first }}{{ patient.last_name|first }}</div>
                                                <div class="name-id">
                                                    <span class="full-name">{{ patient.full_name }}</span>
                                                    <span class="patient-id">#PAT-{{ patient.pk|stringformat:"05d" }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <span style="font-weight: 600;">{{ patient.age }} yrs</span>
                                                <span class="invoice-status status-partial" style="font-size: 0.65rem;">{{
                                                patient.get_gender_display }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="font-size: 0.85rem; color: var(--text-primary);">
                                                <i class="fas fa-phone-alt" style="font-size: 0.75rem; color: #10b981; margin-right: 0.5rem;"></i>{{
                                                patient.phone }}
                                            </div>
                                        </td>
                                        <td>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                <i class="fas fa-map-marker-alt" style="font-size: 0.75rem; margin-right: 0.5rem;"></i>{{ patient.location }}
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="no-records">
                                            <div class="empty-state-small">
                                                <i class="fas fa-user-slash"></i>
                                                <p>No patients found.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    <script>
    function switchDashboardTab(evt, tabId) {
        const container = evt.currentTarget.closest('.tab-container');

        // Hide all tab content
        const tabContents = container.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));

        // Remove active class from all tabs
        const tabs = container.querySelectorAll('.dashboard-tab');
        tabs.forEach(tab => tab.classList.remove('active'));

        // Show current tab content and set active class
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
    </script>
{% endblock %}
{% block modals %}
    <!-- Patient Action Modal -->
    <div id="patientActionModal" class="clinical-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-user-gear"></i> Patient Actions
                </h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 2.5rem;">
                    Selecting action for <strong id="modalPatientName" style="color: white; font-size: 1.2rem;"></strong>
                </p>
                <div class="action-card" style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 20px; padding: 2.5rem; margin-bottom: 2.5rem; display: flex; flex-direction: column; gap: 2rem;">
                    <h4 style="margin: 0; color: #10b981; display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: 800; letter-spacing: 0.5px;">
                        <i class="fas fa-hospital-user"></i> ADMIT FOR CONSULTATION
                    </h4>
                    <div class="form-group">
                        <label for="admitConsultation" style="display: block; margin-bottom: 1rem; font-weight: 700; font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
                            Consultation
                            Type
                        </label>
                        <select id="admitConsultation" class="clinical-input" style="cursor: pointer;">
                            <option value="">-- Select Consultation --</option>
                            {% for service in services %}
                                {% if "Consultation" in service.name or "PNC" in service.name or "ANC" in service.name or "CWC" in service.name %}<option value="{{ service.pk }}">{{ service.name }} (Ksh {{ service.price|format_number:0 }})</option>{% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <button id="admitVisitBtn" class="btn-primary" style="width: 100%; justify-content: center; padding: 1.5rem; border-radius: 18px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 30px -5px rgba(16, 185, 129, 0.4); cursor: pointer; position: relative; z-index: 100006; pointer-events: auto;">
                        <i class="fas fa-check-circle"></i> Complete Admission
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 1.5rem; margin: 3rem 0;">
                    <div style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></div>
                    <span style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 800; letter-spacing: 2px;">OR</span>
                    <div style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></div>
                </div>
                <div class="action-card" style="background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 20px; padding: 2.5rem; display: flex; flex-direction: column; gap: 2rem;">
                    <h4 style="margin: 0; color: #6366f1; display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: 800; letter-spacing: 0.5px;">
                        <i class="fas fa-bolt"></i> QUICK SERVICE INVOICE
                    </h4>
                    <div class="form-group">
                        <label for="quickService" style="display: block; margin-bottom: 1rem; font-weight: 700; font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
                            Select
                            Service / Item
                        </label>
                        <select id="quickService" class="clinical-input" style="cursor: pointer;">
                            <option value="">-- Choose a service --</option>
                            {% regroup services by department as services_by_dept %}
                            {% for dept in services_by_dept %}
                                {% if "Reception" not in dept.grouper.name %}
                                    <optgroup label="{{ dept.grouper.name }}">
                                        {% for service in dept.list %}
                                            {% if "Consultation" not in service.name %}<option value="{{ service.pk }}">{{ service.name }} (Ksh {{ service.price|format_number:2 }})</option>{% endif %}
                                        {% endfor %}
                                    </optgroup>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <button id="generateInvoiceBtn" class="btn-primary" onclick="submitQuickInvoice()" style="width: 100%; justify-content: center; padding: 1.5rem; border-radius: 18px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 30px -5px rgba(99, 102, 241, 0.4); cursor: pointer; position: relative; z-index: 100006; pointer-events: auto;">
                        <i class="fas fa-file-invoice-dollar"></i> Process Quick Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Payment Processing Modal -->
    <div id="paymentModal" class="clinical-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-credit-card"></i> Process Payment
                </h3>
                <span class="close-payment">&times;</span>
            </div>
            <div class="modal-body">
                <div class="invoice-details-premium" style="background: rgba(255, 255, 255, 0.03); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid #6366f1;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">Patient</span>
                        <strong id="paymentPatientName" style="color: white;"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">Service</span>
                        <span id="paymentServiceName" style="font-weight: 600; color: #6366f1;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--reception-border);">
                        <span style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 700;">AMOUNT DUE</span>
                        <strong id="paymentAmount" style="font-size: 1.5rem; color: #10b981;"></strong>
                    </div>
                </div>
                <div class="payment-options">
                    <div class="payment-methods-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button id="mpesaPaymentBtn" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: all 0.3s;">
                            <i class="fas fa-mobile-screen-button" style="font-size: 2rem; color: #10b981; margin-bottom: 1rem; display: block;"></i>
                            <strong style="color: white; display: block;">M-PESA</strong>
                            <small style="color: var(--text-secondary);">Mobile Money</small>
                        </button>
                        <button id="cashPaymentBtn" style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: all 0.3s;">
                            <i class="fas fa-money-bill-transfer" style="font-size: 2rem; color: #6366f1; margin-bottom: 1rem; display: block;"></i>
                            <strong style="color: white; display: block;">CASH</strong>
                            <small style="color: var(--text-secondary);">Physical Payment</small>
                        </button>
                    </div>
                </div>
                <div class="already-paid" style="display: none; text-align: center; padding: 2rem;">
                    <div style="background: rgba(16, 185, 129, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981;"></i>
                    </div>
                    <h4 style="color: #10b981; font-size: 1.5rem; margin-bottom: 0.5rem;">Payment Complete</h4>
                    <p style="color: var(--text-secondary);">This invoice has been fully paid.</p>
                    <button onclick="window.print()" class="btn-secondary" style="margin-top: 1.5rem;">
                        <i class="fas fa-print"></i> Print Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Triage Entry Modal -->
    <div id="triageModal" class="clinical-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-heart-pulse"></i> Clinical Triage Assessment
                </h3>
                <span class="close-triage">&times;</span>
            </div>
            <div class="modal-body">
                <form id="triageForm">
                    <div class="patient-banner" style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 1.25rem; border-radius: 16px; margin-bottom: 2rem;">
                        <div>
                            <span style="display: block; font-size: 0.75rem; color: var(--text-secondary); font-weight: 700; text-transform: uppercase;">Patient
                            Name</span>
                            <strong id="triagePatientName" style="font-size: 1.1rem; color: white;"></strong>
                        </div>
                        <div>
                            <span style="display: block; font-size: 0.75rem; color: var(--text-secondary); font-weight: 700; text-transform: uppercase;">Visit
                            Activity</span>
                            <span id="triageVisitServices" style="font-weight: 600; color: #6366f1;"></span>
                        </div>
                        <div>
                            <span style="display: block; font-size: 0.75rem; color: var(--text-secondary); font-weight: 700; text-transform: uppercase;">Visit
                            Time</span>
                            <span id="triageVisitDate" style="color: white;"></span>
                        </div>
                    </div>
                    <div class="form-grid-modern">
                        <div class="form-group">
                            <label>Category</label>
                            <select name="category" id="category" class="clinical-input" required>
                                <option value="">Select Category</option>
                                <option value="GENERAL">General</option>
                                <option value="EMERGENCY">Emergency</option>
                                <option value="PEDIATRIC">Pediatric</option>
                                <option value="MATERNITY">Maternity</option>
                                <option value="SURGERY">Surgery</option>
                                <option value="ORTHOPEDIC">Orthopedic</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select name="priority" id="priority" class="clinical-input" required>
                                <option value="CRITICAL">Critical (Immediate)</option>
                                <option value="HIGH">High (Urgent)</option>
                                <option value="MEDIUM" selected>Medium (Standard)</option>
                                <option value="LOW">Low (Routine)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Temperature (Â°C)</label>
                            <input type="number" name="temperature" class="clinical-input" step="0.1" placeholder="36.5">
                        </div>
                        <div class="form-group">
                            <label>
                                BP Systolic (mmHg) <span style="color: red;">*</span>
                            </label>
                            <input type="number" name="blood_pressure_systolic" class="clinical-input" placeholder="120" required>
                        </div>
                        <div class="form-group">
                            <label>
                                BP Diastolic (mmHg) <span style="color: red;">*</span>
                            </label>
                            <input type="number" name="blood_pressure_diastolic" class="clinical-input" placeholder="80" required>
                        </div>
                        <div class="form-group">
                            <label>
                                O2 Saturation (%) <span style="color: red;">*</span>
                            </label>
                            <input type="number" name="oxygen_saturation" class="clinical-input" placeholder="98" required>
                        </div>
                        <div class="form-group">
                            <label>
                                Weight (kg) <span style="color: red;">*</span>
                            </label>
                            <input type="number" name="weight" class="clinical-input" placeholder="70.5" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>
                                Height (cm) <span style="color: red;">*</span>
                            </label>
                            <input type="number" name="height" class="clinical-input" placeholder="175" required>
                        </div>
                        <div class="form-group">
                            <label>Assignment Room</label>
                            <select name="send_to" id="send_to" class="clinical-input" required style="border-color: #6366f1 !important;">
                                <option value="">-- Select Destination --</option>
                                <option value="1">Consultation Room 1</option>
                                <option value="2">Consultation Room 2</option>
                                <option value="3">Consultation Room 3</option>
                                <option value="4">Consultation Room 4</option>
                                <option value="5">Consultation Room 5</option>
                                <option value="ANC">Maternity - ANC</option>
                                <option value="PNC">Maternity - PNC</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>Assessment & Triage Notes</label>
                        <textarea name="triage_notes" class="clinical-input" rows="3" placeholder="Enter clinical observations..."></textarea>
                    </div>
                    <input type="hidden" name="visit_id" id="visitId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelTriageBtn">Cancel</button>
                <button type="submit" form="triageForm" class="btn-primary">
                    <i class="fas fa-save"></i> Finalize Triage
                </button>
            </div>
        </div>
    </div>
{% endblock modals %}
{% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const reloadBtn = document.getElementById('reloadInvoices');
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        const patientActionModal = document.getElementById('patientActionModal');
        const paymentModal = document.getElementById('paymentModal');
        const triageModal = document.getElementById('triageModal');
        const modalPatientName = document.getElementById('modalPatientName');
        const admitVisitBtn = document.getElementById('admitVisitBtn');
        const closeBtn = document.querySelector('.close');
        const closePaymentBtn = document.querySelector('.close-payment');
        const closeTriageBtn = document.querySelector('.close-triage');

        // Payment modal elements
        const paymentPatientName = document.getElementById('paymentPatientName');
        const paymentServiceName = document.getElementById('paymentServiceName');
        const paymentAmount = document.getElementById('paymentAmount');
        // paymentStatus removed in new design
        const mpesaPaymentBtn = document.getElementById('mpesaPaymentBtn');
        const cashPaymentBtn = document.getElementById('cashPaymentBtn');

        // Triage modal elements
        const triagePatientName = document.getElementById('triagePatientName');
        const triageVisitDate = document.getElementById('triageVisitDate');
        const triageForm = document.getElementById('triageForm');
        const visitIdInput = document.getElementById('visitId');
        const cancelTriageBtn = document.getElementById('cancelTriageBtn');

        let currentPatientId = null;
        let currentInvoiceId = null;
        let currentInvoiceAmount = null;
        let currentVisitId = null;

        // Invoice reload functionality (only for receptionists)
        if (reloadBtn) {
            reloadBtn.addEventListener('click', function () {
                // Add loading state
                reloadBtn.classList.add('loading');
                reloadBtn.disabled = true;

                // Get current search term
                const searchInput = document.querySelector('input[name="invoice_search"]');
                const searchTerm = searchInput ? searchInput.value : '';

                // Build URL with search parameter
                const url = new URL(window.location.href);
                if (searchTerm) {
                    url.searchParams.set('invoice_search', searchTerm);
                } else {
                    url.searchParams.delete('invoice_search');
                }

                // Fetch updated invoice data
                fetch(url.href + '&ajax=1')
                    .then(response => response.text())
                    .then(html => {
                        // Create a temporary DOM element to parse the response
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        // Find the updated invoice table body
                        const newTableBody = tempDiv.querySelector('#invoiceTableBody');
                        if (newTableBody) {
                            invoiceTableBody.innerHTML = newTableBody.innerHTML;
                        }

                        // Update search results info if it exists
                        const oldSearchInfo = document.querySelector('.search-results-info');
                        const newSearchInfo = tempDiv.querySelector('.search-results-info');
                        if (oldSearchInfo && newSearchInfo) {
                            oldSearchInfo.innerHTML = newSearchInfo.innerHTML;
                        } else if (!oldSearchInfo && newSearchInfo) {
                            // Insert search info after search section
                            const searchSection = document.querySelector('.search-section');
                            searchSection.insertAdjacentHTML('afterend', newSearchInfo.outerHTML);
                        } else if (oldSearchInfo && !newSearchInfo) {
                            oldSearchInfo.remove();
                        }

                        // Show success feedback
                        showNotification('Invoice data refreshed successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error refreshing invoices:', error);
                        showNotification('Error refreshing invoice data. Please try again.', 'error');
                    })
                    .finally(() => {
                        // Remove loading state
                        reloadBtn.classList.remove('loading');
                        reloadBtn.disabled = false;
                    });
            });
        }

        // Invoice row click functionality
        document.addEventListener('click', function (e) {
            const invoiceRow = e.target.closest('.invoice-row');
            if (invoiceRow) {
                console.log('Invoice row clicked');
                const invoiceId = invoiceRow.dataset.invoiceId;
                const patientName = invoiceRow.dataset.patientName;
                const serviceName = invoiceRow.dataset.serviceName;
                const price = invoiceRow.dataset.price;
                const status = invoiceRow.dataset.status;

                currentInvoiceId = invoiceId;
                currentInvoiceAmount = price;

                // Populate payment modal
                if (paymentPatientName) paymentPatientName.textContent = patientName;
                if (paymentServiceName) paymentServiceName.textContent = serviceName;
                if (paymentAmount) paymentAmount.textContent = 'Ksh ' + parseFloat(price).toLocaleString();

                // Show/hide payment options based on status
                const paymentOptions = paymentModal.querySelector('.payment-options');
                const alreadyPaidSection = paymentModal.querySelector('.already-paid');

                if (status === 'Paid') {
                    if (paymentOptions) paymentOptions.style.display = 'none';
                    if (alreadyPaidSection) alreadyPaidSection.style.display = 'block';
                } else {
                    if (paymentOptions) paymentOptions.style.display = 'block';
                    if (alreadyPaidSection) alreadyPaidSection.style.display = 'none';
                }

                paymentModal.style.display = 'flex';
            }
        });

        // Patient row click functionality
        document.addEventListener('click', function (e) {
            const patientRow = e.target.closest('.patient-row');
            if (patientRow && !e.target.closest('.btn')) {
                // Don't trigger if clicking on the View button
                const patientId = patientRow.dataset.patientId;
                const patientName = patientRow.dataset.patientName;

                currentPatientId = patientId;
                modalPatientName.textContent = patientName;
                patientActionModal.style.display = 'flex';
            }
        });

        // Modal close functionality
        closeBtn.addEventListener('click', function () {
            patientActionModal.style.display = 'none';
            currentPatientId = null;
        });

        closePaymentBtn.addEventListener('click', function () {
            paymentModal.style.display = 'none';
            currentInvoiceId = null;
        });

        closeTriageBtn.addEventListener('click', function () {
            triageModal.style.display = 'none';
            currentVisitId = null;
            triageForm.reset();
        });

        window.addEventListener('click', function (e) {
            if (e.target === patientActionModal) {
                patientActionModal.style.display = 'none';
                currentPatientId = null;
            }
            if (e.target === paymentModal) {
                paymentModal.style.display = 'none';
                currentInvoiceId = null;
            }
            if (e.target === triageModal) {
                triageModal.style.display = 'none';
                currentVisitId = null;
                triageForm.reset();
            }
        });

        // Modal action buttons

        admitVisitBtn.addEventListener('click', function () {
            if (currentPatientId) {
                const consultationId = document.getElementById('admitConsultation').value;

                if (!consultationId) {
                    showNotification('Please select a consultation type.', 'error');
                    return;
                }

                // Show processing notification
                showNotification('Processing admission...', 'info');
                admitVisitBtn.disabled = true;

                // Create a new visit (Free Revisit)
                fetch('{% url "home:admit_patient_visit" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `patient_id=${currentPatientId}&consultation_id=${consultationId}`
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message || 'Patient admitted successfully!', 'success');
                            patientActionModal.style.display = 'none';
                            // Reload the page to show the new visit in the queue
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showNotification('Error: ' + (data.error || 'Unknown error occurred'), 'error');
                            admitVisitBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error admitting patient:', error);
                        showNotification('An error occurred during admission. Please check your connection.', 'error');
                        admitVisitBtn.disabled = false;
                    });
            }
        });

        // Payment method buttons (only for receptionists)
        if (mpesaPaymentBtn && cashPaymentBtn) {
            mpesaPaymentBtn.addEventListener('click', function () {
                if (currentInvoiceId) {
                    processPayment('mpesa');
                }
            });

            cashPaymentBtn.addEventListener('click', function () {
                if (currentInvoiceId) {
                    processPayment('cash');
                }
            });
        }

        // Start Triage button functionality (for Triage Nurses)
        document.addEventListener('click', function (e) {
            const startTriageBtn = e.target.closest('.btn-triage-start');
            if (startTriageBtn) {
                console.log('Triage button clicked');
                e.preventDefault();
                e.stopPropagation();

                const visitId = startTriageBtn.dataset.visitId;
                const patientName = startTriageBtn.dataset.patientName;
                const visitDate = startTriageBtn.dataset.visitDate || new Date().toLocaleString();
                const isMaternity = startTriageBtn.dataset.isMaternity === 'true';
                const services = startTriageBtn.dataset.services || 'Standard Check-up';

                console.log('Start Triage clicked:', { visitId, patientName, visitDate, isMaternity });

                // Set current visit ID
                currentVisitId = visitId;

                // Populate triage modal
                triagePatientName.textContent = patientName;
                triageVisitDate.textContent = visitDate;
                document.getElementById('triageVisitServices').textContent = services;
                visitIdInput.value = visitId;

                // Auto-select for maternity if applicable
                if (isMaternity) {
                    const categorySelect = document.getElementById('category');
                    const sendToSelect = document.getElementById('send_to');
                    if (categorySelect) categorySelect.value = 'MATERNITY';
                    if (sendToSelect) sendToSelect.value = 'Maternity';
                    showNotification('Maternity visit detected. Routing pre-selected.', 'info');
                }

                // Show triage modal
                triageModal.style.display = 'flex';
                console.log('Triage modal should be visible now');
            }
        });

        // Cancel triage button
        if (cancelTriageBtn) {
            cancelTriageBtn.addEventListener('click', function () {
                triageModal.style.display = 'none';
                currentVisitId = null;
                triageForm.reset();
            });
        }

        // Triage form submission
        if (triageForm) {
            triageForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Get form data
                const formData = new FormData(triageForm);

                // Show processing notification
                showNotification('Saving triage entry...', 'info');

                // Submit triage data
                fetch('/home/triage/create/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Triage entry saved successfully!', 'success');
                            triageModal.style.display = 'none';
                            triageForm.reset();
                            currentVisitId = null;

                            // Reload the page to show updated triage entries
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showNotification('Error saving triage entry: ' + data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving triage entry:', error);
                        showNotification('Error saving triage entry. Please try again.', 'error');
                    });
            });
        }

        function processPayment(method) {
            // Disable buttons to prevent double click
            if (mpesaPaymentBtn) mpesaPaymentBtn.disabled = true;
            if (cashPaymentBtn) cashPaymentBtn.disabled = true;

            // Show processing notification
            showNotification(`Processing ${method.toUpperCase()} payment...`, 'info');

            // Send payment to backend
            const formData = new URLSearchParams();
            formData.append('amount', currentInvoiceAmount);
            formData.append('payment_method', method);
            formData.append('reference', method === 'mpesa' ? 'Mobile Payment' : 'Cash Payment');

            fetch(`/accounts/invoice/${currentInvoiceId}/payment/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`${method.toUpperCase()} payment processed successfully!`, 'success');
                        paymentModal.style.display = 'none';

                        // Force a full page reload to ensure state consistency and prevent double clicks
                        // especially for the 'Process Quick Invoice' flow which might be behind this
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showNotification('Payment processing failed: ' + (data.error || 'Unknown error'), 'error');
                        // Re-enable buttons if payment failed
                        if (mpesaPaymentBtn) mpesaPaymentBtn.disabled = false;
                        if (cashPaymentBtn) cashPaymentBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Payment processing error:', error);
                    showNotification('Error connecting to server. Please check your connection.', 'error');
                    // Re-enable buttons if payment failed
                    if (mpesaPaymentBtn) mpesaPaymentBtn.disabled = false;
                    if (cashPaymentBtn) cashPaymentBtn.disabled = false;
                });
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;

            // Add notification styles
            notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        `;

            if (type === 'success') {
                notification.style.background = '#10b981';
            } else if (type === 'error') {
                notification.style.background = '#ef4444';
            } else if (type === 'info') {
                notification.style.background = '#3b82f6';
            }

            // Add to page
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // New Quick Invoice Function
        window.submitQuickInvoice = function () {
            const serviceId = document.getElementById('quickService').value;
            if (!serviceId) {
                showNotification('Please select a service first', 'error');
                return;
            }

            if (!currentPatientId) {
                showNotification('Patient context lost. Please try again.', 'error');
                return;
            }

            showNotification('Generating invoice...', 'info');
            console.log('Submitting Quick Invoice:', { patientId: currentPatientId, serviceId: serviceId });

            const formData = new FormData();
            formData.append('patient_id', currentPatientId);
            formData.append('tests', serviceId); // Using 'tests' key as per submit_next_action view

            fetch('{% url "home:submit_next_action" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('Invoice generated successfully!', 'success');
                        patientActionModal.style.display = 'none';
                        // Redirect to the new invoice
                        if (data.invoice_id) {
                            setTimeout(() => {
                                window.location.href = `/accounts/invoice/${data.invoice_id}/`;
                            }, 1000);
                        } else {
                            reloadBtn.click();
                        }
                    } else {
                        showNotification('Error: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error generating invoice:', error);
                    showNotification('An error occurred. Please check your connection or contact support.', 'error');
                });
        }
    });
    </script>
{% endblock %}
