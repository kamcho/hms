{% extends 'users/dashboard_base.html' %}
{% load static %}
{% block title %}{{ title }} - HMS{% endblock %}
{% block content %}
    <style>
    :root {
        --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: rgba(255, 255, 255, 0.2);
        --input-bg: rgba(255, 255, 255, 0.8);
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .form-container {
        max-width: 800px;
        margin: 0 auto;
        animation: fadeInUp 0.6s ease-out;
    }

    .form-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 2.5rem;
        box-shadow: var(--card-shadow);
    }

    .form-header {
        margin-bottom: 2.5rem;
        text-align: center;
    }

    .form-header h2 {
        font-size: 1.75rem;
        font-weight: 700;
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .item-highlight {
        display: inline-block;
        background: var(--primary-gradient);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 9999px;
        font-weight: 600;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        border: 1px solid rgba(99, 102, 241, 0.2);
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group.full-width {
        grid-column: span 2;
    }

    .form-group label {
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        margin-left: 0.25rem;
        margin-bottom: 0.25rem;
    }

    /* Force visibility with higher specificity */
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="date"],
    .form-group select,
    .form-group textarea {
        background: white !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 12px;
        padding: 0.875rem 1rem !important;
        color: #1e293b !important;
        font-size: 1rem !important;
        transition: all 0.3s ease;
        font-weight: 500 !important;
    }

    /* Force focus visibility */
    .form-group input[type="text"]:focus,
    .form-group input[type="number"]:focus,
    .form-group input[type="date"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none !important;
        border-color: #6366f1 !important;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
        background: white !important;
        transform: translateY(-1px);
        color: #1e293b !important;
    }

    .form-actions {
        margin-top: 2.5rem;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .btn {
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        border: none;
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.8);
        color: var(--text-secondary);
        border: 2px solid var(--glass-border);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        transform: translateY(-1px);
        box-shadow: var(--card-shadow);
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Force placeholder visibility */
    .form-group input[type="text"]::placeholder,
    .form-group input[type="number"]::placeholder,
    .form-group textarea::placeholder {
        color: #94a3b8 !important;
        font-weight: 400 !important;
    }

    /* Force select option visibility */
    .form-group select option {
        color: #1e293b !important;
        background: white !important;
    }

    .errorlist {
        list-style: none;
        padding: 0;
        margin: 0.5rem 0 0 0.25rem;
        color: #dc2626;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .form-group input.error,
    .form-group select.error,
    .form-group textarea.error {
        border-color: #dc2626;
        background: rgba(239, 68, 68, 0.05);
    }
    </style>
    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h2>Add Physical Stock</h2>
                <div class="item-highlight">
                    <i class="fas fa-box"></i> {{ item.name }}
                </div>
                <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 1rem;">
                    Enter details for the specific
                    batch/shipment received.
                </p>
            </div>
            <form method="post" autocomplete="off">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.batch_number.id_for_label }}">Batch Number</label>
                        {{ form.batch_number }}
                        {{ form.batch_number.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.quantity.id_for_label }}">
                            Quantity (
                            {% if item.is_dispensed_as_whole and item.packaging_unit %}
                                {{ item.packaging_unit }}
                            {% else %}
                                {{ item.dispensing_unit }}
                            {% endif %}
                            )
                        </label>
                        {{ form.quantity }}
                        {{ form.quantity.errors }}
                        {% if item.is_dispensed_as_whole and item.packaging_unit %}
                            <small style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                                üì¶ Enter number of {{ item.packaging_unit }}s
                                {% if item.units_per_pack and item.units_per_pack > 1 %}(each = {{ item.units_per_pack }} {{ item.dispensing_unit }}s){% endif %}
                            </small>
                        {% else %}
                            <small style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem; display: block;">üíä Enter total {{ item.dispensing_unit }}s received</small>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.expiry_date.id_for_label }}">Expiry Date</label>
                        {{ form.expiry_date }}
                        {{ form.expiry_date.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.purchase_price.id_for_label }}">Total Purchase Price (for entire batch)</label>
                        {{ form.purchase_price }}
                        {{ form.purchase_price.errors }}
                        <small style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem; display: block;">üí∞ Enter total cost paid for this batch</small>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.supplier.id_for_label }}">Supplier</label>
                        {{ form.supplier }}
                        {{ form.supplier.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.current_location.id_for_label }}">Storage Location</label>
                        {{ form.current_location }}
                        {{ form.current_location.errors }}
                    </div>
                    <!-- Profit/Loss Calculator Section -->
                    <div class="form-group full-width" id="profitSection" style="display: none; margin-top: 1rem; padding: 1.5rem; border-radius: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.2);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <small style="display: block; color: #64748b; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Price
                                per Unit</small>
                                <div id="pricePerUnit" style="font-size: 1.25rem; font-weight: 700; color: #059669;">-</div>
                            </div>
                            <div>
                                <small style="display: block; color: #64748b; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Current
                                Selling Price</small>
                                <div id="currentSellingPrice" style="font-size: 1.25rem; font-weight: 700; color: #6366f1;">KES {{ item.selling_price }}</div>
                            </div>
                            <div>
                                <small style="display: block; color: #64748b; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Profit
                                per Unit</small>
                                <div id="profitPerUnit" style="font-size: 1.25rem; font-weight: 700;">-</div>
                            </div>
                            <div>
                                <small style="display: block; color: #64748b; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Profit
                                Margin</small>
                                <div id="profitMargin" style="font-size: 1.25rem; font-weight: 700;">-</div>
                            </div>
                        </div>
                    </div>
                    <!-- Loss Warning -->
                    <div class="form-group full-width" id="lossWarning" style="display: none; margin-top: 1rem; padding: 1rem 1.5rem; border-radius: 16px; background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc2626;"></i>
                            <div>
                                <div style="font-weight: 700; color: #dc2626; font-size: 1.125rem; margin-bottom: 0.25rem;">‚ö†Ô∏è LOSS DETECTED!</div>
                                <div style="color: #991b1b; font-size: 0.875rem;">
                                    Your purchase price is higher than the
                                    selling price. You will lose money on each sale. Consider updating the selling price
                                    below.
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Update Selling Price Option -->
                    <div class="form-group full-width" id="updatePriceSection" style="display: none; margin-top: 1rem; padding: 1.5rem; border-radius: 16px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%); border: 2px dashed rgba(99, 102, 241, 0.3);">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                <input type="checkbox" id="updateSellingPriceCheck" style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="font-weight: 700; color: #6366f1; font-size: 1rem;">
                                    <i class="fas fa-sync-alt"></i> Update Selling Price for "{{ item.name }}"
                                </span>
                            </label>
                            <small style="color: #64748b; margin-left: 2.25rem; display: block; margin-top: 0.25rem;">Check
                            this to update the selling price on the inventory item</small>
                        </div>
                        <div id="newPriceInput" style="display: none;">
                            <label for="new_selling_price" style="display: block; color: #1e293b; font-weight: 600; margin-bottom: 0.5rem;">
                                New Selling
                                Price (KES)
                            </label>
                            <input type="number" name="new_selling_price" id="newSellingPrice" step="0.01" min="0" placeholder="Enter new selling price" style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #6366f1; border-radius: 12px; font-size: 1rem; font-weight: 600; color: #1e293b; background: white;">
                            <small style="display: block; margin-top: 0.5rem; color: #64748b; font-size: 0.875rem;">
                                üí° Suggested: <span id="suggestedPrice" style="font-weight: 700; color: #059669;">-</span>
                                (25% profit margin)
                            </small>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <a href="{% url 'inventory:item_list' %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Add to Stock
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Use hardcoded IDs since Django generates them consistently
        const quantityInput = document.getElementById('id_quantity');
        const purchasePriceInput = document.getElementById('id_purchase_price');
        const updatePriceCheck = document.getElementById('updateSellingPriceCheck');
        const newPriceInput = document.getElementById('newPriceInput');
        const newSellingPriceInput = document.getElementById('newSellingPrice');

        const profitSection = document.getElementById('profitSection');
        const lossWarning = document.getElementById('lossWarning');
        const updatePriceSection = document.getElementById('updatePriceSection');

        const pricePerUnitDisplay = document.getElementById('pricePerUnit');
        const currentSellingPriceDisplay = document.getElementById('currentSellingPrice');
        const profitPerUnitDisplay = document.getElementById('profitPerUnit');
        const profitMarginDisplay = document.getElementById('profitMargin');
        const suggestedPriceDisplay = document.getElementById('suggestedPrice');

        const currentSellingPrice = {{ item.selling_price }};

    // Debug: Check if elements are found
    console.log('Quantity input:', quantityInput);
    console.log('Purchase price input:', purchasePriceInput);
    console.log('Current selling price:', currentSellingPrice);

    // Toggle new price input when checkbox is clicked
    updatePriceCheck.addEventListener('change', function () {
        if (this.checked) {
            newPriceInput.style.display = 'block';
            newSellingPriceInput.required = true;
        } else {
            newPriceInput.style.display = 'none';
            newSellingPriceInput.required = false;
            newSellingPriceInput.value = '';
        }
    });

    // Calculate profit/loss in real-time
    function calculateProfitLoss() {
        const quantity = parseFloat(quantityInput.value);
        const totalPurchasePrice = parseFloat(purchasePriceInput.value);

        if (!quantity || !totalPurchasePrice || quantity <= 0 || totalPurchasePrice <= 0) {
            // Hide all sections if inputs are invalid
            profitSection.style.display = 'none';
            lossWarning.style.display = 'none';
            updatePriceSection.style.display = 'none';
            return;
        }

        // Calculate price per unit
        const pricePerUnit = totalPurchasePrice / quantity;

        // Calculate profit/loss
        const profitPerUnit = currentSellingPrice - pricePerUnit;
        const profitMarginPercent = (profitPerUnit / pricePerUnit) * 100;

        // Calculate suggested price (25% markup)
        const suggestedPrice = pricePerUnit * 1.25;

        // Update displays
        pricePerUnitDisplay.textContent = `KES ${pricePerUnit.toFixed(2)}`;
        profitPerUnitDisplay.textContent = `KES ${profitPerUnit.toFixed(2)}`;
        profitMarginDisplay.textContent = `${profitMarginPercent.toFixed(1)}%`;
        suggestedPriceDisplay.textContent = `KES ${suggestedPrice.toFixed(2)}`;

        // Show profit section
        profitSection.style.display = 'block';
        updatePriceSection.style.display = 'block';

        // Check for loss
        if (profitPerUnit < 0) {
            // LOSS - Show warning
            lossWarning.style.display = 'block';
            profitPerUnitDisplay.style.color = '#dc2626';
            profitMarginDisplay.style.color = '#dc2626';
            pricePerUnitDisplay.style.color = '#dc2626';

            // Auto-fill suggested price
            if (!newSellingPriceInput.value) {
                newSellingPriceInput.value = suggestedPrice.toFixed(2);
            }
        } else if (profitPerUnit < (pricePerUnit * 0.1)) {
            // Low profit (less than 10%)
            lossWarning.style.display = 'none';
            profitPerUnitDisplay.style.color = '#f59e0b';
            profitMarginDisplay.style.color = '#f59e0b';
            pricePerUnitDisplay.style.color = '#059669';
        } else {
            // Good profit
            lossWarning.style.display = 'none';
            profitPerUnitDisplay.style.color = '#059669';
            profitMarginDisplay.style.color = '#059669';
            pricePerUnitDisplay.style.color = '#059669';
        }
    }

    // Update display when new selling price is entered
    newSellingPriceInput.addEventListener('input', function () {
        const newPrice = parseFloat(this.value);
        const quantity = parseFloat(quantityInput.value);
        const totalPurchasePrice = parseFloat(purchasePriceInput.value);

        if (newPrice && quantity && totalPurchasePrice) {
            const pricePerUnit = totalPurchasePrice / quantity;
            const newProfit = newPrice - pricePerUnit;
            const newMargin = (newProfit / pricePerUnit) * 100;

            currentSellingPriceDisplay.textContent = `KES ${newPrice.toFixed(2)} (NEW)`;
            currentSellingPriceDisplay.style.color = '#6366f1';
            profitPerUnitDisplay.textContent = `KES ${newProfit.toFixed(2)}`;
            profitMarginDisplay.textContent = `${newMargin.toFixed(1)}%`;

            if (newProfit < 0) {
                profitPerUnitDisplay.style.color = '#dc2626';
                profitMarginDisplay.style.color = '#dc2626';
            } else {
                profitPerUnitDisplay.style.color = '#059669';
                profitMarginDisplay.style.color = '#059669';
                lossWarning.style.display = 'none';
            }
        }
    });

    // Attach event listeners
    quantityInput.addEventListener('input', calculateProfitLoss);
    purchasePriceInput.addEventListener('input', calculateProfitLoss);

    // Form submission validation
    document.querySelector('form').addEventListener('submit', function (e) {
        const quantity = parseFloat(quantityInput.value);
        const totalPurchasePrice = parseFloat(purchasePriceInput.value);

        if (quantity && totalPurchasePrice) {
            const pricePerUnit = totalPurchasePrice / quantity;
            const effectiveSellingPrice = updatePriceCheck.checked && newSellingPriceInput.value ?
                parseFloat(newSellingPriceInput.value) : currentSellingPrice;

            if (pricePerUnit > effectiveSellingPrice) {
                if (!updatePriceCheck.checked) {
                    const confirmLoss = confirm(
                        `‚ö†Ô∏è WARNING: You are about to record a LOSS!\\n\\n` +
                        `Purchase price per unit: KES ${pricePerUnit.toFixed(2)}\\n` +
                        `Selling price: KES ${effectiveSellingPrice.toFixed(2)}\\n` +
                        `Loss per unit: KES ${(effectiveSellingPrice - pricePerUnit).toFixed(2)}\\n\\n` +
                        `Are you sure you want to continue without updating the selling price?`
                    );

                    if (!confirmLoss) {
                        e.preventDefault();
                        updatePriceCheck.focus();
                        return false;
                    }
                }
            }
        }
    });
});
    </script>
{% endblock %}
