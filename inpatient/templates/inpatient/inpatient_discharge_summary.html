{% extends 'users/dashboard_base.html' %}
{% load static %}
{% block title %}{{ title }} - Official Record{% endblock %}
{% block content %}
    <div class="px-8 py-10 max-w-[1000px] mx-auto no-print">
        <!-- Action Bar -->
        <div class="flex justify-between items-center mb-8">
            <a href="{% url 'home:patient_detail' discharge.admission.patient.pk %}" class="flex items-center gap-2 text-[11px] font-black uppercase tracking-widest text-slate-400 hover:text-indigo-600 transition-all">
                <i class="fas fa-arrow-left"></i> Patient Profile
            </a>
            <div class="flex items-center gap-3">
                <button onclick="window.print()" class="px-6 py-3 bg-white border border-slate-200 text-slate-900 text-[10px] font-black uppercase tracking-widest shadow-sm hover:bg-slate-50 transition-all flex items-center gap-2">
                    <i class="fas fa-print"></i> Quick Print
                </button>
                <a href="{% url 'inpatient:discharge_summary_print' discharge.id %}" target="_blank" class="px-6 py-3 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2">
                    <i class="fas fa-file-contract"></i> Print Full Official Form
                </a>
            </div>
        </div>
    </div>
    <!-- Printable Document -->
    <div class="max-w-[900px] mx-auto bg-white mb-20 print:mb-0 print:border-none border border-slate-200">
        <!-- Document Header (Ink Efficient) -->
        <div class="px-12 py-10 border-b-2 border-slate-900">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 flex items-center justify-center border-2 border-slate-900">
                        <i class="fas fa-file-medical-alt text-xl text-slate-900"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black uppercase tracking-tight text-slate-900">Discharge Summary</h1>
                        <p class="text-[9px] font-bold uppercase tracking-wider text-slate-500">Official Clinical Release Document</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-bold uppercase text-slate-400 tracking-widest">Document Reference</div>
                    <div class="text-xl font-black text-slate-900 mt-0.5">DIS-{{ discharge.id|stringformat:"04d" }}</div>
                </div>
            </div>
        </div>

        <div class="px-12 py-10">
            <!-- Identity Section -->
            <div class="grid grid-cols-2 gap-10 mb-10 pb-6 border-b border-slate-200">
                <div>
                    <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-4">Patient Information</h6>
                    <div class="space-y-3">
                        <div>
                            <div class="text-lg font-black text-slate-900">{{ discharge.admission.patient.full_name }}</div>
                            <div class="text-[10px] font-bold text-slate-500 mt-0.5 uppercase">
                                ID: {{ discharge.admission.patient.id_number|default:"N/A" }}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div>
                                <div class="text-[9px] font-bold text-slate-400 uppercase">Age / Gender</div>
                                <div class="text-sm font-bold text-slate-900">
                                    {{ discharge.admission.patient.age }}Y â€¢ {{ discharge.admission.patient.get_gender_display }}
                                </div>
                            </div>
                            <div>
                                <div class="text-[9px] font-bold text-slate-400 uppercase">Visit ID</div>
                                <div class="text-sm font-bold text-slate-900">#{{ discharge.admission.visit.id }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-4">Admission Details</h6>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-[9px] font-bold text-slate-400 uppercase">Admitted</div>
                                <div class="text-sm font-bold text-slate-900">{{ discharge.admission.admitted_at|date:"d M Y" }}</div>
                            </div>
                            <div>
                                <div class="text-[9px] font-bold text-slate-400 uppercase">Discharged</div>
                                <div class="text-sm font-bold text-slate-900">{{ discharge.discharge_date|date:"d M Y" }}</div>
                            </div>
                        </div>
                        <div>
                            <div class="text-[9px] font-bold text-slate-400 uppercase">Discharge Time</div>
                            <div class="text-sm font-bold text-slate-900">{{ discharge.discharge_date|date:"H:i" }} Hours</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clinical Block -->
            <div class="space-y-8 mb-10">
                <!-- Provisional & Final Diagnosis -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="border border-slate-200 px-6 py-5">
                        <h6 class="text-[10px] font-black text-slate-400 font-bold uppercase tracking-widest mb-2 flex items-center gap-2">
                            Provisional Diagnosis
                        </h6>
                        <p class="text-sm font-bold text-slate-600 leading-tight">{{ discharge.provisional_diagnosis|default:"N/A" }}</p>
                    </div>
                    <div class="border-2 border-slate-900 px-6 py-5">
                        <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <i class="fas fa-stethoscope"></i> Final Clinical Diagnosis
                        </h6>
                        <p class="text-base font-black text-slate-900 leading-tight">{{ discharge.final_diagnosis }}</p>
                    </div>
                </div>

                <!-- Procedures & Problems -->
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1">Other Problems Noted</h6>
                        <div class="text-sm font-medium text-slate-800 leading-relaxed whitespace-pre-wrap">{{ discharge.other_problems|default:"None noted." }}</div>
                    </div>
                    <div>
                        <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1">Operations/Procedures done</h6>
                        <div class="text-sm font-medium text-slate-800 leading-relaxed whitespace-pre-wrap">{{ discharge.operations_procedures|default:"None recorded." }}</div>
                    </div>
                </div>

                <!-- Presenting Complaints -->
                <div>
                    <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1">Presenting Complaints</h6>
                    <div class="text-sm font-medium text-slate-800 leading-relaxed whitespace-pre-wrap">{{ discharge.presenting_complaints|default:"N/A" }}</div>
                </div>

                <!-- Summary -->
                <div>
                    <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1">Clinical Course & Treatment Summary</h6>
                    <div class="text-sm font-medium text-slate-800 leading-relaxed whitespace-pre-wrap">{{ discharge.clinical_management_summary }}</div>
                </div>

                <!-- Diagnostics Section -->
                <div class="grid grid-cols-2 gap-8 pt-4">
                    <div>
                        <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1 flex items-center justify-between">
                            Laboratory Investigations
                            <span class="text-[9px] font-bold text-slate-400">{{ lab_results.count }}</span>
                        </h6>
                        <div class="space-y-3">
                            {% for lab in lab_results %}
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-900 uppercase">{{ lab.service.name }}</div>
                                    <div class="text-xs text-slate-600 mt-1 line-clamp-2">{{ lab.results }}</div>
                                </div>
                            {% empty %}
                                <p class="text-[10px] italic text-slate-400">No laboratory results recorded.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div>
                        <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1 flex items-center justify-between">
                            Radiology/Imaging
                            <span class="text-[9px] font-bold text-slate-400">{{ radiology_results.count }}</span>
                        </h6>
                        <div class="space-y-3">
                            {% for rad in radiology_results %}
                                <div class="bg-indigo-50/30 p-3 rounded-lg border border-indigo-100/50">
                                    <div class="text-[10px] font-bold text-indigo-900 uppercase">{{ rad.service.name }}</div>
                                    <div class="text-xs text-indigo-700 mt-1 line-clamp-2">{{ rad.interpretation }}</div>
                                </div>
                            {% empty %}
                                <p class="text-[10px] italic text-slate-400">No imaging results recorded.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Discharge Medications (Prescriptions) -->
                <div class="pt-4">
                    <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1">Discharge Medications (Take-home)</h6>
                    <div class="space-y-4">
                        {% for prescription in prescriptions %}
                            {% for item in prescription.items.all %}
                                <div class="flex justify-between items-start pb-2 border-b border-slate-100 last:border-0">
                                    <div>
                                        <div class="text-sm font-black text-slate-900">{{ item.medication.name }}</div>
                                        <div class="text-[10px] font-bold text-slate-500 uppercase">{{ item.dose_count }} x {{ item.frequency }} for {{ item.number_of_days }} days</div>
                                    </div>
                                    {% if item.instructions %}
                                        <div class="text-[10px] text-slate-400 italic max-w-xs text-right">{{ item.instructions }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% empty %}
                            <p class="text-[10px] italic text-slate-400">No take-home medications recorded.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Care Plan -->
                <div>
                    <h6 class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-3 border-b border-slate-900 pb-1">Care Plan & Instructions</h6>
                    <div class="text-sm font-medium text-slate-800 leading-relaxed whitespace-pre-wrap">{{ discharge.discharge_care_plan|default:"Standard follow-up instructions provided." }}</div>
                </div>
            </div>

            <!-- Verification -->
            <div class="pt-10 border-t border-slate-900 mt-12 grid grid-cols-2 items-end">
                <div class="text-left">
                    <div class="text-[8px] text-slate-400 uppercase tracking-widest mb-8">Official Stamp / Date</div>
                    <div class="w-32 h-16 border border-slate-200 border-dashed"></div>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">Authorized Signature</p>
                    <div class="space-y-1">
                        <div class="text-lg font-black text-slate-900 leading-none">
                            DR. {{ discharge.discharged_by.last_name|upper|default:discharge.discharged_by.username|upper }}
                        </div>
                        <div class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Medical Officer</div>
                    </div>
                    <div class="mt-6 text-[8px] text-slate-400 uppercase tracking-tight">
                        Internal Ref: DIS-{{ discharge.id }} | Generated: {% now "d M Y H:i" %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    @media print {
        @page {
            margin: 1cm;
            size: A4;
        }
        body {
            background: white !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        /* Hide all dashboard layout elements */
        .sidebar, 
        .top-bar, 
        .no-print,
        .messages {
            display: none !important;
        }
        /* Reset main content container for full page print */
        .main-content {
            margin-left: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            padding: 0 !important;
        }
        main {
            padding: 0 !important;
            margin: 0 !important;
        }
    }
    </style>
{% endblock %}
