{% extends 'users/dashboard_base.html' %}
{% load static %}

{% block title %}Stock Registration - HMS{% endblock %}

{% block content %}
<div class="bg-[#f8fafc] min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto space-y-8 animate-fade-in">

        <!-- Header -->
        <div
            class="flex flex-col md:flex-row md:items-center justify-between gap-6 bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100">
            <div class="flex items-center gap-6">
                <div
                    class="w-16 h-16 rounded-2xl bg-slate-900 flex items-center justify-center text-white shadow-xl shadow-slate-200">
                    <i class="fas fa-boxes-stacked text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Register Stock</h1>
                    <p class="text-slate-500 font-bold text-xs uppercase tracking-widest mt-1">Universal Inventory Entry
                    </p>
                </div>
            </div>
            <a href="{% url 'inventory:item_list' %}"
                class="px-6 py-3 bg-slate-50 text-slate-500 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-100 transition-all border border-slate-100">
                <i class="fas fa-arrow-left mr-2"></i> Back to Directory
            </a>
        </div>

        <!-- Progress Steps (Horizontal) -->
        <div
            class="flex items-center justify-between px-4 py-6 bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-x-auto">
            <div class="flex items-center gap-4 flex-nowrap shrink-0">
                <div id="step-1-indicator"
                    class="w-10 h-10 rounded-xl bg-slate-900 border-4 border-slate-900 flex items-center justify-center text-white text-xs font-black shadow-lg">
                    01</div>
                <div class="hidden sm:block">
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-900">Step 1</p>
                    <p class="text-[9px] font-bold text-slate-400">Identification</p>
                </div>
            </div>
            <div class="h-px bg-slate-100 flex-1 mx-4 min-w-[20px]"></div>
            <div class="flex items-center gap-4 flex-nowrap shrink-0">
                <div id="step-2-indicator"
                    class="w-10 h-10 rounded-xl bg-slate-50 border-4 border-white flex items-center justify-center text-slate-300 text-xs font-black">
                    02</div>
                <div class="hidden sm:block">
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-300">Step 2</p>
                    <p class="text-[9px] font-bold text-slate-300">Logic & Units</p>
                </div>
            </div>
            <div class="h-px bg-slate-100 flex-1 mx-4 min-w-[20px]"></div>
            <div class="flex items-center gap-4 flex-nowrap shrink-0">
                <div id="step-3-indicator"
                    class="w-10 h-10 rounded-xl bg-slate-50 border-4 border-white flex items-center justify-center text-slate-300 text-xs font-black">
                    03</div>
                <div class="hidden sm:block">
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-300">Step 3</p>
                    <p id="step-3-label" class="text-[9px] font-bold text-slate-300">Specifications</p>
                </div>
            </div>
        </div>

        <form method="post" autocomplete="off" id="inventoryForm" class="space-y-8 pb-20">
            {% csrf_token %}

            <!-- Core Information -->
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden group">
                <div class="p-8 md:p-12 space-y-10">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-2 h-2 rounded-full bg-slate-900"></div>
                        <h2 class="text-xs font-black uppercase tracking-[0.3em] text-slate-900">Core Identification
                        </h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="md:col-span-2 space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Official
                                Name</label>
                            <div class="relative group/input">
                                <div
                                    class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-slate-900 transition-colors z-10">
                                    <i class="fas fa-tag"></i>
                                </div>
                                {{ form.name }}
                            </div>
                            {{ form.name.errors }}
                        </div>

                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Category</label>
                            <div class="relative group/input">
                                <div
                                    class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-slate-900 transition-colors z-10">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                {{ form.category }}
                            </div>
                            {{ form.category.errors }}
                        </div>

                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">System
                                Type</label>
                            <div class="relative group/input">
                                <div
                                    class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/input:text-slate-900 transition-colors z-10">
                                    <i class="fas fa-shapes"></i>
                                </div>
                                {{ form.item_type }}
                            </div>
                            {{ form.item_type.errors }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dispensing Logic -->
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-8 md:p-12 space-y-10">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                        <h2 class="text-xs font-black uppercase tracking-[0.3em] text-slate-900">Dispensing & Logic</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Dispensing
                                Unit</label>
                            {{ form.dispensing_unit }}
                        </div>
                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Packaging
                                Unit</label>
                            {{ form.packaging_unit }}
                        </div>
                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Units
                                Per Pack</label>
                            {{ form.units_per_pack }}
                        </div>
                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Buying
                                Price (Optional)</label>
                            {{ form.buying_price }}
                        </div>
                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Selling
                                Price</label>
                            {{ form.selling_price }}
                        </div>
                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Reorder
                                Level</label>
                            {{ form.reorder_level }}
                        </div>
                        <div class="flex items-center pt-8 pl-4">
                            <label class="flex items-center gap-4 cursor-pointer group">
                                <div class="relative flex items-center">
                                    {{ form.is_dispensed_as_whole }}
                                    <div
                                        class="toggle-bg w-12 h-7 bg-slate-200 rounded-full transition-all peer-checked:bg-emerald-600">
                                    </div>
                                    <div
                                        class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow-sm">
                                    </div>
                                </div>
                                <span
                                    class="text-[10px] font-black text-slate-500 uppercase tracking-widest group-hover:text-slate-900 transition-colors">Sell
                                    as Whole Pack</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medication Section -->
            <div id="med-section"
                class="bg-indigo-600 rounded-[2.5rem] shadow-xl shadow-indigo-100 p-8 md:p-12 space-y-10 hidden transform transition-all duration-300">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-2xl bg-white/10 flex items-center justify-center text-white">
                            <i class="fas fa-notes-medical text-lg"></i>
                        </div>
                        <h2 class="text-xl font-black text-white tracking-tight">Clinical Details</h2>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="space-y-3">
                        <label
                            class="block text-[10px] font-black text-indigo-200 uppercase tracking-widest ml-2">Generic
                            Name</label>
                        {{ med_form.generic_name }}
                    </div>
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black text-indigo-200 uppercase tracking-widest ml-2">Drug
                            Class</label>
                        {{ med_form.drug_class }}
                    </div>
                    <div class="space-y-3">
                        <label
                            class="block text-[10px] font-black text-indigo-200 uppercase tracking-widest ml-2">Formulation</label>
                        {{ med_form.formulation }}
                    </div>
                    <div class="space-y-3">
                        <label
                            class="block text-[10px] font-black text-indigo-200 uppercase tracking-widest ml-2">Strength</label>
                        {{ med_form.strength }}
                    </div>
                    <div class="flex items-center pt-4 pl-2">
                        <label class="flex items-center gap-4 cursor-pointer group">
                            <div class="relative flex items-center">
                                {{ med_form.is_controlled }}
                                <div
                                    class="toggle-bg w-12 h-7 bg-white/10 rounded-full transition-all peer-checked:bg-rose-500">
                                </div>
                                <div
                                    class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow-sm">
                                </div>
                            </div>
                            <span
                                class="text-[10px] font-black text-white/80 uppercase tracking-widest group-hover:text-white transition-colors">Controlled
                                Substance</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Consumable Section -->
            <div id="con-section"
                class="bg-slate-900 rounded-[2.5rem] shadow-xl p-8 md:p-12 space-y-10 hidden transform transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-2xl bg-amber-500 flex items-center justify-center text-white">
                        <i class="fas fa-microscope text-lg"></i>
                    </div>
                    <h2 class="text-xl font-black text-white tracking-tight">Technical Specs</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="space-y-3">
                        <label
                            class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Material</label>
                        {{ con_form.material }}
                    </div>
                    <div class="space-y-3">
                        <label
                            class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Size/Dim</label>
                        {{ con_form.size }}
                    </div>
                    <div class="flex items-center pt-8 pl-4">
                        <label class="flex items-center gap-4 cursor-pointer group">
                            <div class="relative flex items-center">
                                {{ con_form.is_sterile }}
                                <div
                                    class="toggle-bg w-12 h-7 bg-slate-700 rounded-full transition-all peer-checked:bg-amber-500">
                                </div>
                                <div
                                    class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-5 shadow-sm">
                                </div>
                            </div>
                            <span
                                class="text-[10px] font-black text-slate-400 uppercase tracking-widest group-hover:text-white transition-colors">Is
                                Sterile</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div
                class="sticky bottom-8 bg-white/95 backdrop-blur-xl rounded-[2rem] p-4 shadow-2xl border border-white/50 z-30 flex flex-col sm:flex-row gap-4">
                <button type="submit"
                    class="flex-[3] bg-slate-900 text-white px-10 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] hover:bg-slate-800 transition-all active:scale-[0.98] shadow-xl flex items-center justify-center gap-4">
                    Register Into Store <i class="fas fa-circle-check"></i>
                </button>
                <a href="{% url 'inventory:item_list' %}"
                    class="flex-1 bg-slate-50 text-slate-400 px-10 py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] text-center border border-slate-100 hover:text-rose-600 hover:bg-rose-50 transition-all">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<style>
    /* Clean, Professional Input Styles */
    input[type="text"],
    input[type="number"],
    select,
    textarea {
        width: 100% !important;
        background: #ffffff !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 1.25rem !important;
        padding: 1.15rem 1.5rem !important;
        font-size: 0.9rem !important;
        font-weight: 700 !important;
        color: #1e293b !important;
        transition: all 0.3s ease !important;
        outline: none !important;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
    }

    input:hover,
    select:hover,
    textarea:hover {
        border-color: #cbd5e1 !important;
    }

    /* Override padding for icons on top section */
    .relative input[type="text"] {
        padding-left: 3.5rem !important;
    }

    input:focus,
    select:focus {
        background: white !important;
        border-color: #64748b !important;
        box-shadow: 0 0 0 4px rgba(100, 116, 139, 0.05) !important;
    }

    /* Medicine Form Theme */
    #med-section input,
    #med-section select {
        background: rgba(255, 255, 255, 0.07) !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        color: white !important;
    }

    #med-section select option {
        background-color: #4f46e5 !important;
        /* indigo-600 */
        color: white !important;
    }

    #med-section input:focus,
    #med-section select:focus {
        background: rgba(255, 255, 255, 0.1) !important;
        border-color: white !important;
    }

    /* Consumable Form Theme */
    #con-section input,
    #con-section select {
        background: #111827 !important;
        border: 2px solid #374151 !important;
        color: white !important;
    }

    #con-section select option {
        background-color: #111827 !important;
        color: white !important;
    }

    /* Toggle Switch Logic (Manual Fallback) */
    .peer:checked~.toggle-bg {
        background-color: #10b981 !important;
        /* emerald-600 */
    }

    .peer:checked~.toggle-dot {
        transform: translateX(1.25rem) !important;
    }

    input[type="checkbox"] {
        position: absolute !important;
        opacity: 0 !important;
        width: 100% !important;
        height: 100% !important;
        cursor: pointer !important;
        z-index: 20 !important;
        margin: 0 !important;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    .hidden {
        display: none;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const typeSelect = document.getElementById('{{ form.item_type.id_for_label }}');
        const medSec = document.getElementById('med-section');
        const conSec = document.getElementById('con-section');

        const indicators = [
            document.getElementById('step-1-indicator'),
            document.getElementById('step-2-indicator'),
            document.getElementById('step-3-indicator')
        ];

        const labels = [
            null, null, document.getElementById('step-3-label')
        ];

        function updateFlow() {
            const val = typeSelect.value;

            // Activate Step 2
            indicators[1].classList.replace('bg-slate-50', 'bg-emerald-500');
            indicators[1].classList.replace('text-slate-300', 'text-white');

            medSec.classList.add('hidden');
            conSec.classList.add('hidden');

            // Reset Step 3
            indicators[2].className = 'w-10 h-10 rounded-xl bg-slate-50 border-4 border-white flex items-center justify-center text-slate-300 text-xs font-black';
            labels[2].innerText = 'Specifications';
            labels[2].className = 'text-[9px] font-bold text-slate-300';

            if (val === 'Medicine') {
                medSec.classList.remove('hidden');
                indicators[2].classList.replace('bg-slate-50', 'bg-indigo-600');
                indicators[2].classList.replace('text-slate-300', 'text-white');
                labels[2].innerText = 'Clinical Data';
                labels[2].classList.replace('text-slate-300', 'text-indigo-600');
            } else if (val === 'Consumable') {
                conSec.classList.remove('hidden');
                indicators[2].classList.replace('bg-slate-50', 'bg-amber-500');
                indicators[2].classList.replace('text-slate-300', 'text-white');
                labels[2].innerText = 'Technical Specs';
                labels[2].classList.replace('text-slate-300', 'text-amber-500');
            }
        }

        typeSelect.addEventListener('change', updateFlow);
        updateFlow();

        // Auto-calculate buying price logic
        const buyingPriceInput = document.getElementById('{{ form.buying_price.id_for_label }}');
        const sellingPriceInput = document.getElementById('{{ form.selling_price.id_for_label }}');

        if (buyingPriceInput && sellingPriceInput) {
            buyingPriceInput.addEventListener('input', function () {
                const buyingPrice = parseFloat(this.value);

                if (!isNaN(buyingPrice) && buyingPrice > 0) {
                    // Calculate 125% (25% profit)
                    const sellingPrice = buyingPrice * 1.25;
                    sellingPriceInput.value = sellingPrice.toFixed(2);
                    // Optional: Make it read-only or visually indicate it's calculated
                    // sellingPriceInput.readOnly = true; 
                } else {
                    // specific requirement: if 0 or empty, allow user to choose
                    // sellingPriceInput.value = ''; 
                    // sellingPriceInput.readOnly = false;
                }
            });
        }
    });
</script>
{% endblock %}