<div class="bg-indigo-50/30 border border-indigo-100 rounded-[32px] p-8 mb-6">
    <h5 class="text-xs font-black text-indigo-900 uppercase tracking-widest mb-6 flex items-center gap-2">
        <i class="fas fa-syringe"></i> Dispense Consumables / Items
    </h5>

    <form id="dispenseForm" class="space-y-6" onsubmit="handleDispense(event)">
        <!-- Hidden Context Fields -->
        {% if patient %}
        <input type="hidden" name="patient_id" value="{{ patient.id }}">
        {% elif admission %}
        <input type="hidden" name="patient_id" value="{{ admission.patient.id }}">
        {% endif %}

        {% if visit %}
        <input type="hidden" name="visit_id" value="{{ visit.id }}">
        {% elif admission %}
        <input type="hidden" name="visit_id" value="{{ admission.visit.id|default:'' }}">
        {% endif %}

        <!-- Search -->
        <div class="relative">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Search
                Item</label>
            <input type="text" id="itemSearch"
                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                placeholder="Type to search (e.g. Syringe, Gloves)..." oninput="debouncedSearch(this.value)"
                autocomplete="off">
            <input type="hidden" name="item_id" id="selectedItemId">

            <!-- Dropdown Results -->
            <div id="searchResults"
                class="absolute w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 z-50 hidden max-h-60 overflow-y-auto">
            </div>
        </div>

        <!-- Selected Item Details -->
        <div id="selectedItemDetails"
            class="hidden bg-white border border-slate-100 rounded-xl p-4 flex justify-between items-center animate-fade-in">
            <div>
                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Selected</div>
                <div class="font-black text-slate-800" id="selectedItemName">--</div>
            </div>
            <div class="flex items-center gap-4">
                <div>
                    <label
                        class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Quantity</label>
                    <input type="number" name="quantity" value="1" min="1"
                        class="w-20 px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold text-center">
                </div>
                <button type="button" onclick="clearSelection()"
                    class="text-slate-400 hover:text-rose-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <button type="submit" id="dispenseBtn" disabled
            class="w-full py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-100 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none transition-all">
            Dispense to Patient
        </button>
    </form>
</div>

<!-- History of Dispensed Items -->
<div class="space-y-4">
    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Dispensed History (This Visit)</h5>
    <div id="dispensedHistoryList" class="space-y-3">
        {% for dispensed in dispensed_items %}
        <div
            class="bg-white border border-slate-100 p-4 rounded-xl flex justify-between items-center hover:border-indigo-100 transition-colors">
            <div>
                <div class="text-sm font-bold text-slate-800">{{ dispensed.item.name }}</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase">{{ dispensed.dispensed_at|date:"d M H:i" }}
                    â€¢ By {{ dispensed.dispensed_by.first_name }}</div>
            </div>
            <div class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-black rounded-lg">
                x{{ dispensed.quantity }}
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8 opacity-50">
            <p class="text-xs font-bold text-slate-400 uppercase">No items dispensed yet</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    let searchTimeout;

    function debouncedSearch(query) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (query.length < 2) {
                document.getElementById('searchResults').classList.add('hidden');
                return;
            }
            fetch(`{% url 'inventory:search_inventory' %}?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => showResults(data.results));
        }, 300);
    }

    function showResults(items) {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';
        if (items.length === 0) {
            container.classList.add('hidden');
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-slate-50 last:border-0 transition-colors';
            div.innerHTML = `
                <div class="text-sm font-bold text-slate-800">${item.text}</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase">${item.category}</div>
            `;
            div.onclick = () => selectItem(item);
            container.appendChild(div);
        });
        container.classList.remove('hidden');
    }

    function selectItem(item) {
        document.getElementById('selectedItemId').value = item.id;
        document.getElementById('selectedItemName').innerText = item.text;
        document.getElementById('itemSearch').value = '';
        document.getElementById('searchResults').classList.add('hidden');

        document.getElementById('selectedItemDetails').classList.remove('hidden');
        document.getElementById('dispenseBtn').disabled = false;
    }

    function clearSelection() {
        document.getElementById('selectedItemId').value = '';
        document.getElementById('selectedItemDetails').classList.add('hidden');
        document.getElementById('dispenseBtn').disabled = true;
    }

    function handleDispense(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const btn = document.getElementById('dispenseBtn');

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        btn.disabled = true;
        const orgText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';

        fetch(`{% url 'inventory:dispense_item' %}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    // Ideally refresh just the list, but full reload is safer for now to update stock too
                    window.location.reload();
                } else {
                    alert(data.message);
                    btn.disabled = false;
                    btn.innerHTML = orgText;
                }
            })
            .catch(err => {
                console.error(err);
                alert('An error occurred');
                btn.disabled = false;
                btn.innerHTML = orgText;
            });
    }

    // Close search results on click outside
    document.addEventListener('click', function (e) {
        const searchContainer = document.getElementById('itemSearch')?.parentElement;
        if (searchContainer && !searchContainer.contains(e.target)) {
            document.getElementById('searchResults').classList.add('hidden');
        }
    });
</script>